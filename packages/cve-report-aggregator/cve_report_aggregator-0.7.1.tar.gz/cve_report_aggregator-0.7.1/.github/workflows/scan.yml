---
name: Semgrep Code Security Scan
permissions:
  contents: read

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'
  schedule:
    - cron: '0 6 * * 1'

jobs:
  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    if: (github.actor != 'dependabot[bot]')
    steps:
      - uses: actions/checkout@v5

      - name: Run Semgrep scan
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          # Determine whether to use Semgrep Cloud or local rules
          if [[ -n "$SEMGREP_APP_TOKEN" ]]; then
            echo "Running Semgrep with Cloud configuration"
            # When using Semgrep Cloud, don't specify --config
            semgrep ci --sarif --output semgrep.sarif || {
              echo "Semgrep scan failed, creating empty SARIF"
              # Create minimal valid SARIF if scan fails
              echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[]}' > semgrep.sarif
            }
          else
            echo "Running Semgrep with local rules (--config auto)"
            # When not using Semgrep Cloud, specify local rules
            semgrep ci --sarif --config auto --output semgrep.sarif || {
              echo "Semgrep scan failed, creating empty SARIF"
              echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[]}' > semgrep.sarif
            }
          fi

          # Verify SARIF file exists and is valid JSON
          if [[ ! -s semgrep.sarif ]]; then
            echo "SARIF file is empty, creating minimal valid SARIF"
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[]}' > semgrep.sarif
          elif ! jq empty semgrep.sarif 2>/dev/null; then
            echo "SARIF file is invalid JSON, creating minimal valid SARIF"
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[]}' > semgrep.sarif
          fi

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
        if: always()
