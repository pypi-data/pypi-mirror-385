# Data Storage Configuration

## Overview

QuantMini stores data in a structured directory tree. You can configure the data location using environment variables or configuration files to match your setup.

## Folder Structure (Medallion Architecture)

```
$DATA_ROOT/
├── landing/                # Landing Layer (raw source data)
│   ├── polygon-s3/        # S3 flat files organized by source
│   │   ├── stocks_daily/  # 5-year access (2020-10-18 to present)
│   │   ├── stocks_minute/ # 5-year access
│   │   ├── options_daily/ # 2-year access (2023-10-18 to present)
│   │   └── options_minute/# 2-year access
│   ├── polygon-api/       # REST API data
│   └── external/          # External sources
│
├── bronze/                # Bronze Layer (validated Parquet)
│   ├── stocks_daily/
│   ├── stocks_minute/
│   ├── options_daily/
│   └── options_minute/
│
├── silver/                # Silver Layer (feature-enriched data)
│   ├── stocks_daily/
│   ├── stocks_minute/
│   ├── options_daily/
│   └── options_minute/
│
├── gold/                  # Gold Layer (ML-ready data)
│   └── qlib/             # Qlib binary format
│       ├── stocks_daily/
│       ├── stocks_minute/
│       └── options/
│
├── metadata/             # Watermarks and processing state
│   ├── stocks/
│   └── options/
│
└── cache/                # Query cache
```

**Medallion Architecture Layers:**
- **Landing**: Raw CSV.GZ files from source systems (time-series organized)
- **Bronze**: Validated Parquet with schema enforcement
- **Silver**: Enriched with calculated features and technical indicators
- **Gold**: ML-ready binary format optimized for backtesting

## Configuration Methods

QuantMini uses a layered configuration system with the following priority (highest to lowest):

1. **Environment Variable** (`DATA_ROOT`)
2. **System Profile** (`config/system_profile.yaml`) - **gitignored, for personal paths**
3. **Pipeline Config** (`config/pipeline_config.yaml`) - **committed, for defaults**

### Method 1: System Profile (Recommended for Personal Setup)

Edit `config/system_profile.yaml` (gitignored - safe for personal paths):

```bash
# Copy the example if it doesn't exist
cp config/system_profile.yaml.example config/system_profile.yaml

# Edit system_profile.yaml
data_root: /Volumes/ExternalSSD/quantmini-data/data
```

**Pros**:
- Your personal path never gets committed to git
- Persists across terminal sessions
- Can be automatically generated by system profiler

### Method 2: Environment Variable

Set the `DATA_ROOT` environment variable:

```bash
# In your shell or .bashrc/.zshrc
export DATA_ROOT="/path/to/your/data"

# Or inline when running commands
DATA_ROOT="/mnt/storage/quantmini" uv run quantmini pipeline run ...
```

**Pros**:
- Easy to override temporarily
- Good for CI/CD and scripts

### Method 3: .env File

Create a `.env` file in the project root:

```bash
# Copy the example
cp .env.example .env

# Edit .env
DATA_ROOT=./data  # or any path you prefer
```

**Pros**:
- Automatically loaded in development
- Gitignored by default

### Method 4: Pipeline Config (Default for All Users)

Edit `config/pipeline_config.yaml` (this file IS committed to git):

```yaml
# Default configuration (relative path) - committed to repo
data_root: data
```

**Use this for**:
- Setting project-wide defaults
- Relative paths that work for all users

**Configuration Priority**:
```
Environment Variable (DATA_ROOT)
    ↓ (if not set)
System Profile (config/system_profile.yaml)
    ↓ (if not set or file doesn't exist)
Pipeline Config (config/pipeline_config.yaml)
    ↓ (if not set)
Default (./data)
```

## Common Setups

### Local Development (Default)

Store data in the project directory:

```bash
DATA_ROOT=./data
```

**Pros**: Simple, no extra configuration
**Cons**: Limited by your system drive capacity

### External SSD/Hard Drive

Store data on a fast external drive:

```bash
# macOS
DATA_ROOT=/Volumes/ExternalSSD/quantmini-data/data

# Linux
DATA_ROOT=/mnt/storage/quantmini-data/data

# Windows (WSL)
DATA_ROOT=/mnt/d/quantmini-data/data
```

**Pros**: More storage capacity, doesn't fill system drive
**Cons**: Must mount drive before running pipeline

### Network Storage

Store data on NAS or cloud storage:

```bash
# NFS mount
DATA_ROOT=/mnt/nas/quantmini/data

# Cloud (mounted via rclone, etc.)
DATA_ROOT=/mnt/s3/quantmini-data/data
```

**Pros**: Accessible from multiple machines, backup built-in
**Cons**: Network latency may impact performance

## Verifying Configuration

Check your data root:

```bash
# Using Python
uv run python -c "from src.core import ConfigLoader; print(ConfigLoader().get_data_root())"

# Check if data exists
ls -la $DATA_ROOT
```

## Examples

All example scripts use the `DATA_ROOT` environment variable:

```python
import os
from pathlib import Path

# Automatic - uses DATA_ROOT or defaults to ./data
DATA_ROOT = os.getenv('DATA_ROOT', './data')
qlib_path = Path(DATA_ROOT) / 'qlib' / 'stocks_daily'
```

## Storage Requirements

Approximate sizes for reference (per layer):

**Bronze Layer (Validated Parquet):**
- stocks_daily (2 years): ~500 MB
- stocks_minute (2 years): ~150 GB
- options_daily (2 years): ~2 GB
- options_minute (1 month): ~50 GB

**Silver Layer (Feature-enriched Parquet):**
- Similar to bronze + ~20% for feature columns

**Gold Layer (Qlib Binary):**
- stocks_daily (2 years): ~200 MB
- stocks_minute (2 years): ~60 GB

**Landing Layer (Raw CSV.GZ):**
- Temporary storage, typically cleaned after ingestion

**Total Recommendation**: Start with **500 GB** for production use (includes all layers + overhead).

## Migration Guide

Moving data to a new location:

```bash
# 1. Copy data
cp -r ./data /new/location/

# 2. Update environment variable
export DATA_ROOT=/new/location/data

# 3. Verify
uv run python -c "from src.core import ConfigLoader; print(ConfigLoader().get_data_root())"

# 4. Test with a simple query
uv run quantmini data query --data-type stocks_daily --date 2025-01-02
```

## Troubleshooting

### Pipeline can't find data

**Symptom**: `FileNotFoundError` or "No data found"

**Solution**:
1. Check `DATA_ROOT` is set: `echo $DATA_ROOT`
2. Verify data exists: `ls $DATA_ROOT/bronze` or `ls $DATA_ROOT/silver`
3. Check permissions: Ensure read/write access

### Examples fail to initialize Qlib

**Symptom**: `qlib.init()` fails with "Provider not found"

**Solution**:
1. Ensure Qlib data is converted: `ls $DATA_ROOT/gold/qlib/stocks_daily`
2. Run conversion if needed: `uv run quantmini pipeline run --data-type stocks_daily --start-date 2024-01-01 --end-date 2024-12-31`
3. Update example scripts to use correct `DATA_ROOT`

### Different paths for different components

If you need to separate storage locations:

```bash
# Set specific paths (advanced)
export PARQUET_ROOT=/fast/ssd/parquet
export QLIB_ROOT=/slower/hdd/qlib
```

Then modify `config/pipeline_config.yaml` to read these variables.

## Best Practices

1. **Use environment variables** for flexibility across environments
2. **Document your setup** in team wikis or project README
3. **Backup regularly** - data regeneration can take hours/days
4. **Monitor disk space** - set up alerts at 80% capacity
5. **Use fast storage** for parquet (SSDs recommended)
6. **Gitignore data directories** - never commit large data files

## Security Note

⚠️ **Never commit paths with sensitive information to version control**

- Use `.env` (gitignored) for local paths
- Use environment variables in CI/CD
- Document generic examples in docs (like `./data` or `/path/to/data`)
