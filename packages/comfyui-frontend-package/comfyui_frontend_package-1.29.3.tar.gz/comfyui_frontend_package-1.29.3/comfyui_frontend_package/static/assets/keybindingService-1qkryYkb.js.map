{"version":3,"file":"keybindingService-1qkryYkb.js","sources":["../../src/constants/coreKeybindings.ts","../../src/services/keybindingService.ts"],"sourcesContent":["import type { Keybinding } from '@/schemas/keyBindingSchema'\n\nexport const CORE_KEYBINDINGS: Keybinding[] = [\n  {\n    combo: {\n      ctrl: true,\n      key: 'Enter'\n    },\n    commandId: 'Comfy.QueuePrompt'\n  },\n  {\n    combo: {\n      ctrl: true,\n      shift: true,\n      key: 'Enter'\n    },\n    commandId: 'Comfy.QueuePromptFront'\n  },\n  {\n    combo: {\n      ctrl: true,\n      alt: true,\n      key: 'Enter'\n    },\n    commandId: 'Comfy.Interrupt'\n  },\n  {\n    combo: {\n      key: 'r'\n    },\n    commandId: 'Comfy.RefreshNodeDefinitions'\n  },\n  {\n    combo: {\n      key: 'q'\n    },\n    commandId: 'Workspace.ToggleSidebarTab.queue'\n  },\n  {\n    combo: {\n      key: 'w'\n    },\n    commandId: 'Workspace.ToggleSidebarTab.workflows'\n  },\n  {\n    combo: {\n      key: 'n'\n    },\n    commandId: 'Workspace.ToggleSidebarTab.node-library'\n  },\n  {\n    combo: {\n      key: 'm'\n    },\n    commandId: 'Workspace.ToggleSidebarTab.model-library'\n  },\n  {\n    combo: {\n      key: 's',\n      ctrl: true\n    },\n    commandId: 'Comfy.SaveWorkflow'\n  },\n  {\n    combo: {\n      key: 'o',\n      ctrl: true\n    },\n    commandId: 'Comfy.OpenWorkflow'\n  },\n  {\n    combo: {\n      key: 'g',\n      ctrl: true\n    },\n    commandId: 'Comfy.Graph.GroupSelectedNodes'\n  },\n  {\n    combo: {\n      key: ',',\n      ctrl: true\n    },\n    commandId: 'Comfy.ShowSettingsDialog'\n  },\n  // For '=' both holding shift and not holding shift\n  {\n    combo: {\n      key: '=',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ZoomIn',\n    targetElementId: 'graph-canvas'\n  },\n  {\n    combo: {\n      key: '+',\n      alt: true,\n      shift: true\n    },\n    commandId: 'Comfy.Canvas.ZoomIn',\n    targetElementId: 'graph-canvas'\n  },\n  // For number pad '+'\n  {\n    combo: {\n      key: '+',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ZoomIn',\n    targetElementId: 'graph-canvas'\n  },\n  {\n    combo: {\n      key: '-',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ZoomOut',\n    targetElementId: 'graph-canvas'\n  },\n  {\n    combo: {\n      key: '.'\n    },\n    commandId: 'Comfy.Canvas.FitView',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: 'p'\n    },\n    commandId: 'Comfy.Canvas.ToggleSelected.Pin',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: 'c',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ToggleSelectedNodes.Collapse',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: 'b',\n      ctrl: true\n    },\n    commandId: 'Comfy.Canvas.ToggleSelectedNodes.Bypass',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: 'm',\n      ctrl: true\n    },\n    commandId: 'Comfy.Canvas.ToggleSelectedNodes.Mute',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: '`',\n      ctrl: true\n    },\n    commandId: 'Workspace.ToggleBottomPanelTab.logs-terminal'\n  },\n  {\n    combo: {\n      key: 'e',\n      ctrl: true,\n      shift: true\n    },\n    commandId: 'Comfy.Graph.ConvertToSubgraph'\n  },\n  {\n    combo: {\n      key: 'm',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ToggleMinimap'\n  },\n  {\n    combo: {\n      ctrl: true,\n      shift: true,\n      key: 'k'\n    },\n    commandId: 'Workspace.ToggleBottomPanel.Shortcuts'\n  },\n  {\n    combo: {\n      key: 'v'\n    },\n    commandId: 'Comfy.Canvas.Unlock'\n  },\n  {\n    combo: {\n      key: 'h'\n    },\n    commandId: 'Comfy.Canvas.Lock'\n  },\n  {\n    combo: {\n      key: 'Escape'\n    },\n    commandId: 'Comfy.Graph.ExitSubgraph'\n  }\n]\n","import { CORE_KEYBINDINGS } from '@/constants/coreKeybindings'\nimport { useSettingStore } from '@/platform/settings/settingStore'\nimport { app } from '@/scripts/app'\nimport { useCommandStore } from '@/stores/commandStore'\nimport { useDialogStore } from '@/stores/dialogStore'\nimport {\n  KeyComboImpl,\n  KeybindingImpl,\n  useKeybindingStore\n} from '@/stores/keybindingStore'\n\nexport const useKeybindingService = () => {\n  const keybindingStore = useKeybindingStore()\n  const commandStore = useCommandStore()\n  const settingStore = useSettingStore()\n  const dialogStore = useDialogStore()\n\n  // Helper function to determine if an event should be forwarded to canvas\n  const shouldForwardToCanvas = (event: KeyboardEvent): boolean => {\n    // Don't forward if modifier keys are pressed (except shift)\n    if (event.ctrlKey || event.altKey || event.metaKey) {\n      return false\n    }\n\n    // Keys that LiteGraph handles but aren't in core keybindings\n    const canvasKeys = ['Delete', 'Backspace']\n\n    return canvasKeys.includes(event.key)\n  }\n\n  const keybindHandler = async function (event: KeyboardEvent) {\n    const keyCombo = KeyComboImpl.fromEvent(event)\n    if (keyCombo.isModifier) {\n      return\n    }\n\n    // Ignore reserved or non-modifier keybindings if typing in input fields\n    const target = event.composedPath()[0] as HTMLElement\n    if (\n      keyCombo.isReservedByTextInput &&\n      (target.tagName === 'TEXTAREA' ||\n        target.tagName === 'INPUT' ||\n        target.contentEditable === 'true' ||\n        (target.tagName === 'SPAN' &&\n          target.classList.contains('property_value')))\n    ) {\n      return\n    }\n\n    const keybinding = keybindingStore.getKeybinding(keyCombo)\n    if (keybinding && keybinding.targetElementId !== 'graph-canvas') {\n      // Special handling for Escape key - let dialogs handle it first\n      if (\n        event.key === 'Escape' &&\n        !event.ctrlKey &&\n        !event.altKey &&\n        !event.metaKey\n      ) {\n        // If dialogs are open, don't execute the keybinding - let the dialog handle it\n        if (dialogStore.dialogStack.length > 0) {\n          return\n        }\n      }\n\n      // Prevent default browser behavior first, then execute the command\n      event.preventDefault()\n      await commandStore.execute(keybinding.commandId)\n      return\n    }\n\n    // Forward unhandled canvas-targeted events to LiteGraph\n    if (!keybinding && shouldForwardToCanvas(event)) {\n      const canvas = app.canvas\n      if (\n        canvas &&\n        canvas.processKey &&\n        typeof canvas.processKey === 'function'\n      ) {\n        // Let LiteGraph handle the event\n        canvas.processKey(event)\n        return\n      }\n    }\n\n    // Only clear dialogs if not using modifiers\n    if (event.ctrlKey || event.altKey || event.metaKey) {\n      return\n    }\n\n    // Escape key: close the first open modal found, and all dialogs\n    if (event.key === 'Escape') {\n      const modals = document.querySelectorAll<HTMLElement>('.comfy-modal')\n      for (const modal of modals) {\n        const modalDisplay = window\n          .getComputedStyle(modal)\n          .getPropertyValue('display')\n\n        if (modalDisplay !== 'none') {\n          modal.style.display = 'none'\n          break\n        }\n      }\n\n      for (const d of document.querySelectorAll('dialog')) d.close()\n    }\n  }\n\n  const registerCoreKeybindings = () => {\n    for (const keybinding of CORE_KEYBINDINGS) {\n      keybindingStore.addDefaultKeybinding(new KeybindingImpl(keybinding))\n    }\n  }\n\n  function registerUserKeybindings() {\n    // Unset bindings first as new bindings might conflict with default bindings.\n    const unsetBindings = settingStore.get('Comfy.Keybinding.UnsetBindings')\n    for (const keybinding of unsetBindings) {\n      keybindingStore.unsetKeybinding(new KeybindingImpl(keybinding))\n    }\n    const newBindings = settingStore.get('Comfy.Keybinding.NewBindings')\n    for (const keybinding of newBindings) {\n      keybindingStore.addUserKeybinding(new KeybindingImpl(keybinding))\n    }\n  }\n\n  async function persistUserKeybindings() {\n    // TODO(https://github.com/Comfy-Org/ComfyUI_frontend/issues/1079):\n    // Allow setting multiple values at once in settingStore\n    await settingStore.set(\n      'Comfy.Keybinding.NewBindings',\n      Object.values(keybindingStore.getUserKeybindings())\n    )\n    await settingStore.set(\n      'Comfy.Keybinding.UnsetBindings',\n      Object.values(keybindingStore.getUserUnsetKeybindings())\n    )\n  }\n\n  return {\n    keybindHandler,\n    registerCoreKeybindings,\n    registerUserKeybindings,\n    persistUserKeybindings\n  }\n}\n"],"names":[],"mappings":";;;AAEO,MAAM,mBAAiC;AAAA,EAC5C;AAAA,IACE,OAAO;AAAA,MACL,MAAM;AAAA,MACN,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,MAAM;AAAA,MACN,OAAO;AAAA,MACP,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,MAAM;AAAA,MACN,KAAK;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,IACR;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,IACR;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,IACR;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,IACR;AAAA,IACA,WAAW;AAAA,EACb;AAAA;AAAA,EAEA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,IACX,iBAAiB;AAAA,EACnB;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,MACL,OAAO;AAAA,IACT;AAAA,IACA,WAAW;AAAA,IACX,iBAAiB;AAAA,EACnB;AAAA;AAAA,EAEA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,IACX,iBAAiB;AAAA,EACnB;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,IACX,iBAAiB;AAAA,EACnB;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,IACX,iBAAiB;AAAA,EACnB;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,IACX,iBAAiB;AAAA,EACnB;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,IACX,iBAAiB;AAAA,EACnB;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,IACR;AAAA,IACA,WAAW;AAAA,IACX,iBAAiB;AAAA,EACnB;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,IACR;AAAA,IACA,WAAW;AAAA,IACX,iBAAiB;AAAA,EACnB;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,IACR;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,MAAM;AAAA,MACN,OAAO;AAAA,IACT;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,MAAM;AAAA,MACN,OAAO;AAAA,MACP,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AAAA,EACA;AAAA,IACE,OAAO;AAAA,MACL,KAAK;AAAA,IACP;AAAA,IACA,WAAW;AAAA,EACb;AACF;AClMO,MAAM,uBAAuB,6BAAM;AACxC,QAAM,kBAAkB;AACxB,QAAM,eAAe;AACrB,QAAM,eAAe;AACrB,QAAM,cAAc;AAGd,QAAA,wBAAwB,wBAAC,UAAkC;AAE/D,QAAI,MAAM,WAAW,MAAM,UAAU,MAAM,SAAS;AAC3C,aAAA;AAAA,IACT;AAGM,UAAA,aAAa,CAAC,UAAU,WAAW;AAElC,WAAA,WAAW,SAAS,MAAM,GAAG;AAAA,EAAA,GATR;AAYxB,QAAA,iBAAiB,sCAAgB,OAAsB;AACrD,UAAA,WAAW,aAAa,UAAU,KAAK;AAC7C,QAAI,SAAS,YAAY;AACvB;AAAA,IACF;AAGA,UAAM,SAAS,MAAM,aAAa,EAAE,CAAC;AACrC,QACE,SAAS,0BACR,OAAO,YAAY,cAClB,OAAO,YAAY,WACnB,OAAO,oBAAoB,UAC1B,OAAO,YAAY,UAClB,OAAO,UAAU,SAAS,gBAAgB,IAC9C;AACA;AAAA,IACF;AAEM,UAAA,aAAa,gBAAgB,cAAc,QAAQ;AACrD,QAAA,cAAc,WAAW,oBAAoB,gBAAgB;AAG7D,UAAA,MAAM,QAAQ,YACd,CAAC,MAAM,WACP,CAAC,MAAM,UACP,CAAC,MAAM,SACP;AAEI,YAAA,YAAY,YAAY,SAAS,GAAG;AACtC;AAAA,QACF;AAAA,MACF;AAGA,YAAM,eAAe;AACf,YAAA,aAAa,QAAQ,WAAW,SAAS;AAC/C;AAAA,IACF;AAGA,QAAI,CAAC,cAAc,sBAAsB,KAAK,GAAG;AAC/C,YAAM,SAAS,IAAI;AACnB,UACE,UACA,OAAO,cACP,OAAO,OAAO,eAAe,YAC7B;AAEA,eAAO,WAAW,KAAK;AACvB;AAAA,MACF;AAAA,IACF;AAGA,QAAI,MAAM,WAAW,MAAM,UAAU,MAAM,SAAS;AAClD;AAAA,IACF;AAGI,QAAA,MAAM,QAAQ,UAAU;AACpB,YAAA,SAAS,SAAS,iBAA8B,cAAc;AACpE,iBAAW,SAAS,QAAQ;AAC1B,cAAM,eAAe,OAClB,iBAAiB,KAAK,EACtB,iBAAiB,SAAS;AAE7B,YAAI,iBAAiB,QAAQ;AAC3B,gBAAM,MAAM,UAAU;AACtB;AAAA,QACF;AAAA,MACF;AAEA,iBAAW,KAAK,SAAS,iBAAiB,QAAQ,KAAK;IACzD;AAAA,EAAA,GA1EqB;AA6EvB,QAAM,0BAA0B,6BAAM;AACpC,eAAW,cAAc,kBAAkB;AACzC,sBAAgB,qBAAqB,IAAI,eAAe,UAAU,CAAC;AAAA,IACrE;AAAA,EAAA,GAH8B;AAMhC,WAAS,0BAA0B;AAE3B,UAAA,gBAAgB,aAAa,IAAI,gCAAgC;AACvE,eAAW,cAAc,eAAe;AACtC,sBAAgB,gBAAgB,IAAI,eAAe,UAAU,CAAC;AAAA,IAChE;AACM,UAAA,cAAc,aAAa,IAAI,8BAA8B;AACnE,eAAW,cAAc,aAAa;AACpC,sBAAgB,kBAAkB,IAAI,eAAe,UAAU,CAAC;AAAA,IAClE;AAAA,EACF;AAVS;AAYT,iBAAe,yBAAyB;AAGtC,UAAM,aAAa;AAAA,MACjB;AAAA,MACA,OAAO,OAAO,gBAAgB,oBAAoB;AAAA,IAAA;AAEpD,UAAM,aAAa;AAAA,MACjB;AAAA,MACA,OAAO,OAAO,gBAAgB,yBAAyB;AAAA,IAAA;AAAA,EAE3D;AAXe;AAaR,SAAA;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAEJ,GArIoC;"}