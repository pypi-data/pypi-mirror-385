var m=6;var w=m+1,L=12,R=L+m*2;var A="--qds-node-category-uncategorized",l={DATA:"data",NN_LAYER:"nn layer",ACTIVATION:"activation",POOLING:"pooling",NORMALIZATION:"normalization",MATH:"math",SHAPE:"shape",TRANSFORM:"transform",QUANTIZATION:"quantization",SYNTHETIC_LAYER:"synthetic layer",NAMESPACE_LAYER:"namespace layer",DEFAULT:"default"},H={[l.DATA]:"--qds-node-category-data",[l.NN_LAYER]:"--qds-node-category-layer",[l.ACTIVATION]:"--qds-node-category-activation",[l.POOLING]:"--qds-node-category-pool",[l.NORMALIZATION]:"--qds-node-category-normalization",[l.MATH]:"--qds-node-category-math",[l.SHAPE]:"--qds-node-category-shape",[l.TRANSFORM]:"--qds-node-category-transform",[l.QUANTIZATION]:"--qds-node-category-quantization",[l.SYNTHETIC_LAYER]:"--qds-synthetic-layer-header-1",[l.NAMESPACE_LAYER]:"--qds-layer-header-1",[l.DEFAULT]:A},z={[l.NN_LAYER]:["conv","deconv","fc","dense","linear","lstm","gru","rnn","attention","transformer","embedding"],[l.ACTIVATION]:["relu","sigmoid","tanh","softmax","gelu","swish","elu","selu","activation"],[l.POOLING]:["pool","maxpool","avgpool"],[l.NORMALIZATION]:["norm","batchnorm","layernorm","groupnorm","instancenorm","rmsnorm","lrn"],[l.MATH]:["add","sub","mul","div","mod","pow","neg","abs","sin","cos","tan","asin","acos","atan","sinh","cosh","tanh","exp","log","sqrt","reciprocal","erf","sum","mean","max","min","reducesum","reducemean","reducemax","reducemin","reduceprod","reducel1","reducel2","reducelogsum","reducelogsumexp","reducesumsquare","equal","greater","less","greaterorequal","lessorequal","and","or","xor","not","floor","ceil","round","clip","sign","matmul","bitwiseand","bitwiseor","bitwisexor","bitwisenot","cumsum"],[l.SHAPE]:["reshape","shape","size","flatten"],[l.TRANSFORM]:["transpose","gather","slice","concat","split","cast","pad","tile","repeat","flip","squeeze","unsqueeze","expand"],[l.QUANTIZATION]:["quant","dequant","quantize","dequantize"]};function p(e){return e.children?.length>0}var g=1e3;function T({nodeMap:e,adjacencyList:t,nodes:o}){let n=S(o,e,t),r=b(n),s=G(n);return{hierarchyRoot:n,layerDescendantsMap:r,ancestorMap:s}}function S(e,t,o){let n=C(e,t);return j(n,t),$(n,o,t),O(n,0),_(n,o,t),n}function C(e,t){let o={id:"root",parent:void 0,name:"root",namespace:"root",inputs:[],outputs:[],children:[],edges:[],depth:0,isSynthetic:!1};t.root=o;for(let n of e){let r="root",s=n.namespace.split("/");for(let c=0;c<s.length;c++){let i=s.slice(0,c+1).join("/"),a=i.split("/").pop(),I=t[r];if(!t[i]){let f={id:i,parent:I,name:a,namespace:i,inputs:[],outputs:[],children:[],edges:[],depth:I.depth+1,isSynthetic:!1};t[i]=f,I.children.push(f)}r=i}n.parent=t[r],n.parent.children.push(n)}return o}function $(e,t,o){let n=[e];for(;n.length>0;){let r=n.pop();r.children.length>g&&M(r,t,o);for(let s=r.children.length-1;s>=0;s--){let c=r.children[s];p(c)&&n.push(c)}}}function M(e,t,o){let{layerAdjacencyList:n,inverseLayerAdjacencyList:r}=D(e,t,o),s,c=v(e.children,r,o);if(c.length===e.children.length)s=E(c,g);else{console.warn(`Topological sort failed to visit all nodes in layer "${e.name}", likely due to a cycle. Falling back to BFS`);let a=q(e.children,n,r,o);s=E(a,g)}let i=[];for(let a=0;a<s.length;a++){let I=`${e.namespace}/section-${a+1}`,f={id:I,parent:e,name:`Synthetic ${a+1} of ${s.length}`,namespace:I,children:s[a],inputs:[],outputs:[],edges:[],depth:e.depth+1,isSynthetic:!0};i.push(f),o[f.id]=f}e.children=i,x(e)}function v(e,t,o){let n={};e.forEach(i=>n[i.id]=0);for(let i of Object.values(t))for(let a of Object.keys(i))n[a]++;let r=[],c=e.filter(i=>n[i.id]===0).map(i=>i.id);for(;c.length>0;){let i=c.shift();r.push(o[i]);for(let a of Object.keys(t[i]||{}))n[a]--,n[a]===0&&c.push(a)}return r}function q(e,t,o,n){let r=[],s=new Set,i=e.filter(a=>!t[a.id]).map(a=>a.id);for(;i.length>0;){let a=i.shift();if(!s.has(a)){s.add(a),r.push(n[a]);for(let I of Object.keys(o[a]||{}))s.has(I)||i.push(I)}}return r}function E(e,t){let o=[];for(let n=e.length;n>0;n-=t){let r=Math.max(0,n-t);o.push(e.slice(r,n))}return o}function x(e){for(let t of e.children)t.parent=e,t.namespace=`${e.namespace}/${t.namespace.split("/").pop()}`,p(t)&&x(t)}function j(e,t){function o(n){n.children=n.children.map(r=>{if(!p(r))return r;o(r);let s=r;for(;p(s)&&s.children.length===1;){let c=s.children[0];delete t[s.id],c.parent=n,s=c}return s})}o(e)}function O(e,t){if(p(e)){e.depth=t;for(let o of e.children)O(o,t+1)}}function _(e,t,o){e.edges=Y(e,t,o);for(let n of e.children)p(n)&&_(n,t,o)}function Y(e,t,o){let{layerAdjacencyList:n}=D(e,t,o),r=[];for(let s in n)for(let c in n[s]){let i=o[s],a=o[c];r.push(P(i,a,n[s][c].tensors))}return r}function D(e,t,o){let n=b(e),r={},s={},c={},i=[];for(let d of e.children)c[d.id]=d,p(d)&&i.push(d);let a={};for(let d of i)for(let u of n[d.id])a[u]=d;function I(d,u,y){N(r,d,u,y),N(s,u,d,y)}function f(d,u,y){if(d&&d!==u){let h;p(u)||(h=t[u.id]?.[y]?.tensors),N(r,u,d,h),N(s,d,u,h)}}for(let d of e.children)if(p(d)){let u=n[d.id];for(let y of u)for(let h of Object.keys(t[y]||{}))c[h]?I(d,o[h],t[y][h].tensors):f(a[h],d,h)}else for(let u of Object.keys(t[d.id]||{}))c[u]?I(d,o[u],t[d.id][u].tensors):f(a[u],d,u);return{layerAdjacencyList:r,inverseLayerAdjacencyList:s}}function N(e,t,o,n){e[t.id]||(e[t.id]={}),e[t.id][o.id]={tensors:n}}function b(e){let t={};function o(n){let r=new Set;for(let s of n.children)p(s)?o(s).forEach(i=>r.add(i)):r.add(s.id);return t[n.id]=r,r}return o(e),t}function P(e,t,o){return{id:`${e.id}->${t.id}`,sourceNode:e,targetNode:t,tensors:o}}function G(e){let t={};function o(n,r){if(t[n.id]=r,p(n))for(let s of n.children)o(s,[...r,n])}for(let n of e.children)o(n,[]);return t}function V(e){let{data:t}=e.data,o=T(t);postMessage(o)}addEventListener("message",V);export{V as messageHandler};
