name: Pip Audit Security Scan

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    # Run pip-audit weekly on Wednesdays at 11 AM UTC
    - cron: '0 11 * * 3'

jobs:
  pip-audit-scan:
    name: Pip Audit Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade "setuptools>=78.1.1"  # Security: Fix PYSEC-2022-43012, PYSEC-2025-49
          pip install .
          pip install pip-audit

      - name: Run pip-audit for dependency vulnerabilities
        run: |
          pip-audit --desc --output pip-audit-report.json --format=json --skip-editable || true
          pip-audit --desc --skip-editable

      - name: Generate pip-audit SARIF report
        run: |
          # Generate SARIF report, but only if vulnerabilities are found
          pip-audit --format=sarif --output=pip-audit.sarif --skip-editable || echo "No SARIF file generated (likely no vulnerabilities found)"

      - name: Upload pip-audit results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('pip-audit.sarif') != ''
        with:
          sarif_file: pip-audit.sarif

      - name: Upload pip-audit reports as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-reports-py${{ matrix.python-version }}
          path: |
            pip-audit-report.json
            pip-audit.sarif

  pip-audit-summary:
    name: Pip Audit Summary Report
    runs-on: ubuntu-latest
    needs: pip-audit-scan
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade "setuptools>=78.1.1"  # Security: Fix PYSEC-2022-43012, PYSEC-2025-49
          pip install -e .
          pip install pip-audit

      - name: Generate comprehensive pip-audit report
        run: |
          echo "# Pip Audit Security Summary" > pip-audit-summary.md
          echo "Generated on: $(date)" >> pip-audit-summary.md
          echo "" >> pip-audit-summary.md

          echo "## Vulnerability Scan Results" >> pip-audit-summary.md
          echo '```' >> pip-audit-summary.md
          pip-audit --desc --skip-editable || echo "No vulnerabilities found" >> pip-audit-summary.md
          echo '```' >> pip-audit-summary.md

          echo "" >> pip-audit-summary.md
          echo "## Installed Package Versions" >> pip-audit-summary.md
          echo '```' >> pip-audit-summary.md
          pip list >> pip-audit-summary.md
          echo '```' >> pip-audit-summary.md

      - name: Upload summary report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-summary
          path: pip-audit-summary.md
