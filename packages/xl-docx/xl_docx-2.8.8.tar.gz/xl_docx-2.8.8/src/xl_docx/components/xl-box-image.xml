($ with $)
($ set max_width = {{box_width}} $)
($ set max_height = {{box_height}} $)
($ set original_width = {{width}} $)
($ set original_height = {{height}} $)
($ set width_ratio = max_width / original_width $)
($ set height_ratio = max_height / original_height $)
($ set scale_ratio = min(width_ratio, height_ratio) $)
($ set scaled_width = original_width * scale_ratio $)
($ set scaled_height = original_height * scale_ratio $)
<xl-image rid="{{rid}}" width="((scaled_width))" height="((scaled_height))"/>
($ endwith $)'''