---
- name: Converge
  hosts: all
  gather_facts: false
  tasks:
    - name: Check if module is calling omsdk
      ansible.builtin.include_tasks: ../_check_firmware_version_supported.yml

    - name: Execute in iDRAC10
      when:
        - not is_omsdk_required | bool
      block:
        - name: Enable security on controller
          ansible.builtin.import_role:
            name: idrac_storage_controller
          vars:
            hostname: "{{ lookup('env', 'IDRAC_IP') }}"
            username: "{{ lookup('env', 'IDRAC_USER') }}"
            password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
            validate_certs: false
            job_wait: false
            enable_security: true
            controller_id: "{{ controller_name }}"

        - name: Waiting for iDRAC to be in ready state
          ansible.builtin.include_tasks:
            file: ../__lc_status.yaml
          when: enable_security_out.msg == "Successfully submitted the job that
                performs the 'EnableSecurity' operation."

        - name: Verifying enable security on controller in check mode
          ansible.builtin.assert:
            that:
              - enable_security_out.msg == "Changes found to be applied."
              - enable_security_out.changed
          when: ansible_check_mode

        - name: Verifying enable security on controller in normal mode
          ansible.builtin.assert:
            that:
              - enable_security_out.msg == "Successfully submitted the job that
                performs the 'EnableSecurity' operation."
          when:
            not ansible_check_mode and enable_security_out.status is defined

        - name: Wait for 120 seconds
          ansible.builtin.pause:
            seconds: 120
          when:
            not ansible_check_mode and enable_security_out.status is defined

        - name: Verifying enable security on controller in idempotence mode
          ansible.builtin.assert:
            that:
              - enable_security_out.msg == "No changes found to be applied."
              - not enable_security_out.changed
          when:
            - not ansible_check_mode
            - enable_security_out.status is not defined
