name: MoAI-ADK GitFlow ìë™í™”

# MoAI-ADK  3ë‹¨ê³„ íŒŒì´í”„ë¼ì¸: spec â†’ build â†’ sync
# GitFlow ì™„ì „ íˆ¬ëª…ì„± - ê°œë°œìê°€ Gitì„ ëª°ë¼ë„ ë˜ëŠ” ìë™í™”

on:
  push:
    branches: [develop, "feature/**"]
  pull_request:
    types: [opened, ready_for_review, converted_to_draft]

jobs:
  moai-pipeline:
    name: ğŸ—¿ MoAI-ADK íŒŒì´í”„ë¼ì¸
    runs-on: ubuntu-latest
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # Multi-language toolchains (conditional)
      - name: Setup Python
        if: ${{ hashFiles('requirements.txt') != '' || hashFiles('pyproject.toml') != '' || hashFiles('setup.py') != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Setup Node.js
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Bun
        if: ${{ hashFiles('bun.lockb') != '' }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "latest"

      - name: Setup Go
        if: ${{ hashFiles('go.mod') != '' }}
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Setup Rust
        if: ${{ hashFiles('Cargo.toml') != '' }}
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Java
        if: ${{ hashFiles('pom.xml') != '' || hashFiles('build.gradle') != '' || hashFiles('build.gradle.kts') != '' }}
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup .NET
        if: ${{ hashFiles('**/*.sln') != '' || hashFiles('**/*.csproj') != '' }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Ruby
        if: ${{ hashFiles('Gemfile') != '' }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Setup Flutter
        if: ${{ hashFiles('pubspec.yaml') != '' }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.x"
          channel: "stable"

      - name: Setup Swift (Xcode)
        if: ${{ hashFiles('Package.swift') != '' || hashFiles('**/*.xcodeproj') != '' || hashFiles('**/*.xcworkspace') != '' }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"

      - name: Setup Kotlin
        if: ${{ hashFiles('build.gradle.kts') != '' || hashFiles('settings.gradle.kts') != '' }}
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      # TRUST 5ì›ì¹™ ìë™ ê²€ì¦
      # Note: Validation is now handled by TypeScript-based tools
      - name: ğŸ§­ TRUST 5ì›ì¹™ ê²€ì¦
        run: |
          echo "âœ… TRUST ì›ì¹™ ê²€ì¦ì€ TypeScript ê¸°ë°˜ ë„êµ¬ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤"
          echo "   - @agent-trust-checker ì‚¬ìš©"
          echo "   - TypeScript í›… ì‹œìŠ¤í…œ í™œìš©"

      # Draft PRì—ì„œëŠ” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ë¥¼ ë¬´ì‹œí•˜ê³ , Ready PRì—ì„œëŠ” ì‹¤íŒ¨ ì‹œ CI ì‹¤íŒ¨
      - name: Run language-aware tests
        run: |
          set -e
          ALLOW_FAILURE="${{ github.event.pull_request.draft == true }}"
          echo "ğŸ” Running language-aware tests (Draft PR: allow failure = $ALLOW_FAILURE)"

          # Python tests
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            echo "â¡ï¸  Python tests"
            pip install -q pytest pytest-cov 2>/dev/null || true
            if [ "$ALLOW_FAILURE" = "true" ]; then
              pytest --cov --cov-report=term-missing || true
            else
              pytest --cov --cov-report=term-missing
            fi
          fi

          # Node.js/Bun tests
          if [ -f "package.json" ]; then
            echo "â¡ï¸  Node.js/Bun tests"
            if [ -f "bun.lockb" ]; then
              bun install --frozen-lockfile || bun install
              if [ "$ALLOW_FAILURE" = "true" ]; then
                bun test || true
              else
                bun test
              fi
            else
              npm ci --prefer-offline || npm install
              if [ "$ALLOW_FAILURE" = "true" ]; then
                npm test --if-present -- --coverage || true
              else
                npm test --if-present -- --coverage
              fi
            fi
          fi

          # Go tests
          if [ -f "go.mod" ]; then
            echo "â¡ï¸  Go tests"
            if [ "$ALLOW_FAILURE" = "true" ]; then
              go test -v -cover ./... || true
            else
              go test -v -cover ./...
            fi
          fi

          # Rust tests
          if [ -f "Cargo.toml" ]; then
            echo "â¡ï¸  Rust tests"
            if [ "$ALLOW_FAILURE" = "true" ]; then
              cargo test --all --locked || cargo test || true
            else
              cargo test --all --locked || cargo test
            fi
          fi

          # Java tests (Maven)
          if [ -f "pom.xml" ]; then
            echo "â¡ï¸  Java tests (Maven)"
            if [ "$ALLOW_FAILURE" = "true" ]; then
              mvn -q -DskipTests=false test || true
            else
              mvn -q -DskipTests=false test
            fi
          fi

          # Java/Kotlin tests (Gradle)
          if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "â¡ï¸  Java/Kotlin tests (Gradle)"
            if [ "$ALLOW_FAILURE" = "true" ]; then
              ./gradlew test || gradle test || true
            else
              ./gradlew test || gradle test
            fi
          fi

          # .NET tests
          if compgen -G "**/*.sln" > /dev/null || compgen -G "**/*.csproj" > /dev/null; then
            echo "â¡ï¸  .NET tests"
            if [ "$ALLOW_FAILURE" = "true" ]; then
              dotnet test || true
            else
              dotnet test
            fi
          fi

          # Ruby tests
          if [ -f "Gemfile" ]; then
            echo "â¡ï¸  Ruby tests"
            if [ "$ALLOW_FAILURE" = "true" ]; then
              bundle exec rspec || bundle exec rake test || true
            else
              bundle exec rspec || bundle exec rake test
            fi
          fi

          # Flutter tests
          if [ -f "pubspec.yaml" ]; then
            echo "â¡ï¸  Flutter tests"
            flutter pub get
            if [ "$ALLOW_FAILURE" = "true" ]; then
              flutter test || true
            else
              flutter test
            fi
          fi

          # Swift tests
          if [ -f "Package.swift" ]; then
            echo "â¡ï¸  Swift tests (SPM)"
            if [ "$ALLOW_FAILURE" = "true" ]; then
              swift test || true
            else
              swift test
            fi
          elif compgen -G "**/*.xcodeproj" > /dev/null || compgen -G "**/*.xcworkspace" > /dev/null; then
            echo "â¡ï¸  Swift tests (Xcode)"
            # Xcode í”„ë¡œì íŠ¸ëŠ” ìŠ¤í‚´ì´ í•„ìš”í•˜ë¯€ë¡œ ì¡°ê±´ë¶€ ì‹¤í–‰
            if [ "$ALLOW_FAILURE" = "true" ]; then
              echo "âš ï¸  Xcode í…ŒìŠ¤íŠ¸ëŠ” ìŠ¤í‚´ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"
            else
              echo "âš ï¸  Xcode í…ŒìŠ¤íŠ¸ëŠ” ìŠ¤í‚´ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"
            fi
          fi

      #  TAG ì‹œìŠ¤í…œ ê²€ì¦ (ì½”ë“œ íŒŒì¼ë§Œ)
      - name: ğŸ·ï¸ TAG ì‹œìŠ¤í…œ ê²€ì¦
        run: |
          echo "âœ… TAG ê²€ì¦ì€ tag_validator.py Hookì—ì„œ ìë™ ì²˜ë¦¬ë¨"

      # ë¸Œëœì¹˜ë³„ ë‹¨ê³„ ì‹¤í–‰
      - name: ğŸ“ SPEC ë‹¨ê³„ (feature ë¸Œëœì¹˜)
        if: startsWith(github.ref, 'refs/heads/feature/')
        run: |
          echo "ğŸŒ¿ Feature ë¸Œëœì¹˜: SPEC ê²€ì¦ ë‹¨ê³„"
          echo "- spec-builder ì—ì´ì „íŠ¸ê°€ EARS ëª…ì„¸ ì‘ì„±"
          echo "- Draft PR ìë™ ìƒì„±"

      - name: ğŸ”´ğŸŸ¢ğŸ”„ BUILD ë‹¨ê³„ (Draft PR)
        if: github.event.pull_request.draft == true
        run: |
          echo "ğŸ“ Draft PR: TDD êµ¬í˜„ ë‹¨ê³„"
          echo "- code-builder ì—ì´ì „íŠ¸ê°€ RED-GREEN-REFACTOR"
          echo "- TRUST 5ì›ì¹™ ì¤€ìˆ˜ ê²€ì¦"

      - name: ğŸ“š SYNC ë‹¨ê³„ (Ready PR)
        if: github.event.pull_request.draft == false && github.event.action == 'ready_for_review'
        run: |
          echo "âœ… Ready PR: ë¬¸ì„œ ë™ê¸°í™” ë‹¨ê³„"
          echo "- doc-syncer ì—ì´ì „íŠ¸ê°€ Living Document ë™ê¸°í™”"
          echo "- PR ë¦¬ë·° ì¤€ë¹„ ì™„ë£Œ"

      # ìµœì¢… ê²°ê³¼ ë¦¬í¬íŠ¸
      - name: ğŸ“Š MoAI íŒŒì´í”„ë¼ì¸ ì™„ë£Œ
        run: |
          echo "ğŸ—¿ MoAI-ADK GitFlow ìë™í™” ì™„ë£Œ"
          echo "âœ¨ Gitì„ ëª°ë¼ë„ í”„ë¡œí˜ì…”ë„ ì›Œí¬í”Œë¡œìš° êµ¬í˜„"
