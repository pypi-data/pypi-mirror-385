Metadata-Version: 2.4
Name: dispatcher3
Version: 0.1
Summary: python library for dispatch action
Home-page: https://github.com/5hmlA/PyTools
Author: 5hmlA
Author-email: gene.jzy@gmail.com
License: MIT Licence
Keywords: action,dispatcher3
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: 3.13
Requires-Python: >=3.6
Description-Content-Type: text/markdown
Dynamic: author
Dynamic: author-email
Dynamic: classifier
Dynamic: description
Dynamic: description-content-type
Dynamic: home-page
Dynamic: keywords
Dynamic: license
Dynamic: requires-python
Dynamic: summary

# Action Dispatch - Python ç‰ˆæœ¬

é«˜æ€§èƒ½çš„åŸºäºè£…é¥°å™¨çš„ Action æ³¨å†Œä¸åˆ†å‘ç³»ç»Ÿ

## ç‰¹æ€§

ä¸ Rust ç‰ˆæœ¬åŠŸèƒ½å¯¹ç­‰ï¼š

- âœ… **å£°æ˜å¼æ³¨å†Œ**ï¼šä½¿ç”¨ `@action` è£…é¥°å™¨
- âœ… **æ­£åˆ™åŒ¹é… + ä¼˜å…ˆçº§**ï¼šçµæ´»çš„è·¯ç”±è§„åˆ™
- âœ… **å…¨å±€åŒæ­¥æ¨¡å¼**ï¼šæ”¯æŒ `sync=True` å…¨å±€æ’ä»–æ‰§è¡Œ
- âœ… **åˆ†å±‚åŒ¹é…ä¼˜åŒ–**ï¼šç²¾ç¡®åŒ¹é… O(1)ã€å‰ç¼€åŒ¹é… O(m)ã€æ­£åˆ™åŒ¹é… O(k)
- âœ… **RwLock ä¼˜åŒ–**ï¼šå¹¶å‘æ‰§è¡Œ `sync=False` çš„ action
- âœ… **ç±»å‹æç¤º**ï¼šå®Œæ•´çš„ç±»å‹æ³¨è§£
- âœ… **å¼•ç”¨ä¼ é€’**ï¼šPython é»˜è®¤å°±æ˜¯å¯¹è±¡å¼•ç”¨ï¼Œé›¶æ‹·è´

## å®‰è£…

éœ€è¦ Python 3.7+

```bash
# æ— éœ€é¢å¤–ä¾èµ–ï¼Œåªéœ€æ ‡å‡†åº“
python action_dispatch.py  # è¿è¡Œæµ‹è¯•
```

## å¿«é€Ÿå¼€å§‹

```python
from action_dispatch import dispatcher.action, dispatch

@dataclass
class UserEvent:
    user_id: int
    action: str

# æ™®é€š actionï¼ˆå¯å¹¶å‘ï¼‰
@action(regex=r'^user/\d+/read$', priority=5, sync=False)
def handle_read(event: UserEvent):
    print(f"è¯»å–ç”¨æˆ·: {event.user_id}")

# å…³é”® actionï¼ˆå…¨å±€æ’ä»–ï¼‰
@action(regex=r'^user/\d+/update$', priority=10, sync=True)
def handle_update(event: UserEvent):
    print(f"æ›´æ–°ç”¨æˆ·: {event.user_id} (ç‹¬å æ‰§è¡Œ)")
    import time
    time.sleep(2)  # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ

# åˆ†å‘äº‹ä»¶
dispatch("user/123/read", UserEvent(123, "read"))
dispatch("user/456/update", UserEvent(456, "update"))
```

## API æ–‡æ¡£

### @action è£…é¥°å™¨

```python
@action(regex: str, priority: int = 0, description: str = "", sync: bool = False)
```

**å‚æ•°**ï¼š

| å‚æ•° | ç±»å‹ | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| `regex` | `str` | âœ… | - | åŒ¹é… key çš„æ­£åˆ™è¡¨è¾¾å¼ |
| `priority` | `int` | âŒ | `0` | ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šå¤§è¶Šé«˜ |
| `description` | `str` | âŒ | `""` | æè¿°ä¿¡æ¯ |
| `sync` | `bool` | âŒ | `False` | æ˜¯å¦å…¨å±€åŒæ­¥æ¨¡å¼ |

### dispatch å‡½æ•°

```python
dispatch(key: str, event: Any) -> None
```

**æ‰§è¡Œæµç¨‹**ï¼š

1. è·å–è¯»é”è¿›è¡ŒåŒ¹é…ï¼ˆå…è®¸å¹¶å‘ï¼‰
2. æŸ¥æ‰¾åŒ¹é…çš„ actionï¼ˆåˆ†å±‚åŒ¹é…ä¼˜åŒ–ï¼‰
3. æ ¹æ® sync æ ‡å¿—æ‰§è¡Œï¼š
   - `sync=False`ï¼šä¿æŒè¯»é”æ‰§è¡Œï¼ˆå¹¶å‘ï¼‰
   - `sync=True`ï¼šå‡çº§ä¸ºå†™é”æ‰§è¡Œï¼ˆç‹¬å ï¼‰

**å¼‚å¸¸**ï¼š

- `NoMatchError`ï¼šæ²¡æœ‰åŒ¹é…çš„ action
- `LockPoisonedError`ï¼šé”è¢«æ±¡æŸ“

### list_actions å‡½æ•°

```python
list_actions() -> List[ActionInfo]
```

è¿”å›æ‰€æœ‰å·²æ³¨å†Œçš„ action ä¿¡æ¯ï¼ˆæŒ‰ä¼˜å…ˆçº§é™åºï¼‰ã€‚

## æ€§èƒ½ä¼˜åŒ–

### 1. åˆ†å±‚åŒ¹é…

ç³»ç»Ÿè‡ªåŠ¨åˆ†ææ­£åˆ™è¡¨è¾¾å¼ï¼Œé€‰æ‹©æœ€ä¼˜åŒ¹é…ç­–ç•¥ï¼š

| åŒ¹é…ç±»å‹ | æ­£åˆ™æ ¼å¼ | æ—¶é—´å¤æ‚åº¦ | ç¤ºä¾‹ |
|---------|---------|-----------|------|
| ç²¾ç¡®åŒ¹é… | `^literal$` | O(1) | `^user/123$` |
| å‰ç¼€åŒ¹é… | `^prefix.*` | O(m) | `^api/v1/.*` |
| å¤æ‚æ­£åˆ™ | å…¶ä»– | O(k) | `^user/\d+$` |

**æ¨è**ï¼šå°½é‡ä½¿ç”¨ç²¾ç¡®åŒ¹é…æˆ–å‰ç¼€åŒ¹é…

```python
# âœ… æ¨èï¼šç²¾ç¡®åŒ¹é…ï¼ˆæœ€å¿«ï¼‰
@action(regex=r"^user/profile$")
def handle_profile(event): pass

# âœ… æ¨èï¼šå‰ç¼€åŒ¹é…ï¼ˆå¿«ï¼‰
@action(regex=r"^api/v1/.*")
def handle_api(event): pass

# âš ï¸ å¯æ¥å—ï¼šç®€å•æ­£åˆ™
@action(regex=r"^user/\d+$")
def handle_user_id(event): pass

# âŒ é¿å…ï¼šå¤æ‚æ­£åˆ™
@action(regex=r"^(?:user|admin)/(?:profile|settings)/\d+$")
def handle_complex(event): pass  # æ…¢
```

### 2. RwLock å¹¶å‘

ä½¿ç”¨è¯»å†™é”ä¼˜åŒ–å¹¶å‘æ€§èƒ½ï¼š

- **sync=False**ï¼šæŒæœ‰è¯»é”æ‰§è¡Œï¼Œå¤šä¸ªå¯å¹¶å‘
- **sync=True**ï¼šæŒæœ‰å†™é”æ‰§è¡Œï¼Œç‹¬å å…¨å±€

**æ€§èƒ½å¯¹æ¯”**ï¼ˆ10 çº¿ç¨‹ï¼‰ï¼š

| æ¨¡å¼ | ä½¿ç”¨ Mutex | ä½¿ç”¨ RwLock | æå‡ |
|------|-----------|------------|------|
| sync=False | ä¸²è¡Œï¼ˆ~1sï¼‰ | å¹¶å‘ï¼ˆ~100msï¼‰ | **10x** |
| sync=True | ä¸²è¡Œï¼ˆ~2sï¼‰ | ä¸²è¡Œï¼ˆ~2sï¼‰ | æ— å·®å¼‚ |

### 3. é›¶æ‹·è´

Python çš„å¯¹è±¡ä¼ é€’é»˜è®¤å°±æ˜¯å¼•ç”¨ä¼ é€’ï¼Œ**æ— éœ€é¢å¤–é…ç½®**ã€‚

```python
# Python è‡ªåŠ¨ä½¿ç”¨å¼•ç”¨ä¼ é€’ï¼Œé›¶æ‹·è´
@action(regex=r"^large/.*$")
def handle_large(event: LargeEvent):
    # event æ˜¯å¼•ç”¨ï¼Œä¸ä¼šæ‹·è´æ•°æ®
    pass
```

## æ€§èƒ½æµ‹è¯•

è¿è¡Œå¹¶å‘æµ‹è¯•ï¼š

```bash
python test_concurrent.py
```

**é¢„æœŸè¾“å‡º**ï¼š

```
ã€æµ‹è¯• 1ã€‘åˆ†å±‚åŒ¹é…æ€§èƒ½
ç²¾ç¡®åŒ¹é…: 10000 æ¬¡ dispatch
  æ€»è€—æ—¶: 150.00 ms
  å¹³å‡è€—æ—¶: 15.00 Î¼s/æ¬¡

å‰ç¼€åŒ¹é…: 10000 æ¬¡ dispatch
  æ€»è€—æ—¶: 200.00 ms
  å¹³å‡è€—æ—¶: 20.00 Î¼s/æ¬¡

å¤æ‚æ­£åˆ™: 10000 æ¬¡ dispatch
  æ€»è€—æ—¶: 500.00 ms
  å¹³å‡è€—æ—¶: 50.00 Î¼s/æ¬¡

ã€æµ‹è¯• 2ã€‘å¹¶å‘æ‰§è¡Œï¼ˆsync=Falseï¼‰
5 ä¸ªå¹¶å‘ä»»åŠ¡æ€»è€—æ—¶: 100 ms
âœ“ ç”±äºå¹¶å‘æ‰§è¡Œï¼Œæ€»è€—æ—¶çº¦ç­‰äºå•ä¸ªä»»åŠ¡æ—¶é—´ï¼ˆ~100msï¼‰

ã€æµ‹è¯• 3ã€‘ç‹¬å æ‰§è¡Œï¼ˆsync=Trueï¼‰
3 ä¸ªç‹¬å ä»»åŠ¡æ€»è€—æ—¶: 600 ms
âœ“ ç”±äºä¸²è¡Œæ‰§è¡Œï¼Œæ€»è€—æ—¶çº¦ç­‰äº 3 Ã— å•ä¸ªä»»åŠ¡æ—¶é—´ï¼ˆ~600msï¼‰
```

## æ€§èƒ½å¯¹æ¯”

### Python vs Rust

| æŒ‡æ ‡ | Python | Rust | è¯´æ˜ |
|------|--------|------|------|
| dispatch è€—æ—¶ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰ | ~15 Î¼s | ~0.1 Î¼s | Rust **150x** æ›´å¿« |
| dispatch è€—æ—¶ï¼ˆå‰ç¼€åŒ¹é…ï¼‰ | ~20 Î¼s | ~5 Î¼s | Rust **4x** æ›´å¿« |
| dispatch è€—æ—¶ï¼ˆå¤æ‚æ­£åˆ™ï¼‰ | ~50 Î¼s | ~10 Î¼s | Rust **5x** æ›´å¿« |
| å†…å­˜å ç”¨ | ~10 MB | ~200 KB | Rust **50x** æ›´å° |
| å¹¶å‘èƒ½åŠ› | å— GIL é™åˆ¶ | çœŸæ­£å¹¶å‘ | Rust æ›´å¼º |

**ç»“è®º**ï¼š
- Python ç‰ˆæœ¬å·²ç»è¿‡ä¼˜åŒ–ï¼Œæ€§èƒ½ä¸é”™
- Rust ç‰ˆæœ¬æ€§èƒ½æ›´ä¼˜ï¼ˆ10-150xï¼‰ï¼Œå†…å­˜æ›´å°
- Python ç‰ˆæœ¬æ›´æ˜“ç”¨ï¼Œé€‚åˆåŸå‹å¼€å‘
- Rust ç‰ˆæœ¬é€‚åˆç”Ÿäº§ç¯å¢ƒå’Œé«˜æ€§èƒ½åœºæ™¯

## Python ç‰¹æœ‰çš„ä¼˜åŒ–

### 1. GIL ä¼˜åŒ–

Python æœ‰å…¨å±€è§£é‡Šå™¨é”ï¼ˆGILï¼‰ï¼Œä½†æˆ‘ä»¬çš„å®ç°ä»ç„¶æœ‰ä¼˜åŒ–ï¼š

- **I/O å¯†é›†å‹**ï¼šé‡Šæ”¾ GILï¼ŒçœŸæ­£å¹¶å‘
- **CPU å¯†é›†å‹**ï¼šå— GIL é™åˆ¶ï¼Œä½†åˆ†å±‚åŒ¹é…ä»èƒ½æé€Ÿ

### 2. ä½¿ç”¨ PyPy

ä½¿ç”¨ PyPy å¯ä»¥è·å¾— 2-5x çš„æ€§èƒ½æå‡ï¼š

```bash
pypy3 action_dispatch.py  # ä½¿ç”¨ PyPy è¿è¡Œ
```

### 3. ä½¿ç”¨ Cython

å¯ä»¥å°†æ ¸å¿ƒæ¨¡å—ç¼–è¯‘ä¸º C æ‰©å±•ï¼Œè·å¾—æ¥è¿‘ C çš„æ€§èƒ½ï¼š

```bash
# å®‰è£… Cython
pip install cython

# ç¼–è¯‘
cython action_dispatch.py  # ç”Ÿæˆ .c æ–‡ä»¶
gcc -shared -pthread -fPIC -fwrapv -O2 -Wall -fno-strict-aliasing \
    -I/usr/include/python3.x action_dispatch.c -o action_dispatch.so
```

## æ³¨æ„äº‹é¡¹

### 1. GIL é™åˆ¶

Python çš„ GIL é™åˆ¶äº†çœŸæ­£çš„å¹¶å‘ï¼š

- **CPU å¯†é›†å‹ä»»åŠ¡**ï¼šRwLock æå‡æœ‰é™
- **I/O å¯†é›†å‹ä»»åŠ¡**ï¼šRwLock æå‡æ˜¾è‘—

### 2. é¿å…æ­»é”

ä¸è¦åœ¨ `sync=True` çš„ handler ä¸­å†æ¬¡è°ƒç”¨ `dispatch`ï¼š

```python
# âŒ é”™è¯¯ï¼šä¼šæ­»é”
@action(regex=r"^task1$", sync=True)
def bad_handler(event):
    dispatch("task2", event)  # æ­»é”ï¼

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ sync=False
@action(regex=r"^task1$", sync=False)
def good_handler(event):
    dispatch("task2", event)  # OK
```

### 3. ç±»å‹æç¤º

è™½ç„¶æä¾›äº†ç±»å‹æç¤ºï¼Œä½† Python è¿è¡Œæ—¶ä¸å¼ºåˆ¶æ£€æŸ¥ï¼š

```python
from typing import TypeVar, Generic

T = TypeVar('T')

# å¯ä»¥æ·»åŠ è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥
def dispatch_typed(key: str, event: T) -> None:
    if not isinstance(event, expected_type):
        raise TypeError(f"Expected {expected_type}, got {type(event)}")
    dispatch(key, event)
```

## è¿›é˜¶ç”¨æ³•

### 1. æ€§èƒ½ç›‘æ§

```python
from action_dispatch import dispatch_with_stats, get_stats, reset_stats

# ä½¿ç”¨å¸¦ç»Ÿè®¡çš„ dispatch
for _ in range(1000):
    dispatch_with_stats("user/123", event)

# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = get_stats()
print(f"å¹³å‡è€—æ—¶: {stats.average_time_us():.2f} Î¼s")
print(f"æ€»è°ƒç”¨: {stats.total_dispatches}")
```

### 2. è‡ªå®šä¹‰é”™è¯¯å¤„ç†

```python
from action_dispatch import dispatch, NoMatchError

try:
    dispatch("unknown/key", event)
except NoMatchError:
    # è®°å½•æ—¥å¿—æˆ–å›é€€å¤„ç†
    logger.warning(f"No handler for: unknown/key")
    fallback_handler(event)
```

### 3. åŠ¨æ€æ³¨å†Œ

```python
from action_dispatch import dispatcher.action

# åŠ¨æ€åˆ›å»º handler
def create_handler(name: str):
    @action(regex=f"^{name}/.*$", priority=5)
    def handler(event):
        print(f"Handle {name}: {event}")
    return handler

# æ‰¹é‡åˆ›å»º
for name in ["user", "order", "payment"]:
    create_handler(name)
```

## æ–‡ä»¶ç»“æ„

```
py/
â”œâ”€â”€ action_dispatch.py      # æ ¸å¿ƒå®ç°
â”œâ”€â”€ test_concurrent.py      # å¹¶å‘æµ‹è¯•
â””â”€â”€ README.md              # æœ¬æ–‡æ¡£
```

## è®¸å¯è¯

MIT OR Apache-2.0

---

**Happy coding with Python! ğŸ**

