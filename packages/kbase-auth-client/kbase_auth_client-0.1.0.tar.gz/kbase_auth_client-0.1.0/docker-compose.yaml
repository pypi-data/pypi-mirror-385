services:

  auth:
    image: ghcr.io/kbase/auth2:0.7.1
    platform: linux/amd64
    ports:
      - 50001:8080
    environment:
      mongo_host: "mongodb:27017"
      mongo_db: "auth2_python_client_test"
      test_mode_enabled: "true"
      identity_providers: ""
    command:
      - "-template"
      - "/kb/deployment/conf/.templates/deployment.cfg.templ:/kb/deployment/conf/deployment.cfg"
      - "/kb/deployment/bin/start_auth2.sh"
    depends_on:
      - mongodb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 1s
      # https://github.com/kbase/auth2/issues/443
      retries: 30

  mongodb:
    image: mongo:7.0.14
    ports:
      - 27017:27017
