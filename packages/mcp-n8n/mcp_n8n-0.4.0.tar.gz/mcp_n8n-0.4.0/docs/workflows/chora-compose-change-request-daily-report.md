# Change Request: Daily Report Template & Configuration for chora-compose

**Date:** 2025-10-20 (Updated: 2025-10-20)
**Requestor:** mcp-n8n Gateway Team (Victor Piper)
**Target:** N/A
**Priority:** N/A
**Status:** ❌ WITHDRAWN - Architecture misunderstanding clarified by chora-compose team

**Resolution:** Templates and configs should live in mcp-n8n repository, not chora-compose. See [chora-integration-architecture.md](chora-integration-architecture.md) for correct approach.

---

## ⚠️ UPDATE: What We Learned

The chora-compose team responded with important architectural clarifications:

### Key Misunderstandings Corrected

1. **Templates Location**: chora-compose is a framework/engine, not a template library
   - ❌ Wrong: Request templates be added to chora-compose repo
   - ✅ Correct: Create templates in mcp-n8n repo, point chora-compose to them via `CHORA_CONFIG_PATH`

2. **Tool Usage Pattern**: Misunderstood `generate_content` and `assemble_artifact`
   - ❌ Wrong: Pass `template_id` parameter to `generate_content`
   - ✅ Correct: Pass `content_config_id` which references template in its config

3. **Ephemeral Storage**: No per-config retention settings
   - ❌ Wrong: Each artifact config can specify `retention_days`
   - ✅ Correct: All content uses 30-day retention (hardcoded), use `cleanup_ephemeral` tool for custom retention

### Correct Architecture

```
mcp-n8n/
├── chora-configs/              ← Our templates/configs
│   ├── content/
│   │   └── daily-report.json   ← Content config (references template)
│   └── templates/
│       └── daily-report.md.j2  ← Jinja2 template
└── workflows/
    └── daily_report.py         ← Calls generate_content(content_config_id="daily-report")
```

See complete architecture documentation in [chora-integration-architecture.md](chora-integration-architecture.md).

---

## Original Request (For Reference Only)

The mcp-n8n gateway team is implementing Sprint 5 Production Workflows, starting with a **Daily Engineering Report** workflow. This workflow will be the first production validation of mcp-n8n + chora-compose integration.

**What We Need:** Template and artifact configuration files added to chora-compose repository to support daily report generation using ephemeral storage (7-day retention).

**Why:** This establishes the configuration-driven pattern for workflows (avoiding custom artifact generation code) and validates the ephemeral storage feature confirmed in your Oct 19 response.

---

## Context

### Project: mcp-n8n Gateway (Sprint 5)

- **Objective:** Build 3-5 production workflow templates demonstrating mcp-n8n + chora-compose integration
- **First Workflow:** Daily Engineering Report (validation/de-risk workflow)
- **Architecture:** mcp-n8n calls chora-compose MCP tools via JSON-RPC (Pattern P5 Gateway)

### Key Insight from User Feedback

> "The whole point of chora-compose is to not have to do development but instead configuration."

We were initially writing artifact generation code (string concatenation). You're right - we should be using **templates and configs**, not code. This change request ensures we follow that philosophy.

---

## Requested Changes

### 1. Daily Report Jinja2 Template

**File:** `templates/daily-report.jinja2`

**Content:**

```jinja2
# Daily Engineering Report - {{ date }}

## Summary

**Date:** {{ date }}
**Generated:** {{ generated_at }}
**Coverage:** Last {{ since_hours }} hours

### Key Metrics

- **Commits:** {{ commits | length }}
- **Events:** {{ stats.total_events }}
- **Tool Calls:** {{ stats.tool_usage | length }}
- **Success Rate:** {{ "%.1f" | format(stats.success_rate) }}%

## Recent Commits ({{ commits | length }})

{% for commit in commits %}
- **{{ commit.hash }}** ({{ commit.author }}): {{ commit.message }}
  - Time: {{ commit.timestamp }}
  - Files: {{ commit.files_changed }}
{% else %}
*No commits in this period*
{% endfor %}

## Gateway Activity

### Events by Type
{% for type, count in stats.by_type.items() %}
- {{ type }}: {{ count }}
{% endfor %}

### Tool Usage
{% for tool, count in stats.tool_usage.items() %}
- {{ tool }}: {{ count }} calls
{% endfor %}

### Backends Active
{% for backend in stats.by_backend.keys() %}
- {{ backend }}
{% else %}
*No backends active*
{% endfor %}

### Performance
- **Success Rate:** {{ "%.1f" | format(stats.success_rate) }}%
- **Total Events:** {{ stats.total_events }}

---

*Generated by mcp-n8n gateway + chora-compose*
*Report stored in ephemeral storage (7-day retention)*
```

**Context Schema (for documentation):**

```python
{
    "date": "2025-10-19",  # ISO date string
    "generated_at": "2025-10-19T20:45:00Z",  # ISO timestamp
    "since_hours": 24,  # int
    "commits": [  # list[CommitInfo]
        {
            "hash": "abc1234",
            "author": "Alice",
            "message": "feat: Add feature",
            "timestamp": "2025-10-19T14:23:00Z",
            "files_changed": 5
        }
    ],
    "stats": {  # EventStatistics
        "total_events": 127,
        "by_type": {"gateway.tool_call": 42, ...},
        "by_status": {"success": 121, "failure": 6},
        "by_backend": {"chora-composer": 38, ...},
        "tool_usage": {"chora:generate_content": 20, ...},
        "success_rate": 95.28
    }
}
```

---

### 2. Ephemeral Storage Artifact Configuration

**File:** `configs/artifacts/daily-report-ephemeral.yaml`

**Content:**

```yaml
# Daily Engineering Report - Ephemeral Storage Configuration
#
# This artifact uses ephemeral storage with 7-day retention to prevent
# accumulation of time-sensitive reports.

artifact_type: report
artifact_id: daily-report

# Ephemeral storage configuration (confirmed supported in v1.3.0)
storage:
  type: ephemeral
  retention_days: 7
  # EphemeralStorageManager will auto-cleanup reports older than 7 days

output:
  filename_template: "daily-report-{{ date }}.md"
  formats:
    - markdown
    # HTML format available via output_format parameter in workflow

# Template configuration
template:
  id: daily-report
  engine: jinja2
  path: templates/daily-report.jinja2

# Metadata for tracking
metadata:
  report_type: daily-engineering
  generated_by: mcp-n8n-gateway
  workflow_version: "1.0.0"
  category: production-workflow

# Optional: Content validation schema
validation:
  required_context_fields:
    - date
    - generated_at
    - commits  # list
    - stats    # dict

# Optional: Performance targets (for monitoring)
performance:
  max_generation_time_seconds: 30
  max_artifact_size_kb: 500
```

---

### 3. Optional: HTML Output Variant (Nice-to-Have)

If time permits, we could add an HTML output version:

**File:** `configs/artifacts/daily-report-ephemeral-html.yaml`

Same as above, but with:

```yaml
output:
  filename_template: "daily-report-{{ date }}.html"
  formats:
    - html

template:
  id: daily-report-html
  engine: jinja2
  path: templates/daily-report.html.jinja2  # HTML version of template
```

This would allow workflows to choose output format:

```python
# Markdown
artifact = await call_tool("chora:assemble_artifact", {
    "config_id": "daily-report-ephemeral"
})

# HTML
artifact = await call_tool("chora:assemble_artifact", {
    "config_id": "daily-report-ephemeral-html"
})
```

**Priority:** P2 (nice-to-have, not blocking)

---

## How mcp-n8n Will Use This

### Workflow Code (Python)

```python
async def run_daily_report(...) -> DailyReportResult:
    # 1. Gather data (mcp-n8n responsibility)
    commits = await get_recent_commits(repository_path, since_hours)
    events = await get_events(since="24h")  # MCP tool
    stats = aggregate_statistics(events)

    # 2. Prepare context for template
    context = {
        "date": report_date,
        "generated_at": datetime.now(UTC).isoformat(),
        "since_hours": since_hours,
        "commits": commits,
        "stats": stats
    }

    # 3. Call chora-compose MCP tools (configuration-driven!)
    backend = registry.get_backend_by_namespace("chora")

    # Generate content using template
    content_result = await backend.call_tool("generate_content", {
        "template_id": "daily-report",
        "context": context
    })

    # Assemble artifact with ephemeral storage
    artifact_result = await backend.call_tool("assemble_artifact", {
        "config_id": "daily-report-ephemeral",
        "sections": [content_result]
    })

    return {
        "status": "success",
        "report_path": artifact_result["path"],  # ephemeral storage path
        "summary": {...}
    }
```

**Key Point:** No custom artifact generation code in mcp-n8n - it's all configuration in chora-compose!

---

## Benefits

### For chora-compose

1. **Demonstrates ephemeral storage** - First production use of EphemeralStorageManager
2. **Reference implementation** - Other teams can copy this pattern
3. **Validates MCP integration** - Proves chora tools work via gateway
4. **Documentation value** - Real-world example of template + config approach

### For mcp-n8n

1. **Unblocks Sprint 5** - Can complete Daily Report workflow
2. **Validates architecture** - Proves configuration-over-code philosophy
3. **Establishes pattern** - Template for 2-4 more workflows
4. **Production-ready** - Can deploy and use immediately

### For Ecosystem

1. **Best practices** - Shows correct way to build workflows
2. **Reusable components** - Template can be used by other projects
3. **Integration proof** - Demonstrates mcp-n8n + chora-compose working together

---

## Timeline

**Requested by:** End of Sprint 5, Day 2 (Oct 21, 2025)

**Rationale:** We're implementing the Daily Report workflow this week and need these configs to properly test end-to-end integration. Without them, we'd have to:
- Write temporary custom artifact code (anti-pattern)
- OR wait to test until chora-compose configs exist
- OR mock chora-compose responses (doesn't validate real integration)

**Ideal Timeline:**
- **Oct 20:** chora-compose team creates template + config
- **Oct 21:** mcp-n8n team integrates and tests end-to-end
- **Oct 22:** Validation complete, move to next workflow

---

## Testing & Validation

### chora-compose Testing

You can test the template/config independently:

```bash
# Test template rendering
chora-compose generate \
  --template daily-report \
  --context '{"date": "2025-10-19", "commits": [], "stats": {...}}'

# Test artifact assembly with ephemeral storage
chora-compose assemble \
  --config daily-report-ephemeral \
  --sections content.md

# Verify ephemeral storage
ls -la var/ephemeral/  # Should show report file
# Wait 7 days, verify auto-cleanup
```

### mcp-n8n Testing

We'll test via MCP tools:

```python
# Call from gateway
result = await backend.call_tool("generate_content", {
    "template_id": "daily-report",
    "context": {...}
})

# Verify result
assert result["content"] is not None
assert "Daily Engineering Report" in result["content"]

# Call assemble
artifact = await backend.call_tool("assemble_artifact", {
    "config_id": "daily-report-ephemeral"
})

# Verify ephemeral storage
assert artifact["path"].startswith("/tmp/") or "ephemeral" in artifact["path"]
assert artifact["retention_days"] == 7
```

---

## Open Questions

1. **Template Location:** Should this go in `templates/` or `templates/workflows/`?
2. **Config Location:** Should this go in `configs/artifacts/` or `configs/workflows/`?
3. **Naming Convention:** Is `daily-report` the right ID, or should it be `mcp-n8n-daily-report`?
4. **HTML Template:** Priority? If yes, same PR or separate?
5. **Documentation:** Should we add a "Using Templates in Workflows" guide?

---

## Related Documents

- [Daily Report Specification](./daily-report-spec.md) - Full workflow design
- [Daily Report API Reference](./daily-report-api-reference.md) - Function signatures
- [Daily Report Acceptance Criteria](./daily-report-acceptance-criteria.md) - Test cases
- [Chora-Compose Storage Question](./chora-compose-storage-question.md) - Ephemeral storage confirmation

---

## Contact

**Requestor:** Victor Piper (mcp-n8n team)
**Repository:** https://github.com/vlcttpr/mcp-n8n
**Sprint:** Sprint 5 - Production Workflows
**Slack/Email:** (your contact info)

---

## Acceptance Criteria

This change request is **complete** when:

- ✅ `templates/daily-report.jinja2` file exists in chora-compose repo
- ✅ `configs/artifacts/daily-report-ephemeral.yaml` file exists in chora-compose repo
- ✅ Template renders successfully with sample context
- ✅ Artifact assembly works with ephemeral storage
- ✅ EphemeralStorageManager creates file in ephemeral directory
- ✅ File will auto-delete after 7 days (verified via retention config)
- ✅ mcp-n8n can call `chora:generate_content` with `template_id="daily-report"`
- ✅ mcp-n8n can call `chora:assemble_artifact` with `config_id="daily-report-ephemeral"`

---

**Status:** DRAFT - Ready for chora-compose team review
**Next Action:** Submit as GitHub issue or PR to chora-compose repository
