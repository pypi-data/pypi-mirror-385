<?xml version="1.0"?>
<beast
    namespace="
        :beast.base.evolution.operator.kernel
        :beast.base.inference.parameter
        :beast.base.inference.operator.kernel
        :beast.base.inference
        :beast.base.inference.distribution
        :bdmmprime.distribution
        :bdmmprime.parameterization
        :feast.fileio
        :feast.function
        :feast.expressions"
    version="2.5"
>
    <map name="Uniform">beast.base.inference.distribution.Uniform</map>

    <map name="TreeFromNewickFile">feast.fileio.TreeFromNewickFile</map>
    <map name="TaxonSetFromTree">feast.fileio.TaxonSetFromTree</map>
	<map name="TraitSetFromTaxonSet">feast.fileio.TraitSetFromTaxonSet</map>
    <map name="TypeSet">bdmmprime.parameterization.TypeSet</map>

    <TreeFromNewickFile id="tree" fileName="$(treeFile)" IsLabelledNewick="true" adjustTipHeights='false'/>
    <TaxonSetFromTree id="taxonSet" tree="@tree"/>
	<TraitSetFromTaxonSet id="typeTraitSet" traitname="type" delimiter="|" takeGroup="1" taxa="@taxonSet"/>
	<TypeSet id="typeSet" value="$(types)" typeTraitSet="@typeTraitSet"/>

    <Uniform id="birthRatePrior" upper="$(birthRateUpper)"/>
    <Uniform id="deathRatePrior" upper="$(deathRateUpper)"/>

    <run spec="MCMC" chainLength="10000000">
        <state id="state">
            <stateNode spec="RealParameter" id="birthRate" value="$(birthRateInit)"/>
            <stateNode spec="RealParameter" id="deathRate" value="$(deathRateInit)"/>
        </state>

        <distribution id="posterior" spec="CompoundDistribution">
            <distribution id="likelihood" spec="CompoundDistribution">
                <distribution spec="BirthDeathMigrationDistribution" tree="@tree" typeTraitSet="@typeTraitSet">
                    <parameterization spec="CanonicalParameterization" processLength="$(processLength)" typeSet="@typeSet">
                        <birthRate id="birthRateSP" spec="SkylineVectorParameter" skylineValues="@birthRate" changeTimes="$(changeTimes)" typeSet="@typeSet"/>
                        <deathRate id="deathRateSP" spec="SkylineVectorParameter" skylineValues="@deathRate" changeTimes="$(changeTimes)" typeSet="@typeSet"/>
                        <migrationRate spec="SkylineMatrixParameter" skylineValues="$(migrationRate)" typeSet="@typeSet"/>
                        <samplingRate spec="SkylineVectorParameter" skylineValues="$(samplingRate)" typeSet="@typeSet"/>
                        <removalProb spec="SkylineVectorParameter" skylineValues="0.0" typeSet="@typeSet"/>
                        <rhoSampling spec="TimedParameter" values="1" times="$(processLength)" typeSet="@typeSet"/>
                    </parameterization>
                    <startTypePriorProbs spec="RealParameter" value="$(startTypePriorProbs)"/>
                </distribution>
            </distribution>

            <distribution id="prior" spec="CompoundDistribution">
                <distribution spec="Prior" x="@deathRate" distr="@deathRatePrior"/>
                <distribution spec="Prior" x="@birthRate" distr="@birthRatePrior"/>
            </distribution>
        </distribution>

        <operator spec="BactrianScaleOperator" parameter="@birthRate" weight="30.0"/>
        <operator spec="BactrianScaleOperator" parameter="@deathRate" weight="30.0"/>

        <logger spec="Logger" fileName="$(treeID).log" logEvery="1000" model="@posterior">
            <log idref="posterior"/>
            <log idref="prior"/>
            <log idref="likelihood"/>
            <log idref="birthRateSP"/>
            <log idref="deathRateSP"/>
        </logger>
    </run>

</beast>