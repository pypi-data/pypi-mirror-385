<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<beast
    namespace="
        :beast.base.inference
        :beast.base.inference.parameter
        :beast.base.evolution.branchratemodel
        :beast.base.evolution.substitutionmodel
        :beast.base.evolution.sitemodel
        :beast.base.evolution.tree.coalescent
        :beast.base.evolution.tree
        :beast.base.evolution.likelihood
        :beast.base.evolution.alignment
        :beast.base.evolution.operator
        :beast.base.evolution.operator.kernel
        :beast.base.inference.operator.kernel
        :beast.base.inference.operator
        :beast.base.math.distributions
        :beast.base.evolution
        :bdmmprime.util.operators
        :bdmmprime.util.priors
        :bdmmprime.distribution
        :bdmmprime.parameterization
        :bdmmprime.mapping
        :bdmmprime.util
        :bdmmprime.trajectories
        :feast
        :feast.parameter
        :feast.fileio
        :feast.function
        :feast.expressions
        :glmprior.util"
    required="BEAST.base v2.7.7:BDMM-Prime v2.2.2"
    version="2.7"
>
    <map name="Uniform" >beast.base.inference.distribution.Uniform</map>
    <map name="Exponential" >beast.base.inference.distribution.Exponential</map>
    <map name="LogNormal" >beast.base.inference.distribution.LogNormalDistributionModel</map>
    <map name="Normal" >beast.base.inference.distribution.Normal</map>
    <map name="Poisson" >beast.base.inference.distribution.Poisson</map>
    <map name="prior" >beast.base.inference.distribution.Prior</map>

    <alignment id="alignment" spec= "AlignmentFromFasta" fileName = "$(aligned_fasta)"/>

    <typeSet id="typeSetBDMMPrime" spec="TypeSet">
        <typeTraitSet id="typeTraitSet" spec="TraitSetFromTaxonSet" traitname="type" delimiter="|" takeGroup="1"> 
            <taxa spec="TaxonSet" alignment="@alignment"/>
        </typeTraitSet>
    </typeSet>

    <trait id="dateTrait" spec="TraitSetFromTaxonSet" traitname="date" dateFormat="yyyy-M-dd" delimiter= "|" everythingAfterLast="true">
        <taxa spec="TaxonSet" alignment="@alignment"/>
    </trait>

    <processLength id="originBDMMPrime" spec="RealParameter">10.0</processLength>

    <Re id="ReSV" spec="SkylineVectorParameter" timesAreAges="true" processLength="@originBDMMPrime" typeSet="@typeSetBDMMPrime">
        <skylineValues id="ReValues" spec="RealParameter">1.0 1.1 1.2 1.3 1.4 1.01 1.1 1.2 1.3 1.4</skylineValues>
         <changeTimes id="ReRateChangeTimes" spec="RealParameter">0.123</changeTimes>
    </Re>

    <samplingProportion id="samplingProportionSV" spec="SkylineVectorParameter" 
                        timesAreAges="true" processLength="@originBDMMPrime" typeSet="@typeSetBDMMPrime">
        <skylineValues id="samplingProportionValues" spec="RealParameter" dimension="15" lower="0.0" upper="1.0">1.11E-5 1.2E-5 1.3E-5 1.4E-5 1.5E-5 1.1E-5 1.2E-5 1.3E-5 1.4E-5 1.5E-5 0.0 0.0 0.0 0.0 0.0</skylineValues>
        <changeTimes id="samplingProportionChangeTimes" spec="RealParameter">0.123 0.205</changeTimes>
    </samplingProportion>
    
    <becomeUninfectiousRate id="becomeUninfectiousRateSV" spec="SkylineVectorParameter"
                            typeSet="@typeSetBDMMPrime">
        <skylineValues id="becomeUninfectiousValues" spec="RealParameter">36.5</skylineValues>
    </becomeUninfectiousRate>

    <migrationRate id="migrationRateSM" spec="SkylineMatrixParameter" 
                   timesAreAges="true"  processLength="@originBDMMPrime" typeSet="@typeSetBDMMPrime">

        <skylineValues id="migrationRateValues" spec="bella.BayesMLP" nodes="$(nodes)">
            <plate var="predictor" range="$(GLMpredictor_files)">
                <predictor spec="RealParameterFromXSV" id="$(predictor)" fileName="$(predictor)"/>
            </plate>

            <plate var="n" range="$(layersRange)">
                <weights idref="migrationW$(n)"/>
            </plate>

        </skylineValues>

        <changeTimes id="migrationRateChangeTimes" spec="RealParameterFromXSV" 
                     fileName="$(GLMpredictor_changetimes)"/>
    </migrationRate> 



    <removalProb id="removalProbSV" spec="SkylineVectorParameter" skylineValues="1.0"
        processLength="@originBDMMPrime" typeSet="@typeSetBDMMPrime"/>

    <startTypePriorProbs id="typeFrequencies" spec="RealParameter" 
        estimate="false" lower="0.0" upper="1.0">1.0 0.0 0.0 0.0 0.0</startTypePriorProbs>


<!-- Site Model -->
    <siteModel id="siteModel" spec="SiteModel" gammaCategoryCount="4">
        <parameter id="gammaShape" name="shape" value="1.0"/>
        <parameter name="mutationRate"  estimate="false" value="1.0"/>
        <parameter name="proportionInvariant" estimate="false" value="0.0"/>

        <substModel spec="HKY">
            <kappa id="kappa" spec="RealParameter" value="2.0"/>
            <frequencies id="empiricalFreqs" spec="Frequencies" data="@alignment"/>
        </substModel>
    </siteModel>


<!-- Branch rate Model -->
    <branchRateModel id="branchRateModel" spec="StrictClockModel">
        <parameter id="clockRate" name="clock.rate"  estimate="false">8.0E-4</parameter>
    </branchRateModel>


<!-- Population Model for Tree initialiser -->
    <popFunc id="popFunc" spec="ConstantPopulation">
        <popSize spec="RealParameter" value="0.1"/>
    </popFunc>


<!-- MCMC -->
    <run id="mcmc" spec="MCMC" chainLength="10000000" numInitializationAttempts="100">

    <!-- State -->
        <state id="state" spec="State">
            
            <stateNode id="treeBDMMPrime" spec="RandomTree" 
                       taxa="@alignment" 
                       populationModel="@popFunc"
                       trait="@dateTrait">
            </stateNode>
            
            <stateNode idref="originBDMMPrime"/>
            <stateNode idref="ReValues"/>
            <stateNode idref="samplingProportionValues"/>
            <plate var="n" range="$(layersRange)">
                <stateNode spec="RealParameter" id="migrationW$(n)" value="0"/>
            </plate>

            <stateNode idref="kappa"/>
            <stateNode idref="gammaShape"/>

        </state>
    

    <!-- Posterior Distribution -->
        <distribution id="posterior" spec="CompoundDistribution">

             <!-- Tree Likelihood -->
            <distribution id="likelihood" spec="CompoundDistribution" useThreads="true">
                
                <distribution id="treeLikelihood" spec="ThreadedTreeLikelihood" 
                              data="@alignment" 
                              tree="@treeBDMMPrime"
                              siteModel="@siteModel"
                              branchRateModel="@branchRateModel"/>
                    
            </distribution>

            <!-- Prior distribution -->
            <distribution id="prior" spec="CompoundDistribution">

                <!-- BDMM-Prime tree prior distribution -->
                <distribution id="BDMMPrime" spec="BirthDeathMigrationDistribution" 
                              tree="@treeBDMMPrime"
                              conditionOnSurvival="true"
                              finalSampleOffset="0.0"
                              typeTraitSet="@typeTraitSet"
                              startTypePriorProbs="@typeFrequencies">

                    <!-- Parameterization BDMM-Prime -->
                    <parameterization id="EpiBDMMPrimeParameterization" spec="EpiParameterization" 
                                      processLength="@originBDMMPrime"
                                      Re="@ReSV"
                                      samplingProportion="@samplingProportionSV"
                                      becomeUninfectiousRate="@becomeUninfectiousRateSV"
                                      migrationRate="@migrationRateSM"
                                      removalProb="@removalProbSV"
                                      typeSet="@typeSetBDMMPrime"/>

                </distribution> 


            <!-- Priors on parameters -->
            <!-- BDMMPrime parameters priors -->

                <prior id="originBDMMPrimePrior" name="distribution" x="@originBDMMPrime">
                    <LogNormal name="distr" M="-1.0" S="0.2"/>
                </prior>

                <!-- Reproductive number Prior -->
                <distribution id="RePrior" spec="SmartZeroExcludingPrior" x="@ReValues">
                    <LogNormal name="distr" M="0.8" S="0.5"/>
                </distribution>

                <!-- Prior for sampling proportion for China -->
                <distribution id="spChinaE2Prior" spec="SmartZeroExcludingPrior" x="@samplingProportionValues" 
                    classesToExclude="1.2E-5 1.3E-5 1.4E-5 1.5E-5">
                    <Uniform name="distr" lower="0" upper="0.15"/>
                </distribution>
                 <!-- Prior for sampling proportion for France -->
                <distribution id="spFranceE1Prior" spec="SmartZeroExcludingPrior" x="@samplingProportionValues" 
                    classesToExclude="1.1E-5 1.3E-5 1.4E-5 1.5E-5">
                    <Uniform name="distr" lower="0" upper="0.093"/>
                </distribution>
                <!-- Prior for sampling proportion for Germany Epoch -->
                <distribution id="spGermanyE1Prior" spec="SmartZeroExcludingPrior" x="@samplingProportionValues" 
                    classesToExclude="1.1E-5 1.2E-5 1.4E-5 1.5E-5">
                    <Uniform name="distr" lower="0" upper="0.10"/>
                </distribution>
                <!-- Prior for sampling proportion for Italy -->
                <distribution id="spItalyE1Prior" spec="SmartZeroExcludingPrior" x="@samplingProportionValues" 
                    classesToExclude="1.1E-5 1.2E-5 1.3E-5 1.5E-5">
                    <Uniform name="distr" lower="0" upper="0.005"/>
                </distribution>
                <!-- Prior for sampling proportion for OtherEuropean -->
                <distribution id="spOEE1Prior" spec="SmartZeroExcludingPrior" x="@samplingProportionValues" 
                    classesToExclude="1.1E-5 1.2E-5 1.3E-5 1.4E-5">
                    <Uniform name="distr" lower="0" upper="0.057"/>
                </distribution>

                <plate var="n" range="$(layersRange)">
                    <prior name="distribution" x="@migrationW$(n)">
                        <Normal name="distr" mean="0.0" sigma="1.0"/>
                    </prior>
                </plate>

                <prior id="GammaShapePrior" name="distribution" x="@gammaShape">
                    <Exponential name="distr">
                        <parameter spec="RealParameter" estimate="false" name="mean">0.5</parameter>
                    </Exponential>
                </prior>

                <prior id="KappaPrior" name="distribution" x="@kappa">
                    <LogNormal name="distr">
                        <parameter spec="RealParameter" estimate="false" name="M">1.0</parameter>
                        <parameter spec="RealParameter" estimate="false" name="S">1.25</parameter>
                    </LogNormal>
                </prior>

            </distribution>
        </distribution>


        <operator id="BDMMPrimeTreeRootScaler" spec="BactrianScaleOperator" tree="@treeBDMMPrime" 
            rootOnly="true" scaleFactor="0.25"  weight="5.0"/>

        <operator id="BDMMPrimeUniformOperator" spec="BactrianNodeOperator" tree="@treeBDMMPrime" 
            weight="30.0"/>

        <operator id="BDMMPrimeSubtreeSlideScaler" spec="BactrianSubtreeSlide" tree="@treeBDMMPrime" 
            weight="15.0"/>

        <operator id="BDMMPrimeNarrow" spec="Exchange" tree="@treeBDMMPrime" 
            weight="15.0"/>

        <operator id="BDMMPrimeWide" spec="Exchange" tree="@treeBDMMPrime" 
            isNarrow="false" weight="3.0"/>

        <operator id="BDMMPrimeWilsonBalding" spec="WilsonBalding" tree="@treeBDMMPrime" 
            weight="3.0"/>

        <operator id="BDMMPrimeBICEPSEpochTop" spec="EpochFlexOperator" tree="@treeBDMMPrime" 
            scaleFactor="0.1" weight="2.0"/>

        <operator id="BDMMPrimeBICEPSEpochAll" spec="EpochFlexOperator" tree="@treeBDMMPrime" 
            fromOldestTipOnly="false" scaleFactor="0.1" weight="2.0"/>

        <operator id="BDMMPrimeBICEPSTreeFlex" spec="TreeStretchOperator" tree="@treeBDMMPrime" 
            scaleFactor="0.01" weight="2.0"/>

        <operator id="originBDMMPrimeScaler" spec="BactrianScaleOperator" parameter="@originBDMMPrime" 
            scaleFactor="0.25" weight="3.0" />

        <operator id="ReScaler" spec="SmartScaleOperator" parameter="@ReValues" scaleFactor="0.25" 
                weight="10.0" />

        <operator id="samplingProportionScaler" spec="SmartScaleOperator" parameter="@samplingProportionValues" 
                weight="3.0" />

        <plate var="n" range="$(layersRange)">
            <operator spec="BactrianRandomWalkOperator" parameter="@migrationW$(n)" weight="5.0"/>
        </plate>

        <operator id="gammaShapeScaler" spec="BactrianScaleOperator" parameter="@gammaShape" 
             weight="1.0"/>

        <operator id="KappaScaler" spec="BactrianScaleOperator" parameter="@kappa" 
             weight="1.0"/>


    <!-- Loggers -->
        <logger id="tracelog" spec="Logger" fileName="$(filebase).log" logEvery="1000" model="@posterior" sanitiseHeaders="true" sort="smart">
            <log idref="posterior"/>
            <log idref="likelihood"/>
            <log idref="prior"/>
            <log idref="treeLikelihood"/>
            <log idref="gammaShape"/>   
            <log idref="kappa"/>
            <log id="TreeHeight" spec="TreeStatLogger" tree="@treeBDMMPrime"/>
            <log id="typedTreeStats" spec="TypedTreeStatsLogger" includeRootEdge="true" 
                typeLabel="type" typeSet="@typeSetBDMMPrime">
                <typedTree id="typeMappedTree" spec="TypeMappedTree" bdmmDistrib="@BDMMPrime" startTypePriorProbs="@typeFrequencies" mapOnInit="false" remapOnLog="true" typeLabel="type" typeTraitSet="@typeTraitSet" untypedTree="@treeBDMMPrime"/>
            </log>
            <log idref="originBDMMPrime"/>
            <log idref="ReSV"/>
            <log idref="becomeUninfectiousRateSV"/>
            <log idref="samplingProportionSV"/>
            <log idref="migrationRateSM"/>

            <log idref="removalProbSV"/>
            <log idref="typeFrequencies"/>
        </logger>

        <logger id="screenlog" spec="Logger" logEvery="1000">
            <log idref="posterior"/>
            <log arg="@posterior" id="ESS_posterior" spec="util.ESS"/>
            <log idref="likelihood"/>
            <log arg="@likelihood" id="ESS_likelihood" spec="util.ESS"/>
            <log idref="prior"/>
            <log arg="@prior" id="ESS_prior" spec="util.ESS"/>
            <log idref="BDMMPrime"/>
            <log arg="@BDMMPrime" id="ESS_BDMMPrime" spec="util.ESS"/>
        </logger>

        <logger id="treelog" spec="Logger" fileName="$(filebase).trees" logEvery="1000" mode="tree">
            <log id="TreeWithMetaDataLogger" spec="TreeWithMetaDataLogger" tree="@treeBDMMPrime"/>
        </logger>
 
        <logger id="typedTreeLogger" spec="OptionalLogger" enableLogger="true" 
            fileName="$(filebase).typed.trees" logEvery="10000" mode="tree">
            <log idref="typeMappedTree"/>
        </logger>
        <logger id="nodeTypedTreeLogger.t:eubdmm_alignment" spec="OptionalLogger" enableLogger="true" 
            fileName="$(filebase).typed.node.trees" logEvery="10000" mode="tree">
            <log id="nodeTypedTree" spec="TypedNodeTreeLogger" typedTree="@typeMappedTree"/>
        </logger>
        <logger id="trajLogger" spec="OptionalLogger" enableLogger="true" fileName="$(filebase).traj" logEvery="10000">
            <log id="typedTraj" spec="SampledTrajectory" bdmmDistrib="@BDMMPrime" 
                startTypePriorProbs="@typeFrequencies" typeMappedTree="@typeMappedTree" useTauLeaping="true"/>
        </logger>

        <operatorschedule id="OperatorSchedule" spec="OperatorSchedule"/>

    </run>

</beast>
