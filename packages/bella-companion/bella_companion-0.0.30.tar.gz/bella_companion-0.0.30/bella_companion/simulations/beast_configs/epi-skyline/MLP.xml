<?xml version="1.0"?>
<beast
    namespace="
        :beast.base.evolution.operator.kernel
        :beast.base.inference.parameter
        :beast.base.inference.operator.kernel
        :beast.base.inference
        :beast.base.inference.distribution
        :bdmmprime.distribution
        :bdmmprime.parameterization
        :feast.fileio
        :feast.expressions"
    version="2.5"
>
    <map name="Normal">beast.base.inference.distribution.Normal</map>

    <map name="TreeFromNewickFile">feast.fileio.TreeFromNewickFile</map>

    <TreeFromNewickFile id="tree" fileName="$(treeFile)" IsLabelledNewick="true" adjustTipHeights='false'/>

    <parameter id="finalSampleOffset" spec="ExpCalculator" value="$(processLength)-$(lastSampleTime)"/>

    <Normal id="weightsPrior" mean="0" sigma="1"/>

    <run spec="MCMC" chainLength="10000000">
        <state id="state">
            <plate var="n" range="$(layersRange)">
                <stateNode spec="RealParameter" id="reproductionNumberW$(n)" value="0"/>
            </plate>
        </state>

        <distribution id="posterior" spec="CompoundDistribution">
            <distribution id="likelihood" spec="CompoundDistribution">
                <distribution spec="BirthDeathMigrationDistribution" tree="@tree" finalSampleOffset="@finalSampleOffset">
                    <parameterization spec="EpiParameterization" processLength="$(processLength)">
                        <Re id="reproductionNumberSP" spec="SkylineVectorParameter" changeTimes="$(changeTimes)">
                            <skylineValues id="reproductionNumber" spec="bella.BayesMLP" nodes="$(nodes)">
                                <predictor spec="RealParameter" value="$(timePredictor)"/>
                                <predictor spec="RealParameter" value="$(randomPredictor)"/>
                                <plate var="n" range="$(layersRange)">
                                    <weights idref="reproductionNumberW$(n)"/>
                                </plate>
                                <activationFunctionsOutput spec="bella.Sigmoid" upper="$(reproductionNumberUpper)"/>
                            </skylineValues>
                        </Re>
                        <becomeUninfectiousRate spec="SkylineVectorParameter" skylineValues="$(becomeUninfectiousRate)"/>
                        <samplingProportion spec="SkylineVectorParameter" skylineValues="$(samplingProportion)"/>
                        <removalProb spec="SkylineVectorParameter" skylineValues="1.0"/>
                    </parameterization>
                </distribution>
            </distribution>

            <distribution id="prior" spec="CompoundDistribution">
                <plate var="n" range="$(layersRange)">
                    <distribution spec="Prior" x="@reproductionNumberW$(n)" distr="@weightsPrior"/>
                </plate>
            </distribution>
        </distribution>

        <plate var="n" range="$(layersRange)">
            <operator spec="BactrianRandomWalkOperator" parameter="@reproductionNumberW$(n)" weight="30.0"/>
        </plate>

        <logger spec="Logger" fileName="$(treeID).log" logEvery="1000" model="@posterior">
            <log idref="posterior"/>
            <log idref="prior"/>
            <log idref="likelihood"/>
            <log idref="reproductionNumberSP"/>
            <log idref="reproductionNumber"/>
        </logger>
    </run>

</beast>