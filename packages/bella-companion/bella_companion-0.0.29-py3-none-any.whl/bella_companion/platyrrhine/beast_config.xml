<?xml version="1.0"?>
<beast
    namespace="
        :beast.base.evolution.operator.kernel
        :beast.base.inference.parameter
        :beast.base.inference.operator.kernel
        :beast.base.inference
        :beast.base.inference.distribution
        :bdmmprime.distribution
        :bdmmprime.parameterization
        :feast.fileio
        :feast.function
        :feast.expressions"
    version="2.5"
>
    <map name="Uniform">beast.base.inference.distribution.Uniform</map>
    <map name="Normal">beast.base.inference.distribution.Normal</map>

    <map name="TreeFromNewickFile">feast.fileio.TreeFromNewickFile</map>
    <map name="TaxonSetFromTree">feast.fileio.TaxonSetFromTree</map>
	<map name="TraitSetFromXSV">feast.fileio.TraitSetFromXSV</map>
    <map name="RealParameterFromXSV">feast.fileio.RealParameterFromXSV</map>
    <map name="TypeSet">bdmmprime.parameterization.TypeSet</map>

    <TreeFromNewickFile id="tree" fileName="$(treeFile)" treeIndex="$(treeIndex)" IsLabelledNewick="true" adjustTipHeights='false'/>
    <TaxonSetFromTree id="taxonSet" tree="@tree"/>
	<TraitSetFromXSV id="typeTraitSet" traitname="type" fileName="$(traitsFile)" traitValueCol="$(traitValueCol)" skipFirstRow="true" taxa="@taxonSet"/>
	<TypeSet id="typeSet" value="$(types)" typeTraitSet="@typeTraitSet"/>

    <Normal id="weightsPrior" mean="0" sigma="1"/>
    <Uniform id="samplingRatePrior" upper="$(samplingRateUpper)"/>
    <Uniform id="migrationRatePrior" upper="$(migrationRateUpper)"/>

    <RealParameterFromXSV id="changeTimes" fileName="$(changeTimesFile)"/>

    <run spec="MCMC" chainLength="10000000">
        <state id="state">
            <plate var="n" range="$(layersRange)">
                <stateNode spec="RealParameter" id="birthRateW$(n)" value="0"/>
                <stateNode spec="RealParameter" id="deathRateW$(n)" value="0"/>
            </plate>
            <stateNode spec="RealParameter" id="samplingRate" value="$(samplingRateInit)"/>
            <stateNode spec="RealParameter" id="migrationRate" value="$(migrationRateInit)"/>
        </state>

        <distribution id="posterior" spec="CompoundDistribution">
            <distribution id="likelihood" spec="CompoundDistribution">
                <distribution spec="BirthDeathMigrationDistribution" conditionOnRoot="true" tree="@tree" typeTraitSet="@typeTraitSet">
                    <parameterization id="BDMMParameterization" spec="CanonicalParameterization" processLength="$(processLength)" typeSet="@typeSet">
                        <birthRate id="birthRateSP" spec="SkylineVectorParameter" changeTimes="@changeTimes" timesAreAges="true" processLength="$(processLength)" typeSet="@typeSet">
                            <skylineValues id="birthRate" spec="bella.BayesMLP" nodes="$(nodes)">
                                <predictor spec="RealParameter" value="$(timePredictor)"/>
                                <predictor spec="RealParameter" value="$(log10BMPredictor)"/>
                                <plate var="n" range="$(layersRange)">
                                    <weights idref="birthRateW$(n)"/>
                                </plate>
                                <activationFunctionsOutput spec="bella.Sigmoid" upper="$(birthRateUpper)"/>
                            </skylineValues>
                        </birthRate>
                        <deathRate id="deathRateSP" spec="SkylineVectorParameter" changeTimes="@changeTimes" timesAreAges="true" processLength="$(processLength)" typeSet="@typeSet">
                            <skylineValues id="deathRate" spec="bella.BayesMLP" nodes="$(nodes)">
                                <predictor spec="RealParameter" value="$(timePredictor)"/>
                                <predictor spec="RealParameter" value="$(log10BMPredictor)"/>
                                <plate var="n" range="$(layersRange)">
                                    <weights idref="deathRateW$(n)"/>
                                </plate>
                                <activationFunctionsOutput spec="bella.Sigmoid" upper="$(deathRateUpper)"/>
                            </skylineValues>
                        </deathRate>
                        <samplingRate id="samplingRateSP" spec="SkylineVectorParameter" skylineValues="@samplingRate" changeTimes="$(samplingChangeTimes)" timesAreAges="true" processLength="$(processLength)" typeSet="@typeSet"/>
                        <migrationRate id="migrationRateSP" spec="SkylineMatrixParameter" skylineValues="@migrationRate" typeSet="@typeSet"/>
                        <removalProb spec="SkylineVectorParameter" skylineValues="0.0" typeSet="@typeSet"/>
                        <rhoSampling spec="TimedParameter" values="0.44" times="$(processLength)" typeSet="@typeSet"/>
                    </parameterization>
                    <startTypePriorProbs spec="RealParameter" value="$(startTypePriorProbs)"/>
                </distribution>
            </distribution>
        
            <distribution id="prior" spec="CompoundDistribution">
                <plate var="n" range="$(layersRange)">
                    <distribution spec="Prior" x="@birthRateW$(n)" distr="@weightsPrior"/>
                    <distribution spec="Prior" x="@deathRateW$(n)" distr="@weightsPrior"/>
                </plate>
                <distribution spec="Prior" x="@samplingRate" distr="@samplingRatePrior"/>
                <distribution spec="Prior" x="@migrationRate" distr="@migrationRatePrior"/>
            </distribution>
        </distribution>

        <plate var="n" range="$(layersRange)">
            <operator spec="BactrianRandomWalkOperator" parameter="@birthRateW$(n)" weight="30.0"/>
            <operator spec="BactrianRandomWalkOperator" parameter="@deathRateW$(n)" weight="30.0"/>
        </plate>
        <operator spec="BactrianScaleOperator" parameter="@samplingRate" weight="30.0"/>
        <operator spec="BactrianScaleOperator" parameter="@migrationRate" weight="30.0"/>

        <logger spec="Logger" fileName="$(treeIndex).log" logEvery="1000" model="@posterior">
            <log idref="posterior"/>
            <log idref="prior"/>
            <log idref="likelihood"/>
            <log idref="birthRateSP"/>
            <log idref="deathRateSP"/>
            <log idref="samplingRateSP"/>
            <log idref="migrationRateSP"/>
            <log idref="birthRate"/>
            <log idref="deathRate"/>
        </logger>

        <logger fileName="$(treeIndex).trees" logEvery="100000" mode="tree">
            <log spec="bella.SkylineNodeTreeLogger" parameterization="@BDMMParameterization" precision="4">
                <typedTree spec="bdmmprime.mapping.TypeMappedTree" parameterization="@BDMMParameterization" startTypePriorProbs="$(startTypePriorProbs)" mapOnInit="false" remapOnLog="true" typeLabel="type" typeTraitSet="@typeTraitSet" untypedTree="@tree"/>
                <skylineParameter idref="birthRateSP"/>
                <skylineParameter idref="deathRateSP"/>
            </log>
        </logger>
    </run>

</beast>