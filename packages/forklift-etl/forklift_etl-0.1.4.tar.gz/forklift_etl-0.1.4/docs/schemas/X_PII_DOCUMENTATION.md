# x-pii Documentation

## Overview
The `x-pii` extension provides comprehensive Personally Identifiable Information (PII) field marking and handling for data privacy, masking, and compliance applications. This feature enables automatic identification, classification, and protection of sensitive personal data according to privacy regulations like GDPR, CCPA, and HIPAA.

## Schema Structure
```json
{
  "x-pii": {
    "description": "Personally Identifiable Information (PII) field marking for data privacy and masking applications",
    "fields": {
      "name": {
        "isPII": true,
        "category": "direct_identifier",
        "description": "Full name is direct PII requiring masking"
      },
      "birth_date": {
        "isPII": true,
        "category": "quasi_identifier",
        "description": "Birth date can be used to identify individuals when combined with other data"
      },
      "salary": {
        "isPII": true,
        "category": "sensitive",
        "description": "Financial information requiring protection"
      },
      "uuid": {
        "isPII": false,
        "category": "identifier",
        "description": "System-generated UUID, not personally identifying but may link records"
      }
    },
    "maskingRules": {
      "direct_identifier": {
        "method": "hash",
        "preserveFormat": false,
        "description": "Hash direct identifiers to protect individual privacy"
      },
      "quasi_identifier": {
        "method": "generalize",
        "preserveFormat": true,
        "description": "Generalize quasi-identifiers (e.g., birth year only)"
      },
      "sensitive": {
        "method": "range",
        "preserveFormat": true,
        "description": "Replace with ranges or categories to maintain utility while protecting privacy"
      }
    }
  }
}
```

## PII Categories

### Direct Identifiers
Information that can directly identify an individual.

**Examples**:
- Full names
- Social Security Numbers
- Email addresses
- Phone numbers
- Driver's license numbers
- Passport numbers

**Characteristics**:
- Unique to individuals
- Can identify someone without additional information
- Highest privacy risk
- Often subject to strict masking requirements

### Quasi-Identifiers
Information that can identify individuals when combined with other data.

**Examples**:
- Birth dates
- ZIP codes
- Gender
- Race/ethnicity
- Job titles
- Education levels

**Characteristics**:
- Not unique individually
- Can re-identify when combined
- Medium privacy risk
- Often handled through generalization

### Sensitive Information
Private information that may not identify but requires protection.

**Examples**:
- Salary information
- Medical conditions
- Financial data
- Performance ratings
- Disciplinary records

**Characteristics**:
- May not identify individuals
- Sensitive for privacy/competitive reasons
- Variable privacy risk
- Often handled through categorization

### System Identifiers
Technical identifiers used by systems.

**Examples**:
- Database primary keys
- UUIDs
- Session IDs
- Transaction IDs

**Characteristics**:
- Generated by systems
- May link records but don't identify people
- Low privacy risk
- Usually preserved for functionality

## Field Configuration

### `isPII`
- **Type**: Boolean
- **Description**: Whether the field contains personally identifiable information
- **Implementation**: Fields marked `true` are subject to PII handling rules
- **Default**: `false`

### `category`
- **Type**: String
- **Description**: Classification of PII sensitivity level
- **Values**:
  - `"direct_identifier"`: Can directly identify individuals
  - `"quasi_identifier"`: Can identify when combined with other data
  - `"sensitive"`: Private but may not identify
  - `"identifier"`: System identifier with linking capability
- **Required**: When `isPII` is `true`

### `description`
- **Type**: String
- **Description**: Human-readable explanation of why field is classified as PII
- **Use**: Documentation and compliance reporting

### `fieldPosition` (FWF-specific)
- **Type**: Object
- **Description**: Field position information for fixed-width files
- **Properties**:
  - `start`: Starting position in fixed-width record
  - `length`: Field length in characters
- **Use**: Position-aware masking in fixed-width formats

## Masking Rules

### Hash Masking (`"hash"`)
Replaces PII with cryptographic hash values.

**Configuration**:
```json
{
  "method": "hash",
  "algorithm": "sha256",
  "salt": "project-specific-salt",
  "preserveFormat": false,
  "preserveLength": false
}
```

**Properties**:
- **`algorithm`**: Hash algorithm (md5, sha1, sha256, sha512)
- **`salt`**: Salt value for hash security
- **`preserveFormat`**: Maintain original format structure
- **`preserveLength`**: Keep original field length

**Use Cases**:
- Direct identifiers requiring complete anonymization
- Consistent pseudonymization across datasets
- Compliance with strong privacy requirements

**Example**:
```
Original: "John Smith"
Masked:   "a1b2c3d4e5f6..."
```

### Generalization (`"generalize"`)
Replaces specific values with broader categories.

**Configuration**:
```json
{
  "method": "generalize",
  "preserveFormat": true,
  "generalizationRules": {
    "birth_date": "year_only",
    "zip_code": "first_three_digits",
    "age": "age_range"
  }
}
```

**Generalization Types**:
- **Date Generalization**: Year only, decade, season
- **Geographic**: State only, region, first N digits of ZIP
- **Age Ranges**: 5-year, 10-year buckets
- **Income Ranges**: Salary bands, percentile ranges

**Use Cases**:
- Quasi-identifiers needing utility preservation
- Statistical analysis requirements
- Compliance with moderate privacy needs

**Examples**:
```
Birth Date: "1985-06-15" → "1985"
ZIP Code:   "90210-1234" → "902**"
Salary:     "$75,000" → "$70,000-$80,000"
```

### Range/Category Masking (`"range"`)
Replaces specific values with ranges or categories.

**Configuration**:
```json
{
  "method": "range",
  "preserveFormat": true,
  "ranges": {
    "salary": {
      "type": "numeric_range",
      "bucket_size": 10000,
      "format": "${min}-${max}"
    },
    "age": {
      "type": "age_range",
      "bucket_size": 5,
      "format": "${min}-${max} years"
    }
  }
}
```

**Range Types**:
- **Numeric Ranges**: Salary bands, score ranges
- **Date Ranges**: Year ranges, decade buckets
- **Category Mapping**: Specific categories for sensitive data

**Use Cases**:
- Sensitive financial information
- Performance data
- Medical information
- Demographic data

### Redaction (`"redact"`)
Completely removes or replaces with standard values.

**Configuration**:
```json
{
  "method": "redact",
  "replacement": "[REDACTED]",
  "preserveLength": false,
  "partialRedaction": {
    "enabled": true,
    "reveal_first": 2,
    "reveal_last": 2,
    "mask_char": "*"
  }
}
```

**Options**:
- **Complete Redaction**: Replace entire value
- **Partial Redaction**: Show first/last characters
- **Pattern Preservation**: Maintain format structure

**Examples**:
```
Complete:  "555-123-4567" → "[REDACTED]"
Partial:   "555-123-4567" → "55*-***-**67"
Pattern:   "555-123-4567" → "XXX-XXX-XXXX"
```

## Implementation Details

### Processing Pipeline
1. **PII Detection**: Identify fields marked as PII
2. **Classification**: Apply category-based rules
3. **Masking Application**: Execute appropriate masking method
4. **Validation**: Verify masking meets requirements
5. **Audit Trail**: Log masking operations for compliance

### Compliance Features
- **Audit Logging**: Track all PII access and masking operations
- **Consent Management**: Handle data based on user consent levels
- **Right to Erasure**: Support for data deletion requests
- **Data Minimization**: Process only necessary PII fields
- **Purpose Limitation**: Mask based on intended data use

### Integration Points
- **Access Control**: Different masking levels for different user roles
- **Environment-Specific**: Stronger masking in non-production environments
- **Downstream Systems**: Consistent masking across data pipeline
- **Reporting**: PII handling reports for compliance teams

## Usage Examples

### Basic PII Configuration
```json
{
  "x-pii": {
    "fields": {
      "ssn": {
        "isPII": true,
        "category": "direct_identifier",
        "description": "Social Security Number requiring full masking"
      },
      "email": {
        "isPII": true,
        "category": "direct_identifier",
        "description": "Email address for customer contact"
      },
      "birth_date": {
        "isPII": true,
        "category": "quasi_identifier",
        "description": "Birth date for age verification"
      }
    },
    "maskingRules": {
      "direct_identifier": {
        "method": "hash",
        "algorithm": "sha256",
        "preserveFormat": false
      },
      "quasi_identifier": {
        "method": "generalize",
        "preserveFormat": true
      }
    }
  }
}
```

### Environment-Specific Masking
```json
{
  "x-pii": {
    "environments": {
      "production": {
        "maskingEnabled": false,
        "auditLevel": "full"
      },
      "staging": {
        "maskingEnabled": true,
        "maskingLevel": "partial"
      },
      "development": {
        "maskingEnabled": true,
        "maskingLevel": "full"
      }
    }
  }
}
```

### Role-Based Access
```json
{
  "x-pii": {
    "accessRoles": {
      "data_scientist": {
        "allowedCategories": ["quasi_identifier", "sensitive"],
        "maskingOverrides": {
          "birth_date": "year_only",
          "salary": "range"
        }
      },
      "compliance_officer": {
        "allowedCategories": ["direct_identifier", "quasi_identifier", "sensitive"],
        "maskingOverrides": {}
      },
      "external_vendor": {
        "allowedCategories": [],
        "maskingOverrides": {
          "*": "redact"
        }
      }
    }
  }
}
```

### GDPR Compliance Configuration
```json
{
  "x-pii": {
    "complianceFramework": "GDPR",
    "lawfulBasis": "legitimate_interest",
    "dataRetention": {
      "period": "7_years",
      "action": "anonymize"
    },
    "fields": {
      "name": {
        "isPII": true,
        "category": "direct_identifier",
        "lawfulBasis": "contract_performance",
        "consentRequired": false
      },
      "marketing_preferences": {
        "isPII": true,
        "category": "sensitive", 
        "lawfulBasis": "consent",
        "consentRequired": true
      }
    }
  }
}
```

## Compliance Frameworks

### GDPR (General Data Protection Regulation)
- **Lawful Basis**: Contract, consent, legitimate interest, etc.
- **Data Subject Rights**: Access, rectification, erasure, portability
- **Privacy by Design**: Default privacy-protective settings
- **Data Protection Impact Assessment**: Risk evaluation for high-risk processing

### CCPA (California Consumer Privacy Act)
- **Consumer Rights**: Know, delete, opt-out, non-discrimination
- **Business Purposes**: Specific allowed uses for personal information
- **Service Providers**: Third-party data processing agreements
- **Sensitive Personal Information**: Additional protections

### HIPAA (Health Insurance Portability and Accountability Act)
- **Protected Health Information**: 18 specific identifiers
- **Safe Harbor Method**: De-identification by removing identifiers
- **Expert Determination**: Statistical de-identification methods
- **Minimum Necessary**: Use only minimum data required

## Best Practices

1. **Classification First**: Properly classify all PII before implementing masking
2. **Business Requirements**: Balance privacy protection with data utility needs
3. **Consistent Application**: Use same masking rules across similar data types
4. **Regular Review**: Periodically review and update PII classifications
5. **Testing**: Validate masking effectiveness with privacy experts
6. **Documentation**: Maintain detailed documentation for compliance audits
7. **Access Control**: Implement role-based access to original vs. masked data
8. **Monitoring**: Track PII access patterns and masking effectiveness

## Integration with Other Features

- **x-special-type**: Automatically classify special types as PII
- **x-transformations**: Apply PII masking after data transformations
- **x-constraintHandling**: Handle PII validation errors appropriately
- **x-metadata-generation**: Include PII statistics while respecting privacy
- **x-calculatedColumns**: Mark derived PII columns appropriately
