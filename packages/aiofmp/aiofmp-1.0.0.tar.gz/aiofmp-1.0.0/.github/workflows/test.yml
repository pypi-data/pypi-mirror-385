name: Test

on:
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to test'
        required: true
        default: '3.13'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
      test-type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'unit'
          - 'mcp'
          - 'integration'
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Python ${{ github.event.inputs.python-version || '3.13' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ github.event.inputs.python-version || '3.13' }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python-version || '3.13' }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv sync --all-extras

      - name: Run linting
        run: |
          uv run ruff check . --no-fix
          uv run ruff format --check .

      - name: Run unit tests
        if: github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'unit' || github.event.inputs.test_type == ''
        run: |
          uv run pytest tests/test_*.py -v --tb=short

      - name: Run MCP tests
        if: github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'mcp' || github.event.inputs.test_type == ''
        run: |
          uv run pytest tests/test_mcp_*.py -v --tb=short

      - name: Run integration tests
        if: github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'integration' || github.event.inputs.test_type == ''
        run: |
          uv run pytest tests/ -v --tb=short --cov=aiofmp --cov-report=xml

      - name: Upload coverage to Codecov
        if: (github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'integration' || github.event.inputs.test_type == '') && (github.event.inputs.python-version == '3.13' || github.event.inputs.python-version == '')
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
