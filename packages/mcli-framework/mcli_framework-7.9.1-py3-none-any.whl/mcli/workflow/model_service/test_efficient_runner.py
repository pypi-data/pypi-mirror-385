#!/usr/bin/env python3
"""
Test script for the efficient model runner functionality.
"""

import os
import sys
from pathlib import Path

# Add the parent directory to the path so we can import the modules
sys.path.insert(0, str(Path(__file__).parent.parent.parent.parent))


def test_imports():
    """Test that all required modules can be imported"""
    print("üß™ Testing imports...")

    try:
        import requests

        print("‚úÖ requests imported")
    except ImportError as e:
        print(f"‚ùå requests import failed: {e}")
        return False

    try:
        import click

        print("‚úÖ click imported")
    except ImportError as e:
        print(f"‚ùå click import failed: {e}")
        return False

    try:
        import psutil

        print("‚úÖ psutil imported")
    except ImportError as e:
        print(f"‚ùå psutil import failed: {e}")
        return False

    try:
        from mcli.workflow.model_service.model_service import ModelService

        print("‚úÖ ModelService imported")
    except ImportError as e:
        print(f"‚ùå ModelService import failed: {e}")
        return False

    return True


def test_system_analysis():
    """Test system analysis functionality"""
    print("\nüß™ Testing system analysis...")

    try:
        import psutil

        # Get basic system info
        cpu_count = psutil.cpu_count()
        memory_gb = psutil.virtual_memory().total / (1024**3)

        print(f"‚úÖ CPU cores: {cpu_count}")
        print(f"‚úÖ Memory: {memory_gb:.1f} GB")

        # Test GPU detection
        try:
            import torch

            gpu_available = torch.cuda.is_available()
            print(f"‚úÖ GPU available: {gpu_available}")
            if gpu_available:
                gpu_name = torch.cuda.get_device_name(0)
                print(f"‚úÖ GPU name: {gpu_name}")
        except ImportError:
            print("‚ö†Ô∏è  PyTorch not available for GPU detection")

        return True

    except Exception as e:
        print(f"‚ùå System analysis failed: {e}")
        return False


def test_model_selection():
    """Test model selection logic"""
    print("\nüß™ Testing model selection...")

    try:
        # Import the efficient runner
        from mcli.workflow.model_service.ollama_efficient_runner import (
            EFFICIENT_MODELS,
            get_system_info,
            recommend_model,
        )

        # Test model dictionary
        print(f"‚úÖ Found {len(EFFICIENT_MODELS)} efficient models:")
        for key, info in EFFICIENT_MODELS.items():
            print(f"  - {key}: {info['name']} ({info['parameters']})")

        # Test system info
        system_info = get_system_info()
        print(f"‚úÖ System info collected")

        # Test model recommendation
        recommended = recommend_model(system_info)
        print(f"‚úÖ Recommended model: {recommended}")

        return True

    except Exception as e:
        print(f"‚ùå Model selection test failed: {e}")
        return False


def test_ollama_check():
    """Test Ollama installation check"""
    print("\nüß™ Testing Ollama check...")

    try:
        from mcli.workflow.model_service.ollama_efficient_runner import check_ollama_installed

        # This will check if ollama is installed
        installed = check_ollama_installed()

        if installed:
            print("‚úÖ Ollama is installed")
        else:
            print("‚ö†Ô∏è  Ollama not installed (this is expected if not installed)")

        return True

    except Exception as e:
        print(f"‚ùå Ollama check failed: {e}")
        return False


def test_mcli_service():
    """Test MCLI model service functionality"""
    print("\nüß™ Testing MCLI model service...")

    try:
        from mcli.workflow.model_service.model_service import ModelService

        # Create service instance
        service = ModelService()
        print("‚úÖ ModelService created")

        # Check status
        status = service.status()
        print(f"‚úÖ Service status: {status['running']}")

        # Test database
        models = service.model_manager.db.get_all_models()
        print(f"‚úÖ Database accessible, {len(models)} models found")

        return True

    except Exception as e:
        print(f"‚ùå MCLI service test failed: {e}")
        return False


def test_api_endpoints():
    """Test API endpoint definitions"""
    print("\nüß™ Testing API endpoints...")

    try:
        from mcli.workflow.model_service.model_service import ModelService

        service = ModelService()

        # Check for required endpoints
        routes = [route.path for route in service.app.routes]
        required_routes = ["/models", "/models/summary", "/models/from-url"]

        for route in required_routes:
            if route in routes:
                print(f"‚úÖ Route {route} found")
            else:
                print(f"‚ùå Route {route} not found")
                return False

        return True

    except Exception as e:
        print(f"‚ùå API endpoints test failed: {e}")
        return False


def main():
    """Run all tests"""
    print("üöÄ Testing Efficient Model Runner")
    print("=" * 50)

    tests = [
        ("Imports", test_imports),
        ("System Analysis", test_system_analysis),
        ("Model Selection", test_model_selection),
        ("Ollama Check", test_ollama_check),
        ("MCLI Service", test_mcli_service),
        ("API Endpoints", test_api_endpoints),
    ]

    passed = 0
    total = len(tests)

    for test_name, test_func in tests:
        print(f"\nüìã Running {test_name} test...")
        if test_func():
            passed += 1
            print(f"‚úÖ {test_name} test passed")
        else:
            print(f"‚ùå {test_name} test failed")

    print("\n" + "=" * 50)
    print(f"üìä Test Results: {passed}/{total} tests passed")

    if passed == total:
        print("üéâ All tests passed! The efficient model runner is ready to use.")
        print("\nüìù Next steps:")
        print("1. Install Ollama: https://ollama.com/download")
        print("2. Run: python ollama_efficient_runner.py")
        print("3. Follow the prompts to download and test models")
        return 0
    else:
        print("‚ùå Some tests failed. Please check the errors above.")
        return 1


if __name__ == "__main__":
    sys.exit(main())
