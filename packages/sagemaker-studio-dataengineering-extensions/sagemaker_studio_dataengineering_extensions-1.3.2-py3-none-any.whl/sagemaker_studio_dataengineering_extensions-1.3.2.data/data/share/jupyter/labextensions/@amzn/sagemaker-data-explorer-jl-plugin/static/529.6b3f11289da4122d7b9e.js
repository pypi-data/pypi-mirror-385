"use strict";(self.webpackChunk_amzn_sagemaker_data_explorer_jl_plugin=self.webpackChunk_amzn_sagemaker_data_explorer_jl_plugin||[]).push([[529],{529:(e,a,t)=>{t.r(a),t.d(a,{default:()=>P,logoIcon:()=>C}),t(219);var o,n,r=t(794),i=t(362),s=t(722),d=t(222),c=t(256),l=t(345),u=t.n(l);!function(e){e.SPARK="SPARK",e.SPARK_GLUE="SPARK_GLUE",e.SPARK_EMR_EC2="SPARK_EMR_EC2",e.SPARK_EMR_EKS="SPARK_EMR_EKS",e.SPARK_EMR_SERVERLESS="SPARK_EMR_SERVERLESS",e.IAM="IAM",e.LAKEHOUSE="LAKEHOUSE",e.S3="S3",e.GIT="GIT",e.ATHENA="ATHENA",e.HYPERPOD="HYPERPOD",e.SNOWFLAKE="SNOWFLAKE",e.BIGQUERY="BIGQUERY",e.DOCUMENTDB="DOCUMENTDB",e.DYNAMODB="DYNAMODB",e.MYSQL="MYSQL",e.OPENSEARCH="OPENSEARCH",e.ORACLE="ORACLE",e.POSTGRESQL="POSTGRESQL",e.REDSHIFT="REDSHIFT",e.SAPHANA="SAPHANA",e.SQLSERVER="SQLSERVER",e.TERADATA="TERADATA",e.VERTICA="VERTICA"}(o||(o={})),function(e){e.Connection="connection",e.Environment="environment",e.Catalog="catalog",e.CatalogChild="catalog-child",e.RedLakeCatalog="redlake-catalog",e.RedLakeCatalogChild="redlake-catalog-child",e.S3TablesCatalog="s3-tables-catalog",e.S3TablesCatalogChild="s3-tables-catalog-child",e.Database="database",e.Table="table",e.TableContainer="table-container",e.Function="function",e.Schema="schema",e.Column="column",e.StoredProcedure="stored-procedure",e.View="view",e.ViewContainer="view-container",e.Bucket="bucket",e.Folder="folder",e.File="file",e.LoadMore="load-more",e.Loading="loading",e.NoData="no-data",e.NoSchema="no-schema",e.Error="error"}(n||(n={}));const m="AwsDataCatalog",p={[o.ATHENA]:"project.athena",[o.SPARK]:"project.spark.compatibility",[o.REDSHIFT]:"project.redshift"},h="project.spark",g=[n.Bucket,n.Folder,n.File];var v;!function(e){e.AWS="aws"}(v||(v={}));const E={[v.AWS]:"public.lotus.awt.aws.a2z.com"};class f extends Error{constructor({name:e,message:a,cause:t,status:o}){super(a,t),this.status=o,this.name=e}}var w;!function(e){e.NetworkError="NetworkError",e.InvalidParametersError="InvalidParametersError",e.InvalidResponseError="InvalidResponseError",e.AbortError="AbortError"}(w||(w={}));const S=[400,401,403,404,413,415],k=async(e,a)=>{const t=Math.random()*2**e*a;await new Promise(e=>setTimeout(e,t))},A=e=>{var a,t;const[o,n]=(0,l.useState)();let r=e.stage,i="";return(null===(t=null===(a=e.dataExplorerProps)||void 0===a?void 0:a.enabledFeatures)||void 0===t?void 0:t.has("feature-data-explorer-widget-wave0"))&&(i="Wave0"),(0,l.useEffect)(()=>{let a;return(async(e="prod",a="")=>{var t;const o={packageName:"@amzn/maxdome-data-explorer-widget"+("prod"===e?"":`-${e}`),majorVersion:1..toString(),aliasName:a},n=await(async({packageName:e,majorVersion:a,host:t,aliasName:o})=>{if(!e||!a)throw new f({name:w.InvalidParametersError,message:"Missing package name or majorVersion."});var n;const r=function(e,a,t,o){const n=new URL(`https://${e}/metadata`);return n.searchParams.append("packageName",a),n.searchParams.append("majorVersion",t),o&&n.searchParams.append("aliasName",o),n}(null!=t?t:(n=v.AWS,E[n]),e,a,o),i=await async function(e){let a,t,o=new Error("Error");for(let n=0;n<3;n++){let r;try{t||(t=new AbortController),r=setTimeout(()=>{null==t||t.abort()},5e3);const o={signal:t.signal};if(a=await fetch(e.toString(),o),a.status>=200&&a.status<300)break;if(S.includes(a.status))break}catch(e){o=e,o.name===w.AbortError?(o=new Error("Timed out"),o.name=w.NetworkError):(o=new Error(`Fetch error: ${o.message}`),o.name=w.NetworkError)}await k(n,100),r&&clearTimeout(r)}if(void 0!==a)return a;throw o}(r),s=i.status,d=await i.text();let c;try{c=JSON.parse(d)}catch(e){throw new f({name:w.InvalidResponseError,message:"Response body is not a valid JSON",cause:e,status:s})}if(s>=200&&s<300){const e=c;if(!(e=>{var a,t,o,n;return!!((null==e?void 0:e.basePath)&&(null==e?void 0:e.versionId)&&(null!==(t=null===(a=null==e?void 0:e.metadata)||void 0===a?void 0:a.module)&&void 0!==t?t:null===(n=null===(o=null==e?void 0:e.metadata)||void 0===o?void 0:o.assets)||void 0===n?void 0:n.length))})(e))throw new f({name:w.InvalidResponseError,message:"Invalid metadata structure in response body"});return e}const l=`HTTP get request failed with status: '${s}', error: '${c.code}' and message: '${c.message}'`;throw new f({name:w.InvalidResponseError,message:l,status:s})})(o);return await import(n.basePath+(null===(t=n.metadata.module)||void 0===t?void 0:t.path))})(r,i).then(t=>{a=t.renderToDom({...e})}).catch(e=>{console.error("Failed to import widget",e),n(e)}),()=>null==a?void 0:a()},[]),o?u().createElement("div",null,"Unable to load data explorer."):u().createElement("div",{id:e.domId,style:{display:"contents"}})},R=["localhost","127.0.0.1"].some(e=>document.location.href.includes(e))?"http://localhost:3000":"";async function b({app:e,connections:a,connectionType:t,docManager:n,nodeData:r,notebookTracker:i}){var d,c;const l=await async function({app:e,docManager:a,notebookTracker:t}){const o=t.currentWidget;if(o)return await e.commands.execute("tabsmenu:activate-by-id",{id:o.id}),o;const n=await a.newUntitled({type:"notebook"});await a.openOrReveal(n.path,"default",{id:"python3",name:"python3"});const r=new Promise(e=>{t.widgetAdded.connect((a,t)=>{e(t)})});return await r||void 0}({app:e,docManager:n,notebookTracker:i});if(l){""===(null===(d=l.content.activeCell)||void 0===d?void 0:d.model.sharedModel.source.trim())||s.NotebookActions.insertBelow(l.content);const e=function(e,a,t){const n=function(e,a){var t;let n;const r=e.find(e=>e.name===h);n=a===o.SPARK&&r?h:p[a];return e.find(e=>e.name===n)?n:null===(t=e.find(e=>a===o.SPARK?function(e){var a;return e.type===o.SPARK&&(null===(a=e.configurations)||void 0===a?void 0:a.find(e=>{if("GlueDefaultArgument"===(null==e?void 0:e.classification)&&(null==e?void 0:e.properties))return"false"===e.properties["--enable-lakeformation-fine-grained-access"]}))}(e):e.type===a))||void 0===t?void 0:t.name}(e,a),r=function(e){var a,t;return(null===(a=e.path)||void 0===a?void 0:a.catalog)===m||(null===(t=e.path)||void 0===t?void 0:t.database)===m.toLowerCase()}(t),i=function(e){var a;return e.connectionType===o.REDSHIFT&&"dev"===(null===(a=e.path)||void 0===a?void 0:a.database)}(t),s=t.connectionType===o.REDSHIFT,d=null==t?void 0:t.path;let c=`%%sql ${n}\n`;if(d){const{catalog:e,catalogChild:t,database:n,schema:l,table:u}=d,m=s?n:e,p=s?l:n;switch(a){case o.ATHENA:c+=r?`select * from "${m}"."${p}"."${u}" limit 10`:`select * from "${m}/${t}"."${n}"."${u}" limit 10`;break;case o.REDSHIFT:c+=r||i?`select * from "${m}"."${p}"."${u}" limit 10`:`select * from "${s?"":`${t}@`}${m}"."${p}"."${u}" limit 10`;break;case o.SPARK:c+=r?`select * from \`spark_catalog\`.\`${p}\`.\`${u}\` limit 10`:`select * from \`${m}${t?`_${t}`:""}\`.\`${p}\`.\`${u}\` limit 10`}}return c}(a,t,r);await l.revealed,null===(c=l.content.activeCell)||void 0===c||c.model.sharedModel.setSource(e)}}class T extends r.ReactWidget{constructor({app:e,docManager:a,notebooks:t,theme:o}){super(),this.connections=[],this.metadata={projectId:"",domainId:"",region:"",envId:"",userId:"",dzEndpoint:"",dzRegion:"",dzStage:"",enabledFeatures:[]},this.addClass("md-de-container"),this.fetchConnections(),this.fetchEnv(),this.app=e,this.docManager=a,this.notebookTracker=t,this.theme=o,this.theme.themeChanged.connect((e,a)=>{this.render()})}fetchEnv(){fetch(`${R}/jupyterlab/default/api/env`).then(e=>e.json()).then(e=>{if(this.metadata={domainId:e.domain_id,projectId:e.project_id,region:e.aws_region,envId:e.environment_id,userId:e.user_id,dzEndpoint:e.dz_endpoint||`https://datazone.${e.dz_region}.api.aws`,dzStage:e.dz_stage,dzRegion:e.dz_region,enabledFeatures:e.enabled_features||[]},Object.values(this.metadata).some(e=>!e))throw new Error("Missing required metadata from the response")}).catch(e=>console.error("[DataSourceExplorerWidget] an error occurred: ",e))}fetchConnections(){fetch(`${R}/jupyterlab/default/api/aws/datazone/connections`).then(e=>e.json()).then(e=>{this.connections=e.items}).catch(e=>console.error("[DataSourceExplorerWidget] an error occurred: ",e))}render(){const e=this.theme.theme&&this.theme.isLight(this.theme.theme)?"light":"dark";return u().createElement(A,{domId:"data-explorer-widget-in-jl",consumerType:"jupyter-lab",credentialProvider:async()=>{var e;const a=await fetch(`${R}/jupyterlab/default/api/creds`);if(!a.ok)return Promise.reject(null===(e=await a.json())||void 0===e?void 0:e.message);const t=await a.json(),o={accessKeyId:t.access_key,secretAccessKey:t.secret_key,sessionToken:t.session_token,expiration:new Date(Date.now()+3e5)};return o?Promise.resolve(o):Promise.reject("Credentials not found or expired")},envMetaData:this.metadata,stage:this.metadata.dzStage,themeConfig:{defaultMode:e},dataExplorerProps:{menuItems:e=>this.metadata.enabledFeatures.includes("feature-data-explorer-query-jupyterlab")?function({app:e,connections:a,docManager:t,notebookTracker:r,nodeData:i}){var s;if(!i)return[];const d=[],c=i.isContainer,l=g.includes(i.nodeType),u=i.nodeType===n.Table&&!!(null===(s=i.path)||void 0===s?void 0:s.table),m=i.connectionType===o.REDSHIFT;if(u&&!c&&!l){const n={app:e,connections:a,docManager:t,nodeData:i,notebookTracker:r};m?d.push({id:"query-redshift",text:"Preview data",onClickItem:()=>b({...n,connectionType:o.REDSHIFT})}):d.push({id:"query-athena",text:"Preview data",onClickItem:()=>b({...n,connectionType:o.ATHENA})},{id:"query-spark",text:"Query with Spark",onClickItem:()=>b({...n,connectionType:o.SPARK})})}return d}({app:this.app,connections:this.connections,docManager:this.docManager,notebookTracker:this.notebookTracker,nodeData:e}):[]}})}}const C=new d.LabIcon({name:"barpkg:foo",svgstr:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9C16.4182 9 20 7.65674 20 6C20 4.34326 16.4182 3 12 3C7.58179 3 4 4.34326 4 6C4 7.65674 7.58179 9 12 9Z" fill="#FBFAFD"/> <path d="M4 8.5V12C4 13.6567 7.58179 15 12 15C16.4182 15 20 13.6567 20 12V8.5C20 10.1567 16.4182 11.5 12 11.5C7.58179 11.5 4 10.1567 4 8.5Z" fill="#FBFAFD" /><path d="M4 14.5V18C4 19.6567 7.58179 21 12 21C16.4182 21 20 19.6567 20 18V14.5C20 16.1567 16.4182 17.5 12 17.5C7.58179 17.5 4 16.1567 4 14.5Z" fill="#FBFAFD" /></svg>'}),P={id:"@amzn/sagemaker-data-explorer-jl-plugin:plugin",autoStart:!0,requires:[i.IDocumentManager,s.INotebookTracker],optional:[r.IThemeManager],activate:(e,a,t,o)=>{console.log("sagemaker-data-explorer-jl-plugin is activated!");const n=new c.Panel;n.id="sagemaker-data-explorer",n.title.icon=C,n.addWidget(new T({app:e,docManager:a,notebooks:t,theme:o})),e.shell.add(n,"left",{rank:101})}}}}]);