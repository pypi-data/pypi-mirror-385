name: create-feature-branch
description: Create and checkout a new feature branch from base branch
version: "2.0"
author: Workflows MCP Team
tags: [git, branch, feature, workflow, optimized]

inputs:
  branch_name:
    type: str
    description: (Required) Name of the feature branch to create
    required: true

  base_branch:
    type: str
    description: (Optional) Base branch to branch from (main, master, develop)
    default: "main"
    required: false

  working_dir:
    type: str
    description: (Optional) Git repository directory
    default: "."
    required: false

  fetch_first:
    type: bool
    description: (Optional) Fetch from remote before creating branch
    default: true
    required: false

  push_to_remote:
    type: bool
    description: (Optional) Push new branch to remote repository
    default: false
    required: false

blocks:
  - id: fetch_remote
    type: Shell
    inputs:
      command: "git fetch origin"
      working_dir: "${inputs.working_dir}"
      timeout: 60
    condition: "${inputs.fetch_first}"

  - id: checkout_base
    type: Shell
    inputs:
      command: "git checkout ${inputs.base_branch}"
      working_dir: "${inputs.working_dir}"
      timeout: 30
      continue-on-error: true

  - id: pull_base
    type: Shell
    inputs:
      command: "git pull origin ${inputs.base_branch}"
      working_dir: "${inputs.working_dir}"
      timeout: 60
      continue-on-error: true
    depends_on:
      - block: fetch_remote
        required: false
      - block: checkout_base
        required: true
    condition: "${inputs.fetch_first}"

  - id: create_branch
    type: Shell
    inputs:
      command: "git checkout -b ${inputs.branch_name}"
      working_dir: "${inputs.working_dir}"
      timeout: 30
    depends_on:
      - block: pull_base
        required: true

  - id: current_branch
    type: Shell
    inputs:
      command: |
        git branch --show-current > $SCRATCH/branch.txt
      working_dir: "${inputs.working_dir}"
      timeout: 10
    depends_on:
      - create_branch
    outputs:
      name:
        type: str
        path: "$SCRATCH/branch.txt"
        description: "Current branch name"

  - id: push_branch
    type: Shell
    inputs:
      command: "git push -u origin ${inputs.branch_name}"
      working_dir: "${inputs.working_dir}"
      timeout: 60
      continue-on-error: true
    depends_on:
      - current_branch
    condition: "${inputs.push_to_remote}"

  - id: summary
    type: PopulateTemplate
    inputs:
      template: |
        Feature Branch Created:
        - Branch: {{ branch_name }}
        - Base: {{ base_branch }}
        - Current branch: {{ current_branch }}
        - Pushed to remote: {{ push_status }}
      variables:
        branch_name: "${inputs.branch_name}"
        base_branch: "${inputs.base_branch}"
        current_branch: "${blocks.current_branch.outputs.stdout}"
        push_status: "{{ 'Yes' if pushed else ('Failed' if push_attempted else 'No') }}"
        pushed: "${inputs.push_to_remote} and ${blocks.push_branch.outputs.exit_code} == 0"
        push_attempted: "${inputs.push_to_remote}"
    depends_on:
      - current_branch
      - push_branch

outputs:
  success: "${blocks.create_branch.outputs.exit_code} == 0"
  branch_name: "${inputs.branch_name}"
  current_branch: "${blocks.current_branch.outputs.stdout}"
  base_branch: "${inputs.base_branch}"
  pushed_to_remote: "${inputs.push_to_remote} and ${blocks.push_branch.outputs.exit_code} == 0"
  summary: "${blocks.summary.outputs.content}"
