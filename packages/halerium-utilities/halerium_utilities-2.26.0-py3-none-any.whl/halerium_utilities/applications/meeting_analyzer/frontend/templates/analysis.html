<!DOCTYPE html>
<html lang="en">

<head>

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="" />
        <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
        <link rel="shortcut icon" href="{{ url_for('static', path='/img/hal.png')}}" />
        <link href="{{ url_for('static', path='/style/main.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', path='/style/meeting.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', path='/style/dropdownComponent.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', path='/style/progressBar.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', path='/style/analysis.css') }}" rel="stylesheet" />
        <title>Halerium Meetings</title>

    </head>
</head>

<body>
    <div class="flex col fw fh xc yc">
        <div class="flex container col fw" style="justify-content: space-between;">
            <div class="flex row logoContainer" style="justify-content: space-between;">
                <div class="flex col">
                    <div class="logo"></div>
                    <div class="subheader">Meeting Intelligence</div>
                </div>
                <div class="flex row">
                    <a href="{{ url_for('index') }}" class="btnNavigator">Start Over</a>
                    <a href="{{ chatbot_link }}" target="_blank" class="btnNavigator">Go to Chatbot</a>
                </div>
            </div>
            <h1>Transcript Analysis</h1>
            {% if error_cards %}
            <div class="flex col" id="errors">
                <p>
                    Errors during workflow execution. Please check the Halerium Board, or contact support
                </p>
                <!-- error table -->
                <table class="table">
                    <tr>
                        <th>Link to Card</th>
                        <th>Error Message</th>
                    </tr>
                    {% for k, v in error_cards.items() %}
                    <tr>
                        <td><a href="{{ deep_link }}?id={{ k }}" target="_blank">Link</a></td>
                        <td>{{ v }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            <br>
            {% endif %}
            <form id="approveForm">
                {% for key, value in analysis_output.items() %}
                <div class="flex col fw analysisItem">
                    <label for="{{ key }}">{{ key }}</label>
                    <span class="textarea" id="{{ key }}" name="{{ key }}" role="textbox" contenteditable>{{ value
                        }}</span>
                    <div class="flex row-hard fw sarContainer">
                        <div class="flex col fw sarInput">
                            <input type="text" id="search_{{ key }}" , name="search_{{ key }}" placeholder="Search for">
                            <input type="text" id="replace_{{ key }}" , name="replace_{{ key }}"
                                placeholder="Replace with">
                            <div class="flex row-hard sarCheckbox">
                                <input type="checkbox" id="global_{{ key }}" , name="global_{{ key }}">
                                <label for="global_{{ key }}">Replace globally</label>
                            </div>
                        </div>
                        <button type="button" class="sarButton btnNavigator"
                            onclick="sar(document.getElementById('search_{{ key }}').value, document.getElementById('replace_{{ key }}').value, document.getElementById('{{ key }}'), document.getElementById('global_{{ key }}').checked)">Search
                            and Replace</button>
                    </div>
                </div>
                {% endfor %}
                <div class="flex row-hard fw" style="justify-content: space-between;">
                    <button type="button" id="approveAndProcessBtn" class="btnPrimary" style="width:45%;">Approve
                        and
                        Process</button>
                    <div class="busy-progress" id="busyProgress" style="display:none;width:45%;">
                        <div class="busy-bar" id="busyBar"></div>
                    </div>
                    <a id="modifyOnBoard" target="_blank" class="btnPrimary" style="width:45%;">Modify on Board</a>
                </div>
            </form>
        </div>
    </div>
    <script>
        function sar(search, replace, el, global = false) {
            if (!global) {
                let text = el.innerHTML;
                el.innerHTML = text.replace(new RegExp(search, 'g'), replace);
            } else {
                const els = document.querySelectorAll('.textarea');
                els.forEach(el => {
                    let text = el.innerHTML;
                    el.innerHTML = text.replace(new RegExp(search, 'g'), replace);
                })
            }

            // uncheck all checkboxes
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });

            // reset the search and replace fields
            const searchFields = document.querySelectorAll('input[id^="search_"]');
            searchFields.forEach(sf => {
                sf.value = '';
            });

            const replaceFields = document.querySelectorAll('input[id^="replace_"]');
            replaceFields.forEach(rf => {
                rf.value = '';
            });
        }

        document.getElementById('approveAndProcessBtn').addEventListener('click', async (event) => {
            document.getElementById('approveForm').dispatchEvent(new Event('submit'));
        });


        document.getElementById('approveForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const btnSubmit = document.getElementById('approveAndProcessBtn'); //.classList.add("disabled");
            const busyProgress = document.getElementById('busyProgress');

            // display a busy bar
            busyProgress.style.display = "flex";

            // hide the button
            btnSubmit.style.display = "none";;

            const data = { "approved": {} };

            {% for key, value in analysis_output.items() %}
            data["approved"]['{{ key }}'] = document.getElementById('{{ key }}').innerHTML.replace(/<br>/g, '\n');
            {% endfor %}

            data['board_path'] = "{{ meeting_board_path }}";
            data['transcript'] = `{{ transcript | tojson | safe }}`;

            const response = await fetch("{{ url_for('approve_and_postprocess', session_id=session_id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                const result = await response.json();

                // check the status of the post processing
                if (result['status'] == 'success') {
                    // load the success page
                    window.location.href = "{{ url_for('success') }}?success=true&deep_link={{ deep_link }}";
                } else {
                    // load the error page
                    window.location.href = `{{ url_for('success') }}?success=false&message=${encodeURIComponent(JSON.stringify(result['message']))}&deep_link=${encodeURIComponent('{{ deep_link }}')}`;
                }

            } else {
                console.error('Failed to send data');
                window.location.href = "{{ url_for('success') }}?success=false&deep_link={{ deep_link }}";
            }
        });

        document.getElementById('modifyOnBoard').addEventListener('click', async (event) => {
            event.preventDefault();

            const data = { "approved": {} };

            {% for key, value in analysis_output.items() %}
            data["approved"]['{{ key }}'] = document.getElementById('{{ key }}').innerHTML.replace(/<br>/g, '\n');
            {% endfor %}

            data['board_path'] = "{{ meeting_board_path }}";
            data['transcript'] = `{{ transcript | tojson | safe }}`;

            const response = await fetch("{{ url_for('update_board', session_id=session_id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                const result = await response.json();

                // open the deep link in a new tab
                window.open("{{ deep_link }}", "_blank");

                // load the start page
                window.location.href = "{{ url_for('index') }}";

            } else {
                console.error('Failed to update board');
                alert('Failed to update board.');
            }
        });
    </script>
</body>

</html>