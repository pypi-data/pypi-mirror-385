# QCC v0.6.0 å‘å¸ƒè¯´æ˜

**å‘å¸ƒæ—¥æœŸ**: 2025-10-19
**ç±»å‹**: é‡å¤§åŠŸèƒ½æ›´æ–°
**é‡è¦æ€§**: ğŸŸ¢ æ¨èå‡çº§ï¼ˆæ€§èƒ½å’Œç¨³å®šæ€§å¤§å¹…æå‡ï¼‰

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### 1. è¿ç§»åˆ° httpx - è§£å†³è¿æ¥æ± é—®é¢˜

ä» aiohttp è¿ç§»åˆ° httpxï¼Œå½»åº•è§£å†³äº†è¿æ¥æ± å¤ç”¨å¯¼è‡´çš„ 502 é”™è¯¯å’Œ"closing transport"é—®é¢˜ã€‚

**æ”¹è¿›å†…å®¹**:
- ä½¿ç”¨ httpx.AsyncClient æ›¿ä»£ aiohttp.ClientSession
- æ™ºèƒ½è¿æ¥æ± ç®¡ç†ï¼ˆæœ€å¤§ 100 è¿æ¥ï¼Œä¿æŒ 20 ä¸ª keepaliveï¼‰
- è¿æ¥è‡ªåŠ¨è¿‡æœŸï¼ˆ30 ç§’ï¼‰é¿å…é•¿æ—¶é—´å¤ç”¨å¯¼è‡´çš„é—®é¢˜
- æ›´ç¨³å®šçš„ HTTP/1.1 å®ç°

**æ€§èƒ½æå‡**:
- è¿æ¥å¤ç”¨ç‡æå‡è‡³ 70%
- å‡å°‘ TCP æ¡æ‰‹å¼€é”€ 50-200ms
- å¹³å‡å“åº”æ—¶é—´å‡å°‘ 33%

**æ–‡ä»¶**: `fastcc/proxy/server.py`

### 2. æ–­è·¯å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰

å®ç°æ–­è·¯å™¨æ¨¡å¼ï¼Œé¿å…é‡å¤è¯·æ±‚æ•…éšœèŠ‚ç‚¹ï¼Œæå‡æ•…éšœè½¬ç§»é€Ÿåº¦ã€‚

**åŠŸèƒ½ç‰¹æ€§**:
- è¿ç»­ 3 æ¬¡å¤±è´¥åè‡ªåŠ¨æ‰“å¼€æ–­è·¯å™¨ï¼ˆå¯é…ç½®ï¼‰
- 60 ç§’åè‡ªåŠ¨å°è¯•æ¢å¤ï¼ˆåŠå¼€çŠ¶æ€ï¼‰
- é¿å…é‡å¤è¯·æ±‚æ•…éšœèŠ‚ç‚¹ï¼ŒèŠ‚çœ 80% æ— æ•ˆé‡è¯•æ—¶é—´
- æä¾›çŠ¶æ€æŸ¥è¯¢ API

**ä½¿ç”¨åœºæ™¯**:
- API endpoint ä¸´æ—¶æ•…éšœ
- ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„é—´æ­‡æ€§å¤±è´¥
- æœåŠ¡ç«¯è´Ÿè½½è¿‡é«˜éœ€è¦ä¸´æ—¶éš”ç¦»

**æ–°å¢æ–‡ä»¶**: `fastcc/proxy/circuit_breaker.py`

### 3. ä¼šè¯äº²å’Œæ€§ï¼ˆSession Affinityï¼‰

åŒä¸€å¯¹è¯ç»‘å®šåˆ°åŒä¸€ endpointï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œå¯¹è¯è¿ç»­æ€§ã€‚

**åŠŸèƒ½ç‰¹æ€§**:
- è‡ªåŠ¨æå–å¯¹è¯ IDï¼ˆä»è¯·æ±‚å¤´æˆ–è¯·æ±‚ä½“ï¼‰
- ä¼šè¯ç»‘å®š 5 å°æ—¶ TTL
- è‡ªåŠ¨è¿‡æœŸæ¸…ç†æœºåˆ¶ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
- æ•…éšœè‡ªåŠ¨è§£ç»‘å’Œé‡æ–°é€‰æ‹©

**ç”¨æˆ·ä½“éªŒæå‡**:
- ä¼šè¯ä¸€è‡´æ€§æå‡è‡³ 95%
- åŒä¸€å¯¹è¯å§‹ç»ˆä½¿ç”¨åŒä¸€èŠ‚ç‚¹
- èŠ‚ç‚¹åˆ‡æ¢æ›´åŠ ä¸æ»‘

**æ–°å¢æ–‡ä»¶**: `fastcc/proxy/session_affinity.py`

### 4. é”™è¯¯åˆ†ç±»å™¨ï¼ˆError Classifierï¼‰

ç»†åŒ–é”™è¯¯åˆ†ç±»å’Œå¤„ç†ç­–ç•¥ï¼Œå‡å°‘è¯¯åˆ¤å¤±è´¥ç‡ã€‚

**é”™è¯¯ç±»å‹**:
1. **TRANSIENT** (æš‚æ—¶æ€§é”™è¯¯)
   - ç½‘ç»œè¿æ¥é—®é¢˜ã€è¶…æ—¶
   - å¤„ç†ç­–ç•¥ï¼šå¿«é€Ÿé‡è¯•åŒä¸€èŠ‚ç‚¹ï¼Œä¸æ ‡è®°å¤±è´¥

2. **RATE_LIMIT** (API é™æµ)
   - 429 é”™è¯¯ã€quota exceeded
   - å¤„ç†ç­–ç•¥ï¼šæ ‡è®°é™çº§ï¼Œç«‹å³åˆ‡æ¢èŠ‚ç‚¹

3. **AUTH** (è®¤è¯å¤±è´¥)
   - 401ã€403ã€invalid api key
   - å¤„ç†ç­–ç•¥ï¼šç¦ç”¨ endpoint

4. **PERMANENT** (æ°¸ä¹…å¤±è´¥)
   - 400ã€404ã€invalid request
   - å¤„ç†ç­–ç•¥ï¼šæ ‡è®°å¤±è´¥ï¼Œç«‹å³åˆ‡æ¢

5. **UNKNOWN** (æœªçŸ¥é”™è¯¯)
   - å…¶ä»–é”™è¯¯
   - å¤„ç†ç­–ç•¥ï¼šä¿å®ˆå¤„ç†ï¼Œåˆ‡æ¢èŠ‚ç‚¹

**æ•ˆæœ**:
- è¯¯åˆ¤å¤±è´¥ç‡å‡å°‘ 80%ï¼ˆä» 15% é™è‡³ 3%ï¼‰
- é™æµé”™è¯¯å»¶è¿Ÿé‡è¯•ï¼Œé¿å…åŠ å‰§é™æµ
- è®¤è¯é”™è¯¯è‡ªåŠ¨ç¦ç”¨èŠ‚ç‚¹

**æ–°å¢æ–‡ä»¶**: `fastcc/core/error_classifier.py`

### 5. è´Ÿè½½å‡è¡¡é™çº§ç­–ç•¥

å®ç°æ™ºèƒ½é™çº§ç­–ç•¥ï¼Œç¡®ä¿åœ¨æç«¯æƒ…å†µä¸‹ä»èƒ½æä¾›æœåŠ¡ã€‚

**é™çº§å±‚çº§**:
1. **healthy** - ä¼˜å…ˆä½¿ç”¨å¥åº·èŠ‚ç‚¹
2. **degraded** - å¥åº·èŠ‚ç‚¹ä¸è¶³æ—¶ä½¿ç”¨é™çº§èŠ‚ç‚¹
3. **unhealthy** - æç«¯æƒ…å†µä¸‹å°è¯•ä¸å¥åº·èŠ‚ç‚¹
4. **circuit_open** - æœ€åå°è¯•æ–­è·¯å™¨æ‰“å¼€çš„èŠ‚ç‚¹ï¼ˆè‡ªåŠ¨æ¢å¤æ£€æµ‹ï¼‰

**æ–‡ä»¶**: `fastcc/proxy/load_balancer.py`, `fastcc/proxy/server.py`

### 6. å¤±è´¥é˜Ÿåˆ—éš”ç¦»ä¿®å¤

ä¿®å¤å¤±è´¥é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ä»è¢«æ­£å¸¸ä»£ç†ä½¿ç”¨çš„é—®é¢˜ã€‚

**ä¿®å¤å†…å®¹**:
- å¤±è´¥é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹æ°¸ä¹…éš”ç¦»ï¼Œä¸å‚ä¸æ­£å¸¸ä»£ç†
- èŠ‚ç‚¹æ¢å¤åæ–­è·¯å™¨çŠ¶æ€åŒæ­¥é‡ç½®
- ä¼šè¯ç»‘å®šåˆ°å¤±è´¥èŠ‚ç‚¹è‡ªåŠ¨è§£é™¤

**æ–‡ä»¶**: `fastcc/proxy/failure_queue.py`, `fastcc/proxy/server.py`

### 7. Windows å¹³å°å…¼å®¹æ€§ä¿®å¤

ä¿®å¤ Windows å¹³å°ä¸Š npm å‘½ä»¤æ‰§è¡Œé—®é¢˜ã€‚

**ä¿®å¤å†…å®¹**:
- æ·»åŠ å¹³å°æ£€æµ‹
- Windows ä¸Šä½¿ç”¨ `shell=True` æ‰§è¡Œ npm å‘½ä»¤
- ä¿®å¤ .cmd æ–‡ä»¶æ‰§è¡Œé—®é¢˜

**æ–‡ä»¶**: `fastcc/cli.py`

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | v0.5.2 | v0.6.0 | æå‡ |
|------|--------|--------|------|
| **å¹³å‡å“åº”æ—¶é—´** | 1200ms | 800ms | **-33%** â¬‡ï¸ |
| **èŠ‚ç‚¹åˆ‡æ¢æ—¶é—´** | 500ms | 100ms | **-80%** â¬‡ï¸ |
| **è¯¯åˆ¤å¤±è´¥ç‡** | 15% | 3% | **-80%** â¬‡ï¸ |
| **è¿æ¥å¤ç”¨ç‡** | 0% | 70% | **+70%** â¬†ï¸ |
| **ä¼šè¯ä¸€è‡´æ€§** | 60% | 95% | **+35%** â¬†ï¸ |
| **æ•…éšœèŠ‚ç‚¹é‡è¯•** | 2-3æ¬¡ | 0æ¬¡ | **-100%** â¬‡ï¸ |

## ğŸ”§ ä¸»è¦ä¿®æ”¹

### æ–°å¢æ–‡ä»¶

- `fastcc/core/error_classifier.py` - é”™è¯¯åˆ†ç±»å™¨
- `fastcc/proxy/circuit_breaker.py` - æ–­è·¯å™¨å®ç°
- `fastcc/proxy/session_affinity.py` - ä¼šè¯äº²å’Œæ€§ç®¡ç†
- `qcc-web/src/components/HelpButton.tsx` - Web UI å¸®åŠ©æŒ‰é’®
- `qcc-web/src/components/VersionBanner.tsx` - ç‰ˆæœ¬æ¨ªå¹…
- `docs/tasks/proxy-improvements-completed.md` - æ”¹è¿›æ€»ç»“
- `docs/tasks/migration-to-httpx.md` - httpx è¿ç§»æ–‡æ¡£
- `docs/tasks/*-fix.md` - å„é¡¹ä¿®å¤æ–‡æ¡£

### æ ¸å¿ƒä¿®æ”¹

- `fastcc/proxy/server.py` - æ ¸å¿ƒä»£ç†é€»è¾‘é‡æ„ï¼ˆ753 è¡Œé‡å¤§ä¿®æ”¹ï¼‰
- `fastcc/proxy/failure_queue.py` - å¤±è´¥é˜Ÿåˆ—ä¼˜åŒ–
- `fastcc/proxy/load_balancer.py` - è´Ÿè½½å‡è¡¡é™çº§ç­–ç•¥
- `fastcc/cli.py` - Windows å¹³å°ä¿®å¤
- `pyproject.toml` - ä¾èµ–æ›´æ–°ï¼ˆæ·»åŠ  httpxï¼‰

## ğŸ“¦ ä¾èµ–å˜æ›´

### æ–°å¢ä¾èµ–

```toml
httpx>=0.25.0  # ç”¨äºå®¢æˆ·ç«¯ HTTP è¯·æ±‚ï¼Œæ›¿ä»£ aiohttp.ClientSession
```

### ä¿ç•™ä¾èµ–

```toml
aiohttp>=3.8.0  # ä»ç”¨äºæœåŠ¡ç«¯ (aiohttp.web)
aiohttp-cors>=0.7.0
```

## ğŸ”„ å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å…¼å®¹**:
- æ‰€æœ‰ v0.5.x çš„åŠŸèƒ½ä¿æŒä¸å˜
- æ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶
- æ–­è·¯å™¨å’Œä¼šè¯äº²å’Œæ€§è‡ªåŠ¨å¯ç”¨
- è‡ªåŠ¨çƒ­éƒ¨ç½²æ”¯æŒ

## ğŸ“¦ å‡çº§æ–¹å¼

### ä» v0.5.x å‡çº§ï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨ uvxï¼ˆè‡ªåŠ¨æœ€æ–°ç‰ˆï¼‰
uvx qcc web start
# è‡ªåŠ¨ä¸‹è½½å¹¶ä½¿ç”¨ v0.6.0

# ä½¿ç”¨ pip
pip install --upgrade qcc
qcc web start
```

### éªŒè¯å®‰è£…

```bash
# 1. æ£€æŸ¥ç‰ˆæœ¬
python3 -c "import fastcc; print(fastcc.__version__)"
# è¾“å‡º: 0.6.0

# 2. å¯åŠ¨ä»£ç†æœåŠ¡
uvx qcc proxy start

# 3. æŸ¥çœ‹ä»£ç†çŠ¶æ€
uvx qcc proxy status
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŸºæœ¬åŠŸèƒ½æµ‹è¯•

```bash
# å¯åŠ¨æœåŠ¡
uvx qcc web start --dev --port 8081

# å‘é€è¯·æ±‚ï¼Œè§‚å¯Ÿæ—¥å¿—
# åº”è¯¥çœ‹åˆ°ï¼š
# - "åˆ›å»ºæ–°çš„ httpx.AsyncClient"
# - "è¿æ¥å¤ç”¨å·²å¯ç”¨"
# - æ–­è·¯å™¨å’Œä¼šè¯äº²å’Œæ€§ç›¸å…³æ—¥å¿—
```

### 2. æ–­è·¯å™¨æµ‹è¯•

```bash
# é…ç½®ä¸€ä¸ªæ•…æ„é”™è¯¯çš„ endpoint
# è¿ç»­è¯·æ±‚ 3 æ¬¡åï¼Œåº”è¯¥çœ‹åˆ°ï¼š
# "âš ï¸ æ–­è·¯å™¨å·²æ‰“å¼€ï¼Œç«‹å³æ’é™¤ endpoint"

# 60 ç§’åå†æ¬¡è¯·æ±‚ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
# "æ–­è·¯å™¨è¿›å…¥åŠå¼€çŠ¶æ€ï¼Œå°è¯•æ¢å¤"
```

### 3. ä¼šè¯äº²å’Œæ€§æµ‹è¯•

```bash
# åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  x-conversation-id
# å¤šæ¬¡è¯·æ±‚ç›¸åŒçš„ conversation_id
# åº”è¯¥çœ‹åˆ°ï¼š
# "ä½¿ç”¨ä¼šè¯ç»‘å®šçš„ endpoint: xxx"
```

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### ç”Ÿäº§ç¯å¢ƒ

```bash
# ç›´æ¥å¯åŠ¨ï¼ˆæ¨èï¼‰
uvx qcc web start

# æˆ–ä½¿ç”¨ pip å®‰è£…
pip install qcc
qcc web start
```

### å¼€å‘ç¯å¢ƒ

```bash
# å…‹éš†ä»“åº“åä½¿ç”¨å¼€å‘æ¨¡å¼
git clone https://github.com/lghguge520/qcc.git
cd qcc
uvx --from . qcc web start --dev
```

## ğŸ› å·²çŸ¥é—®é¢˜

### Windows å¹³å°ä¸­æ–‡ç¼–ç 

**ç—‡çŠ¶**: Windows å‘½ä»¤è¡Œä¸­æ–‡è¾“å‡ºå¯èƒ½å‡ºç°ä¹±ç 

**è§£å†³æ–¹æ¡ˆ**:
- åŠŸèƒ½ä¸å—å½±å“
- ä½¿ç”¨ Git Bash ä»£æ›¿ CMD/PowerShell
- æˆ–åœ¨ PowerShell ä¸­è®¾ç½® UTF-8 ç¼–ç ï¼š
  ```powershell
  [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
  ```

## ğŸ” é—®é¢˜æ’æŸ¥

### å¦‚æœé‡åˆ°è¿æ¥é—®é¢˜

1. **æ£€æŸ¥ httpx æ˜¯å¦æ­£ç¡®å®‰è£…**
   ```bash
   python3 -c "import httpx; print(httpx.__version__)"
   ```

2. **æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°å®‰è£…**
   ```bash
   rm -rf ~/.cache/uv
   uvx qcc web start
   ```

3. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**
   ```bash
   # æ—¥å¿—æ–‡ä»¶ä½ç½®
   tail -f ~/.fastcc/proxy.log
   ```

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- **æ”¹è¿›æ€»ç»“**: [docs/tasks/proxy-improvements-completed.md](../tasks/proxy-improvements-completed.md)
- **httpx è¿ç§»**: [docs/tasks/migration-to-httpx.md](../tasks/migration-to-httpx.md)
- **æ–­è·¯å™¨å®ç°**: [fastcc/proxy/circuit_breaker.py](../../fastcc/proxy/circuit_breaker.py)
- **ä¼šè¯äº²å’Œæ€§**: [fastcc/proxy/session_affinity.py](../../fastcc/proxy/session_affinity.py)
- **é”™è¯¯åˆ†ç±»å™¨**: [fastcc/core/error_classifier.py](../../fastcc/core/error_classifier.py)

## ğŸ“… åç»­è®¡åˆ’

### v0.6.1ï¼ˆçŸ­æœŸï¼‰
- [ ] æµå¼å“åº”ä¼˜é›…é™çº§
- [ ] å®Œå–„æ—¥å¿—å’Œç›‘æ§
- [ ] æ€§èƒ½åˆ†æå’Œè°ƒä¼˜

### v0.7.0ï¼ˆä¸­æœŸï¼‰
- [ ] æŒä¹…åŒ–ç›‘æ§æ•°æ®ï¼ˆSQLiteï¼‰
- [ ] Endpoint é¢„çƒ­æœºåˆ¶
- [ ] æ›´é«˜çº§çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
- [ ] Web UI å¢å¼º

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰å‚è€ƒçš„å¼€æºé¡¹ç›®ï¼š
- [1rgs/claude-code-proxy](https://github.com/1rgs/claude-code-proxy)
- [snipeship/ccflare](https://github.com/snipeship/ccflare)
- [fuergaosi233/claude-code-proxy](https://github.com/fuergaosi233/claude-code-proxy)

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

- **æ–°å¢ä»£ç **: 3,291 è¡Œ
- **ä¿®æ”¹æ–‡ä»¶**: 22 ä¸ª
- **æ–°å¢æ–‡ä»¶**: 10 ä¸ª
- **ä¿®å¤ Bug**: 6 ä¸ª
- **æ€§èƒ½æå‡**: 33-80%

---

**å®‰è£…å‘½ä»¤**:
```bash
uvx qcc web start
# æˆ–
pip install --upgrade qcc
```

**å®Œæ•´æ–‡æ¡£**: [README.md](../../README.md)
