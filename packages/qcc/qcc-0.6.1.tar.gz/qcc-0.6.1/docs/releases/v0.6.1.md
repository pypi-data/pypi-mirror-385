# QCC v0.6.1 发布说明

**发布日期**: 2025-10-19
**类型**: Bug 修复版本
**重要性**: 🔴 关键更新（v0.6.0 用户必须升级）

## 🐛 Bug 修复

### 修复自定义端口时前端 API 地址不匹配问题

这是一个**关键 bug 修复**，解决了 v0.6.0 中指定自定义端口后前端无法连接后端 API 的问题。

#### 问题描述

**症状**:
```bash
uvx qcc web start --port 8081

# 后端启动在 8081，但前端仍然请求 8080
# 浏览器控制台错误：
# Failed to fetch http://127.0.0.1:8080/api/...
# ERR_CONNECTION_REFUSED
```

**根本原因**:
- 前端静态文件在构建时硬编码了 API 地址为 `http://127.0.0.1:8080`
- 用户指定 `--port 8081` 时，后端在 8081 启动
- 但前端静态文件中的 API 地址仍是 8080，导致所有 API 请求失败

**影响范围**:
- v0.6.0 版本使用自定义端口时，Web UI 完全无法使用
- 默认端口 8080 不受影响

#### 修复方案

**文件**: `qcc-web/src/api/client.ts`

**修改内容**:

**修复前**（硬编码）:
```typescript
const BASE_URL = import.meta.env.VITE_API_URL || 'http://127.0.0.1:8080';
```

**修复后**（动态获取）:
```typescript
// API 基础 URL
// 生产模式：使用当前页面的 origin（前后端同源）
// 开发模式：使用环境变量或默认值（通过 vite proxy 转发）
const BASE_URL = import.meta.env.PROD
  ? window.location.origin  // 生产模式：使用当前页面地址
  : (import.meta.env.VITE_API_URL || 'http://127.0.0.1:8080');  // 开发模式：使用代理
```

#### 工作原理

**生产模式** (`uvx qcc` 或 `pip install qcc`):
- 前端使用 `window.location.origin` 动态获取当前页面地址
- 例如：用户访问 `http://127.0.0.1:8081`，API 地址自动为 `http://127.0.0.1:8081`
- 完全适配任何端口，无需额外配置

**开发模式** (`qcc web start --dev`):
- 前端开发服务器在 5173，使用 vite proxy 转发到后端
- 保持原有的开发体验不变

#### 验证

修复后，自定义端口正常工作：

```bash
# 测试自定义端口
uvx qcc web start --port 8081

# 浏览器访问：http://127.0.0.1:8081
# API 请求自动发送到：http://127.0.0.1:8081/api/...
# ✅ 正常工作
```

## 📦 关于前端构建

### 问题 2：每次发布是否自动构建前端？

**当前流程**:
- ❌ 发布时**不会**自动构建前端
- ✅ 发布包中包含**预构建的**前端静态文件
- ⚠️ 如果前端代码有变更，需要**手动构建**

**手动构建步骤**:
```bash
# 1. 进入前端目录
cd qcc-web

# 2. 安装依赖（首次或依赖更新时）
npm install

# 3. 构建前端
npm run build

# 4. 复制到打包目录
cd ..
rm -rf fastcc/web/static/*
cp -r qcc-web/dist/* fastcc/web/static/

# 5. 现在可以发布
python -m build
python -m twine upload dist/*
```

**推荐发布流程**（v0.6.1 使用的流程）:
```bash
# 一步到位的发布命令（未来会添加到脚本中）
cd qcc-web && npm run build && cd .. && \
rm -rf fastcc/web/static/* && \
cp -r qcc-web/dist/* fastcc/web/static/ && \
git add -A && \
git commit -m "build: rebuild frontend for v0.6.1" && \
python -m build
```

## 🔄 向后兼容性

✅ **完全兼容**:
- 所有 v0.6.0 的功能保持不变
- 仅修复了自定义端口问题
- 无需修改配置或数据

## 📦 升级方式

### 从 v0.6.0 升级（强烈推荐）

```bash
# 使用 uvx（自动最新版）
uvx qcc web start
# 自动下载并使用 v0.6.1

# 使用 pip
pip install --upgrade qcc
qcc web start
```

### 验证安装

```bash
# 1. 检查版本
python3 -c "import fastcc; print(fastcc.__version__)"
# 输出: 0.6.1

# 2. 测试自定义端口
uvx qcc web start --port 8081

# 3. 浏览器访问 http://127.0.0.1:8081
# 4. 检查浏览器控制台，应该没有连接错误
```

## 🎯 受影响的功能

### 直接修复
- ✅ 自定义端口功能
- ✅ Web UI API 连接
- ✅ 所有 Web UI 功能

### 未受影响
- ✅ 默认端口 8080
- ✅ 代理服务器功能
- ✅ CLI 命令
- ✅ v0.6.0 的所有核心特性（httpx、断路器、会话亲和性等）

## 💡 使用建议

### 生产环境

```bash
# 默认端口（推荐）
uvx qcc web start

# 自定义端口（现已修复）
uvx qcc web start --port 8081
uvx qcc web start --port 3000
uvx qcc web start --host 0.0.0.0 --port 80  # 公网访问
```

### 开发环境

```bash
# 开发模式（前端热重载）
git clone https://github.com/lghguge520/qcc.git
cd qcc
uvx --from . qcc web start --dev
```

## 📊 包大小

- **Wheel**: ~4.2 MB（与 v0.6.0 相同）
- **Source**: ~20.2 MB（与 v0.6.0 相同）

## 🙏 致谢

感谢用户及时发现并反馈问题！

## 📅 v0.6.0 核心特性回顾

v0.6.1 保留了 v0.6.0 的所有核心改进：

- ✅ **httpx 迁移** - 性能提升 33%
- ✅ **断路器模式** - 节点切换速度提升 80%
- ✅ **会话亲和性** - 会话一致性提升至 95%
- ✅ **错误分类器** - 误判率降低 80%
- ✅ **负载均衡降级** - 智能降级策略
- ✅ **失败队列隔离** - 节点恢复优化
- ✅ **Windows 兼容** - npm 命令修复

## 🔍 问题排查

### 如果仍然遇到连接问题

1. **清除浏览器缓存**
   ```bash
   # 硬刷新：Ctrl+Shift+R (Windows/Linux)
   # 或 Cmd+Shift+R (Mac)
   ```

2. **检查端口占用**
   ```bash
   # Windows
   netstat -ano | findstr :8081

   # Linux/Mac
   lsof -i :8081
   ```

3. **查看浏览器控制台**
   - F12 打开开发者工具
   - 查看 Console 和 Network 标签
   - 确认 API 请求地址是否正确

4. **检查版本**
   ```bash
   python3 -c "import fastcc; print(fastcc.__version__)"
   # 应该显示 0.6.1
   ```

---

**安装命令**:
```bash
uvx qcc web start
# 或
pip install --upgrade qcc
```

**完整文档**: [README.md](../../README.md)
**v0.6.0 发布说明**: [v0.6.0.md](./v0.6.0.md)
