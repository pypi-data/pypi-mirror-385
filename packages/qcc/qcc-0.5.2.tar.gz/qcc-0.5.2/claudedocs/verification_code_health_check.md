# éªŒè¯ç å¥åº·æ£€æŸ¥æœºåˆ¶

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### åŸå§‹é—®é¢˜
æŸäº› API æœåŠ¡å™¨ï¼ˆå¦‚ 88code.orgï¼‰åœ¨ API Key è¢«ç¦ç”¨æ—¶ï¼Œè¿”å›çš„æ˜¯ï¼š
- **HTTP 200** çŠ¶æ€ç ï¼ˆè€Œä¸æ˜¯æ ‡å‡†çš„ 401/403ï¼‰
- **é”™è¯¯ä¿¡æ¯åœ¨ JSON body ä¸­**ï¼š`{"error": {"type": "Bad Request", "message": "..."}}`

è¿™å¯¼è‡´ QCC çš„å¥åº·æ£€æŸ¥å°†å…¶è¯¯åˆ¤ä¸ºæˆåŠŸï¼Œå› ä¸ºï¼š
1. HTTP çŠ¶æ€ç æ˜¯ 200
2. æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸
3. åŸæœ‰é€»è¾‘ç›´æ¥è®¤ä¸º 200 = æˆåŠŸ

### æŒ‘æˆ˜
ä¸åŒçš„ API æœåŠ¡å™¨é”™è¯¯æ ¼å¼å„å¼‚ï¼š
- æ ‡å‡† Anthropicï¼šè¿”å› HTTP 401/403
- æŸäº›ä»£ç†ï¼šè¿”å› HTTP 200 + `{"error": {...}}`
- å…¶ä»–æœåŠ¡ï¼šå¯èƒ½è¿”å›å…¶ä»–æ ¼å¼

éœ€è¦ä¸€ä¸ª**é€šç”¨çš„éªŒè¯æœºåˆ¶**ï¼Œä¸ä¾èµ–ç‰¹å®šçš„é”™è¯¯æ ¼å¼æˆ– HTTP çŠ¶æ€ç ã€‚

## ğŸ¯ è§£å†³æ–¹æ¡ˆï¼šéªŒè¯ç æœºåˆ¶

### æ ¸å¿ƒæ€è·¯
**ç”¨æˆ·å»ºè®®**ï¼šè®© AI åœ¨å“åº”ä¸­å›å¤ä¸€ä¸ªéšæœºéªŒè¯ç ï¼Œé€šè¿‡æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«è¯¥éªŒè¯ç æ¥åˆ¤æ–­æ˜¯å¦çœŸæ­£æˆåŠŸã€‚

### æœºåˆ¶è®¾è®¡

#### 1. ç”ŸæˆéšæœºéªŒè¯ç 
æ¯æ¬¡å¥åº·æ£€æŸ¥æ—¶ç”Ÿæˆ 6 ä½éšæœºå­—æ¯æ•°å­—ç»„åˆï¼š
```python
verification_code = ''.join(
    random.choices('ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789', k=6)
)
# ä¾‹å¦‚: "A1B2C3", "XYZ789", "TEST99"
```

#### 2. å‘é€éªŒè¯è¯·æ±‚
å°†éªŒè¯ç åµŒå…¥æµ‹è¯•æ¶ˆæ¯ï¼š
```python
test_message = f"æ”¶åˆ°æ¶ˆæ¯è¯·ä»…å›å¤è¿™ä¸ªéªŒè¯ç ï¼š{verification_code}"
```

#### 3. éªŒè¯å“åº”
æ£€æŸ¥ AI çš„å“åº”æ˜¯å¦åŒ…å«éªŒè¯ç ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼š
```python
def _validate_response(verification_code: str, response: str) -> bool:
    if not response or not verification_code:
        return False
    return verification_code.upper() in response.upper()
```

### éªŒè¯é€»è¾‘æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”ŸæˆéªŒè¯ç : "ABC123"                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‘é€è¯·æ±‚:                                             â”‚
â”‚    "æ”¶åˆ°æ¶ˆæ¯è¯·ä»…å›å¤è¿™ä¸ªéªŒè¯ç ï¼šABC123"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ¥æ”¶å“åº”                                              â”‚
â”‚                                                          â”‚
â”‚    æ­£å¸¸æƒ…å†µ: "ABC123" æˆ– "å¥½çš„ï¼ŒéªŒè¯ç æ˜¯ï¼šABC123"        â”‚
â”‚    é”™è¯¯æƒ…å†µ: "" æˆ– "API key is disabled" æˆ–å…¶ä»–          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. éªŒè¯                                                  â”‚
â”‚                                                          â”‚
â”‚    æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å« "ABC123" (ä¸åŒºåˆ†å¤§å°å†™)            â”‚
â”‚    â€¢ åŒ…å« â†’ response_valid = True                        â”‚
â”‚    â€¢ ä¸åŒ…å« â†’ response_valid = False                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š å®æµ‹æ•ˆæœ

### æµ‹è¯•åœºæ™¯ 1ï¼šè¢«ç¦ç”¨çš„ API Key

**é…ç½®**ï¼š
```python
base_url = "https://www.88code.org/api"
api_key = "88_3b5c724a7ce3e94496409e5294fa4414eac5266c03ba74ce6361aa2d15d6101d"
```

**ç»“æœ**ï¼š
```
HTTP çŠ¶æ€ç : 200
å“åº”å†…å®¹: ''  (ç©ºå­—ç¬¦ä¸²)
éªŒè¯ç : 5MKY9D
å“åº”ä¸­åŒ…å«éªŒè¯ç : False
response_valid: False  âœ…

ç»“è®º: è¢«æ­£ç¡®è¯†åˆ«ä¸ºæ— æ•ˆï¼
```

### æµ‹è¯•åœºæ™¯ 2ï¼šæ­£å¸¸çš„ API Key

**é…ç½®**ï¼š
```python
base_url = "https://jp.duckcoding.com"
api_key = "sk-7yVW8CrBSuYvV3sKdzHFS42sGS1TXTbiWWTjtHwv26QHl12j"
```

**ç»“æœ**ï¼š
```
HTTP çŠ¶æ€ç : 200
å“åº”å†…å®¹: 'EHPLSP'
éªŒè¯ç : EHPLSP
å“åº”ä¸­åŒ…å«éªŒè¯ç : True
response_valid: True  âœ…

ç»“è®º: éªŒè¯æˆåŠŸï¼
```

## ğŸ”§ å®ç°ç»†èŠ‚

### ä¿®æ”¹çš„æ–‡ä»¶

#### 1. [fastcc/proxy/conversational_checker.py](../fastcc/proxy/conversational_checker.py)

**å˜æ›´å†…å®¹**ï¼š

**a) ç§»é™¤å›ºå®šæµ‹è¯•æ¶ˆæ¯åˆ—è¡¨**
```python
# åˆ é™¤å‰
self.test_messages = [
    "æ”¶åˆ°æ¶ˆæ¯è¯·å›å¤ 1",
    "ä½ å¥½ï¼Œè¯·å›å¤ç¡®è®¤",
    # ... æ›´å¤šæ¶ˆæ¯
]

# åˆ é™¤å
# ä¸å†éœ€è¦ï¼Œæ¯æ¬¡åŠ¨æ€ç”Ÿæˆ
```

**b) åŠ¨æ€ç”ŸæˆéªŒè¯ç **
```python
# åœ¨ check_endpoint() ä¸­
verification_code = ''.join(
    random.choices('ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789', k=6)
)
check.test_message = f"æ”¶åˆ°æ¶ˆæ¯è¯·ä»…å›å¤è¿™ä¸ªéªŒè¯ç ï¼š{verification_code}"
check.verification_code = verification_code
```

**c) ç®€åŒ–éªŒè¯é€»è¾‘**
```python
# ä¿®æ”¹å‰ï¼šå¤æ‚çš„è§„åˆ™åŒ¹é…
def _validate_response(self, test_message: str, response: str) -> bool:
    if "å›å¤ 1" in test_message:
        return '1' in response or 'one' in response
    if "1+1" in test_message:
        return '2' in response
    # ... æ›´å¤šè§„åˆ™

# ä¿®æ”¹åï¼šç®€å•çš„éªŒè¯ç æ£€æŸ¥
def _validate_response(self, verification_code: str, response: str) -> bool:
    if not response or not verification_code:
        return False
    return verification_code.upper() in response.upper()
```

**d) å…¼å®¹å¤šç§å“åº”æ ¼å¼**
```python
# æ”¯æŒä¸åŒçš„ JSON å“åº”æ ¼å¼
if 'content' in data and data['content']:
    content = data['content'][0].get('text', '')
elif 'message' in data:
    content = data['message']
elif 'text' in data:
    content = data['text']
```

#### 2. [fastcc/proxy/health_check_models.py](../fastcc/proxy/health_check_models.py)

**æ–°å¢å­—æ®µ**ï¼š
```python
class ConversationalHealthCheck:
    def __init__(self, endpoint_id: str):
        # ... å…¶ä»–å­—æ®µ
        self.verification_code: Optional[str] = None  # æ–°å¢
```

### å¢åŠ  max_tokens

```python
# ä» 10 å¢åŠ åˆ° 20ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´è¿”å›éªŒè¯ç 
self.max_tokens = 20
```

## âœ… æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

[tests/test_verification_logic.py](../tests/test_verification_logic.py) - 7 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

1. âœ… `test_validate_response_basic` - åŸºæœ¬éªŒè¯
2. âœ… `test_validate_response_case_insensitive` - ä¸åŒºåˆ†å¤§å°å†™
3. âœ… `test_validate_response_embedded` - åµŒå…¥æ–‡æœ¬ä¸­
4. âœ… `test_validate_response_invalid` - æ— æ•ˆæƒ…å†µ
5. âœ… `test_validate_response_edge_cases` - è¾¹ç•Œæƒ…å†µ
6. âœ… `test_verification_code_format` - éªŒè¯ç æ ¼å¼
7. âœ… `test_real_world_scenarios` - çœŸå®åœºæ™¯

**æµ‹è¯•ç»“æœ**ï¼š
```bash
$ uvx -n pytest tests/test_verification_logic.py -v

============================= test session starts =============================
tests/test_verification_logic.py::test_validate_response_basic PASSED    [ 14%]
tests/test_verification_logic.py::test_validate_response_case_insensitive PASSED [ 28%]
tests/test_verification_logic.py::test_validate_response_embedded PASSED [ 42%]
tests/test_verification_logic.py::test_validate_response_invalid PASSED  [ 57%]
tests/test_verification_logic.py::test_validate_response_edge_cases PASSED [ 71%]
tests/test_verification_logic.py::test_verification_code_format PASSED   [ 85%]
tests/test_verification_logic.py::test_real_world_scenarios PASSED       [100%]

============================== 7 passed in 0.04s ==============================
```

## ğŸŒŸ ä¼˜åŠ¿

### 1. **é€šç”¨æ€§å¼º**
- âœ… ä¸ä¾èµ–ç‰¹å®šçš„ HTTP çŠ¶æ€ç 
- âœ… ä¸ä¾èµ–ç‰¹å®šçš„é”™è¯¯æ ¼å¼
- âœ… é€‚ç”¨äºå„ç§ API æœåŠ¡å™¨å®ç°
- âœ… æ”¯æŒå„ç§ä»£ç†å’Œè½¬å‘æœåŠ¡

### 2. **å¯é æ€§é«˜**
- âœ… éªŒè¯çœŸå®çš„ AI å“åº”èƒ½åŠ›
- âœ… é¿å… HTTP 200 + é”™è¯¯ body çš„é™·é˜±
- âœ… å‡†ç¡®è¯†åˆ«è¢«ç¦ç”¨/æ— æ•ˆçš„ API Key
- âœ… ä¸ä¼šè¢«ç¼“å­˜å“åº”å¹²æ‰°ï¼ˆæ¯æ¬¡éªŒè¯ç ä¸åŒï¼‰

### 3. **å®ç°ç®€å•**
- âœ… é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… ä»£ç é‡å‡å°‘ï¼ˆåˆ é™¤å¤æ‚çš„è§„åˆ™åŒ¹é…ï¼‰
- âœ… æµ‹è¯•ç”¨ä¾‹ç®€å•ç›´è§‚
- âœ… æ€§èƒ½å¼€é”€ä½ï¼ˆç®€å•çš„å­—ç¬¦ä¸²åŒ…å«æ£€æŸ¥ï¼‰

### 4. **å®‰å…¨æ€§å¥½**
- âœ… æ¯æ¬¡ä½¿ç”¨ä¸åŒçš„éªŒè¯ç 
- âœ… é¿å…å›ºå®šæ¨¡å¼è¢«é¢„æµ‹æˆ–ç¼“å­˜
- âœ… 6 ä½å­—æ¯æ•°å­— = 36^6 = 2,176,782,336 ç§å¯èƒ½
- âœ… ç¢°æ’æ¦‚ç‡æä½

## ğŸ“ˆ æ€§èƒ½å½±å“

### Token ä½¿ç”¨
- **ä¹‹å‰**ï¼š`max_tokens: 10`
- **ç°åœ¨**ï¼š`max_tokens: 20`
- **å¢åŠ **ï¼š10 tokens/è¯·æ±‚ï¼ˆç”¨äºè¿”å›éªŒè¯ç ï¼‰
- **æˆæœ¬å½±å“**ï¼šå‡ ä¹å¯å¿½ç•¥ï¼ˆå¥åº·æ£€æŸ¥ä½¿ç”¨æœ€ä¾¿å®œçš„ haiku æ¨¡å‹ï¼‰

### å“åº”æ—¶é—´
- **æ— æ˜¾è‘—å½±å“**ï¼šéªŒè¯ç éªŒè¯æ˜¯ç®€å•çš„å­—ç¬¦ä¸²åŒ…å«æ£€æŸ¥ï¼ˆO(n)ï¼‰
- **å®æµ‹**ï¼š< 1msï¼ˆå¯å¿½ç•¥ï¼‰

## ğŸ¯ é€‚ç”¨åœºæ™¯

### å®Œç¾é€‚ç”¨
âœ… æ‰€æœ‰ Claude API å…¼å®¹æœåŠ¡
âœ… å„ç§ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨
âœ… è‡ªå®šä¹‰ API endpoint
âœ… éœ€è¦éªŒè¯çœŸå® AI èƒ½åŠ›çš„åœºæ™¯

### ä¸é€‚ç”¨
âŒ é AI å¯¹è¯ APIï¼ˆå¦‚çº¯ REST APIï¼‰
âŒ ä¸æ”¯æŒå¯¹è¯çš„æœåŠ¡

## ğŸ”„ å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**
- ä¸å½±å“ç°æœ‰çš„ endpoint é…ç½®
- ä¸æ”¹å˜å¥åº·æ£€æŸ¥çš„è°ƒç”¨æ–¹å¼
- åªæ˜¯æ”¹è¿›äº†å†…éƒ¨éªŒè¯é€»è¾‘
- å¯¹ç”¨æˆ·é€æ˜

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### å¥åº·æ£€æŸ¥æ—¥å¿—ç¤ºä¾‹

**æˆåŠŸçš„å¥åº·æ£€æŸ¥**ï¼š
```log
[health_check] Endpoint 1e3e69eb å¥åº·æ£€æŸ¥æˆåŠŸ (1824ms, è¯„åˆ†: 80)
  æµ‹è¯•æ¶ˆæ¯: æ”¶åˆ°æ¶ˆæ¯è¯·ä»…å›å¤è¿™ä¸ªéªŒè¯ç ï¼šEHPLSP
  å“åº”å†…å®¹: EHPLSP
  å“åº”æœ‰æ•ˆ: True
```

**å¤±è´¥çš„å¥åº·æ£€æŸ¥**ï¼š
```log
[health_check] Endpoint 71de8865 å¥åº·æ£€æŸ¥æˆåŠŸ (686ms, è¯„åˆ†: 20)
  æµ‹è¯•æ¶ˆæ¯: æ”¶åˆ°æ¶ˆæ¯è¯·ä»…å›å¤è¿™ä¸ªéªŒè¯ç ï¼š5MKY9D
  å“åº”å†…å®¹: (ç©º)
  å“åº”æœ‰æ•ˆ: False
  â†’ è¢«è¯†åˆ«ä¸ºæ— æ•ˆ endpoint
```

## ğŸš€ æœªæ¥å¢å¼º

### å¯èƒ½çš„æ”¹è¿›æ–¹å‘

1. **å¯é…ç½®çš„éªŒè¯ç é•¿åº¦**
   ```python
   verification_code_length: int = 6  # å¯é…ç½®
   ```

2. **å¤šè¯­è¨€æ”¯æŒ**
   ```python
   test_messages = {
       'en': f"Reply with this code: {code}",
       'zh': f"æ”¶åˆ°æ¶ˆæ¯è¯·ä»…å›å¤è¿™ä¸ªéªŒè¯ç ï¼š{code}",
       'ja': f"ã“ã®ã‚³ãƒ¼ãƒ‰ã§è¿”ä¿¡ã—ã¦ãã ã•ã„ï¼š{code}"
   }
   ```

3. **éªŒè¯ç å¤æ‚åº¦ç­‰çº§**
   ```python
   # ç®€å•ï¼šçº¯æ•°å­—
   # ä¸­ç­‰ï¼šå­—æ¯æ•°å­—
   # å¤æ‚ï¼šå­—æ¯æ•°å­—+ç‰¹æ®Šå­—ç¬¦
   ```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¥åº·æ£€æŸ¥æœºåˆ¶è¯´æ˜](./health_check_explained.md)
- [Endpoint ç¨³å®š ID ä¿®å¤](./endpoint_stable_id_fix.md)
- [HTTP 504 é”™è¯¯è¯Šæ–­æŒ‡å—](./http_504_error_guide.md)

---

**ä¿®å¤æ—¥æœŸ**: 2025-10-17
**ç‰ˆæœ¬**: v0.4.2-dev
**æµ‹è¯•çŠ¶æ€**: âœ… 7/7 æµ‹è¯•é€šè¿‡
**æå‡ºè€…**: ç”¨æˆ·å»ºè®®
**å®ç°**: Claude + QCC Team
