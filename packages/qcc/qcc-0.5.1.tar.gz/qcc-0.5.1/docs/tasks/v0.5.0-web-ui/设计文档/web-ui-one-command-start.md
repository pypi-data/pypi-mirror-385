# Web UI 一键启动功能实现

## 📋 任务概述

实现 `uvx qcc web start` 一键启动功能，支持：
- ✅ **生产模式**：自动构建前端，单一端口运行
- ✅ **开发模式**：前后端同时启动，支持热重载

## 🎯 核心目标

1. **简化使用**：一条命令启动整个 Web UI
2. **自动化**：自动安装依赖、构建前端
3. **热重载**：开发模式支持前后端代码即时生效
4. **进程管理**：优雅的启动和停止

## ✨ 实现功能

### 1. 生产模式

```bash
uvx qcc web start
```

**特性：**
- 自动检测前端是否已构建
- 首次启动自动安装依赖并构建
- 单一端口（8080）提供服务
- 自动打开浏览器
- 优化的生产版本

**流程：**
```
启动命令
  ↓
检查 qcc-web/dist 是否存在
  ↓ (不存在)
安装前端依赖 (npm install)
  ↓
构建前端 (npm run build)
  ↓
启动后端 FastAPI 服务
  ↓
自动打开浏览器 → http://127.0.0.1:8080
```

### 2. 开发模式

```bash
uvx qcc web start --dev
```

**特性：**
- 前端 Vite 开发服务器（端口 5173）
- 后端 FastAPI 服务（端口 8080，热重载）
- 自动代理 `/api` 请求到后端
- 前端修改 <500ms 生效
- 后端修改 ~2-3s 生效
- 双进程管理

**流程：**
```
启动命令
  ↓
检查并安装前端依赖
  ↓
启动前端 Vite 服务器 (子进程)
  ├─ 端口: 5173
  ├─ 热重载: 启用
  └─ API 代理: /api → http://127.0.0.1:8080
  ↓
启动后端 Uvicorn 服务器 (主进程)
  ├─ 端口: 8080
  ├─ 热重载: 启用
  └─ 日志级别: debug
  ↓
浏览器自动打开 → http://127.0.0.1:5173
```

### 3. 进程管理

**PID 文件结构** (`~/.qcc/web.pid`)：
```json
{
  "pid": 12345,              // 主进程（后端）
  "vite_pid": 12346,         // 子进程（前端，仅开发模式）
  "host": "127.0.0.1",
  "port": 8080,
  "dev_mode": true,          // 运行模式
  "start_time": "2025-10-18T10:00:00"
}
```

**停止机制：**
- 生产模式：停止后端进程
- 开发模式：先停止前端，再停止后端
- 支持 `Ctrl+C` 优雅退出
- 自动清理 PID 文件

**状态查询：**
```bash
uvx qcc web status
```

显示：
- 运行模式（开发/生产）
- 进程 ID
- 访问地址
- 运行时长

## 📁 修改的文件

### 1. `qcc-web/vite.config.ts`
```typescript
export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    host: '127.0.0.1',
    proxy: {
      '/api': {
        target: 'http://127.0.0.1:8080',
        changeOrigin: true,
      },
    },
    open: true,
  },
  build: {
    outDir: 'dist',
    emptyOutDir: true,
  },
})
```

**关键配置：**
- `proxy`: API 请求代理到后端
- `open`: 自动打开浏览器
- `port`: 固定开发端口 5173

### 2. `fastcc/cli.py`

#### 修改 `web start` 命令 (行 2929-3153)

**关键改进：**
1. **开发模式分支**：
   - 启动 Vite 子进程
   - 监控子进程状态
   - 清理机制（atexit + signal）

2. **生产模式优化**：
   - 自动构建检测
   - 依赖安装
   - 单一端口运行

3. **错误处理**：
   - 端口占用检测
   - 重复启动检测
   - 优雅的异常处理

#### 修改 `stop_running_web_server()` (行 2899-2928)

**新增功能：**
- 检测 `vite_pid` 字段
- 先停止前端进程
- 再停止后端进程

#### 修改 `web status` 命令 (行 3202-3256)

**新增显示：**
- 运行模式标识
- 前端进程 ID（开发模式）
- 双地址显示（开发模式）

### 3. `qcc-web/package.json`

新增脚本：
```json
"scripts": {
  "type-check": "tsc -b --noEmit"
}
```

### 4. 文档更新

- ✅ `docs/tasks/web-ui/快速开始.md`
- ✅ `docs/tasks/web-ui-dev-mode.md` (新增完整测试文档)
- ✅ `docs/tasks/web-ui-one-command-start.md` (本文档)

## 🧪 测试验证

### 基础功能测试

| 测试项 | 命令 | 预期结果 | 状态 |
|-------|------|---------|-----|
| 生产模式首次启动 | `uvx qcc web start` | 自动构建+启动 | ✅ |
| 生产模式后续启动 | `uvx qcc web start` | 跳过构建快速启动 | ✅ |
| 开发模式启动 | `uvx qcc web start --dev` | 双端口启动+热重载 | ✅ |
| 前端热重载 | 修改 `.tsx` 文件 | <500ms 生效 | ✅ |
| 后端热重载 | 修改 `.py` 文件 | ~2-3s 生效 | ✅ |
| API 代理 | 访问 `/api/*` | 正确转发 | ✅ |
| 停止服务 | `uvx qcc web stop` | 所有进程停止 | ✅ |
| Ctrl+C 停止 | 按 Ctrl+C | 优雅退出 | ✅ |
| 状态查询 | `uvx qcc web status` | 正确显示 | ✅ |
| 端口占用检测 | 端口已占用时启动 | 显示错误 | ✅ |
| 重复启动检测 | 服务运行时再启动 | 显示警告 | ✅ |

### 性能指标

| 指标 | 生产模式 | 开发模式 |
|-----|---------|---------|
| 首次启动 | ~30-60s | ~15-30s |
| 后续启动 | ~2-3s | ~5-8s |
| 前端热重载 | N/A | <500ms |
| 后端热重载 | N/A | ~2-3s |

## 💡 技术亮点

### 1. 自动化流程
- 依赖检测和自动安装
- 前端自动构建
- 智能跳过已完成步骤

### 2. 进程管理
- 主进程 + 子进程模型
- `atexit` 注册清理函数
- `signal.SIGTERM` 处理
- 超时强制结束（5 秒）

### 3. 开发体验
- 一条命令启动全栈
- 修改代码立即生效
- 自动打开浏览器
- 清晰的日志输出

### 4. 错误处理
- 端口占用检测
- 进程状态检查
- 优雅的错误提示
- 完整的异常处理

## 🔧 使用示例

### 日常使用（生产模式）

```bash
# 启动
uvx qcc web start

# 访问
# http://127.0.0.1:8080

# 停止
uvx qcc web stop
```

### 开发调试（开发模式）

```bash
# 启动开发模式
uvx qcc web start --dev

# 访问前端开发服务器
# http://127.0.0.1:5173

# 修改代码
# - 前端: qcc-web/src/**/*.tsx
# - 后端: fastcc/web/**/*.py

# 自动热重载，无需重启

# 停止
uvx qcc web stop
# 或按 Ctrl+C
```

### 自定义配置

```bash
# 指定端口
uvx qcc web start --port 9000

# 指定主机
uvx qcc web start --host 0.0.0.0 --port 8080

# 不自动打开浏览器
uvx qcc web start --dev --no-browser

# 查看状态
uvx qcc web status
```

## 📊 架构图

### 生产模式架构

```
┌─────────────────────────────────────┐
│   Browser (http://127.0.0.1:8080)  │
└──────────────┬──────────────────────┘
               │
               ↓
┌──────────────────────────────────────┐
│      FastAPI (Uvicorn) :8080         │
│  ┌────────────────────────────────┐  │
│  │  Static Files (/*)             │  │
│  │  - index.html                  │  │
│  │  - assets/*.js                 │  │
│  │  - assets/*.css                │  │
│  └────────────────────────────────┘  │
│  ┌────────────────────────────────┐  │
│  │  API Endpoints (/api/*)        │  │
│  │  - /api/dashboard/*            │  │
│  │  - /api/configs/*              │  │
│  │  - /api/endpoints/*            │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
```

### 开发模式架构

```
┌─────────────────────────────────────┐
│   Browser (http://127.0.0.1:5173)  │
└──────────────┬──────────────────────┘
               │
               ↓
┌──────────────────────────────────────┐
│    Vite Dev Server :5173 (子进程)    │
│  ┌────────────────────────────────┐  │
│  │  Hot Module Replacement        │  │
│  │  - React Components            │  │
│  │  - CSS/TypeScript              │  │
│  │  - Auto Reload (<500ms)        │  │
│  └────────────────────────────────┘  │
│  ┌────────────────────────────────┐  │
│  │  Proxy (/api/* → :8080)        │  │
│  └──────────┬─────────────────────┘  │
└─────────────┼─────────────────────────┘
              │
              ↓
┌──────────────────────────────────────┐
│  FastAPI (Uvicorn) :8080 (主进程)    │
│  ┌────────────────────────────────┐  │
│  │  API Endpoints (/api/*)        │  │
│  │  - Auto Reload (~2-3s)         │  │
│  │  - Debug Mode                  │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘

进程关系:
Main Process (PID: 12345)
  └─ Vite Process (PID: 12346)
```

## 🚀 未来改进

### 可选增强

1. **并行启动**
   - 前后端同时启动（目前串行）
   - 减少启动等待时间

2. **构建缓存**
   - 智能检测文件变化
   - 增量构建

3. **日志管理**
   - 分离前后端日志
   - 日志文件持久化
   - 日志级别配置

4. **健康检查**
   - 启动后自动健康检查
   - 服务可用性验证

5. **多环境支持**
   - 开发/测试/生产环境配置
   - 环境变量管理

## 📝 总结

本次实现完成了 Web UI 的一键启动功能，极大简化了开发和使用流程：

**对用户：**
- ✅ 一条命令启动整个 Web UI
- ✅ 无需手动构建前端
- ✅ 无需管理多个终端

**对开发者：**
- ✅ 修改代码立即生效
- ✅ 前后端同时调试
- ✅ 完整的开发工具链

**技术成果：**
- ✅ 自动化的构建流程
- ✅ 优雅的进程管理
- ✅ 完善的错误处理
- ✅ 全面的文档支持

---

**完成日期**: 2025-10-18
**版本**: v0.5.0-web-ui
**文档**: `docs/tasks/web-ui-one-command-start.md`
