# QCC v0.4.0 Release Notes

🎉 **重大更新：Anthropic 原生协议支持 + 多 Endpoint 代理服务**

发布日期：2025-10-17

---

## 🌟 核心功能

### 🔐 双重认证策略

QCC 现在同时支持 Anthropic 和 OpenAI 两种认证格式，确保最大兼容性：

```python
# Anthropic 原生格式
'x-api-key': endpoint.api_key
'anthropic-version': '2023-06-01'

# OpenAI 兼容格式
'Authorization': f'Bearer {endpoint.api_key}'
```

**优势：**
- ✅ 无需配置，自动适配各种第三方服务
- ✅ 支持 Anthropic 官方 API、Claude Code、AnyRouter 等
- ✅ 向后兼容 OpenAI 格式服务

### 📡 Anthropic 原生协议

完全支持 Claude Code 使用的 Anthropic 原生协议：

- **端点：** `/v1/messages`（而非 `/v1/chat/completions`）
- **请求格式：** Anthropic Messages API
- **响应格式：** Anthropic 原生格式
- **版本头：** `anthropic-version: 2023-06-01`

### 🔄 多 Endpoint 代理服务

强大的代理服务器，支持：

- **智能负载均衡：** 加权轮询、最少连接、响应时间优先
- **自动故障转移：** 实时健康检测，自动切换故障节点
- **健康监控：** 基于真实对话的健康检查
- **动态权重调整：** 根据性能自动调整 endpoint 权重
- **失败队列处理：** 智能验证和恢复机制

## 🆕 新增功能

### CLI 命令

```bash
# 启动代理服务器
uvx qcc proxy start

# 代理服务器管理
uvx qcc proxy status   # 查看状态
uvx qcc proxy stop     # 停止服务
```

### Endpoint 配置

支持配置多个 endpoint，实现负载均衡：

```json
{
  "endpoints": [
    {
      "id": "endpoint-1",
      "base_url": "https://api.example.com",
      "api_key": "sk-...",
      "models": ["claude-3-5-haiku-20241022"],
      "weight": 1.0,
      "enabled": true
    }
  ]
}
```

### 测试工具

提供完整的测试工具集：

```bash
# 测试 Anthropic 协议
python tests/integration/test_anthropic_protocol.py

# 测试双重认证
python tests/integration/test_dual_auth.py

# 测试代理服务器
python tests/integration/test_proxy_anthropic.py
```

## 🔧 改进优化

### 协议兼容性

- ✅ 完全兼容 Anthropic Claude Code 协议
- ✅ 支持 OpenAI 兼容服务
- ✅ 自动协议适配，无需手动配置

### 健康检查

- 使用真实 AI 对话测试（而非简单 ping）
- 支持多种 Claude 模型
- 智能质量评分系统

### 错误处理

- 完善的异常处理机制
- 详细的日志记录
- 友好的错误提示

## 📚 文档更新

### 新增文档

- **[ANTHROPIC_PROTOCOL_UPDATE.md](../ANTHROPIC_PROTOCOL_UPDATE.md)** - 快速更新指南
- **[双重认证策略](../claudedocs/dual_auth_strategy.md)** - 认证策略详解
- **[协议迁移报告](../claudedocs/anthropic_protocol_migration.md)** - 详细技术报告
- **[CLI 参考](../CLI_REFERENCE.md)** - 命令行完整文档

### 配置示例

- **[Anthropic Endpoint 配置](../anthropic_endpoint_config_example.json)** - 实用配置模板

## 🧪 测试覆盖

### 已测试场景

| 测试项 | 状态 |
|--------|------|
| Anthropic 原生协议 | ✅ 通过 |
| 双重认证策略 | ✅ 通过 |
| x-api-key 认证 | ✅ 通过 |
| Authorization Bearer 认证 | ✅ 通过 |
| 流式响应 | ✅ 通过 |
| AnyRouter 兼容性 | ✅ 通过 |
| 多模型支持 | ✅ 通过 |

### 验证的服务

- ✅ AnyRouter (`https://q.quuvv.cn`)
- ✅ Claude 3.5 Haiku
- ✅ Claude Haiku 4.5

## 🔄 破坏性变更

### 协议端点变更

- **旧版本：** 使用 `/v1/chat/completions`（OpenAI 格式）
- **新版本：** 使用 `/v1/messages`（Anthropic 格式）

**影响：** 如果你的 endpoint 只支持 OpenAI 格式，可能需要更新配置。但由于采用了双重认证策略，大多数服务应该能自动适配。

### 配置格式扩展

- **旧版本：** 单一 endpoint 配置
- **新版本：** 支持 `endpoints` 数组（同时兼容旧格式）

## 📦 安装与升级

### 新安装

```bash
# 从 PyPI 安装
uvx qcc

# 从源码安装
git clone https://github.com/yxhpy/qcc.git
cd qcc
uvx --from . qcc
```

### 升级

```bash
# 升级到最新版本
pip install --upgrade qcc

# 或使用 uvx
uvx --refresh qcc
```

## 🚀 快速开始

### 1. 配置 Endpoint

```bash
# 使用 browse 模式添加 endpoint
uvx qcc config browser

# 或直接编辑配置
uvx qcc config show
```

### 2. 启动代理

```bash
uvx qcc proxy start
```

### 3. 配置 Claude Code

设置代理地址：`http://127.0.0.1:7860`

## 🐛 Bug 修复

- 修复流式响应超时问题
- 修复健康检查模型选择
- 修复认证头处理逻辑
- 改进错误信息提示

## 📊 性能改进

- 优化代理转发性能
- 减少不必要的请求
- 改进并发处理能力

## 🙏 致谢

感谢所有贡献者和用户的支持！

特别感谢：
- Claude Code 团队提供的优秀工具
- Anthropic 提供的强大 AI 模型
- 开源社区的贡献和反馈

## 🔗 相关链接

- **GitHub：** https://github.com/yxhpy/qcc
- **文档：** https://github.com/yxhpy/qcc/tree/main/docs
- **问题反馈：** https://github.com/yxhpy/qcc/issues

## 📋 下一步计划

### v0.5.0 规划

- [ ] Web UI 管理界面
- [ ] 更多负载均衡策略
- [ ] 性能监控面板
- [ ] 配置导入导出
- [ ] 更多第三方服务集成

---

**完整变更日志：** [CHANGELOG.md](../../CHANGELOG.md)

**升级指南：** [ANTHROPIC_PROTOCOL_UPDATE.md](../ANTHROPIC_PROTOCOL_UPDATE.md)

---

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
