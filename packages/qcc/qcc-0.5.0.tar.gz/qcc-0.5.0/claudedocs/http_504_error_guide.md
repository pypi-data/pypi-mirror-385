# HTTP 504 é”™è¯¯è¯Šæ–­æŒ‡å—

## ğŸ“– ä»€ä¹ˆæ˜¯ 504 é”™è¯¯ï¼Ÿ

**HTTP 504 Gateway Timeout** - ç½‘å…³è¶…æ—¶é”™è¯¯

### é”™è¯¯å«ä¹‰
ä»£ç†æœåŠ¡å™¨ï¼ˆå¦‚ QCC Proxyï¼‰åœ¨ç­‰å¾…ä¸Šæ¸¸æœåŠ¡å™¨ï¼ˆå¦‚ Claude API endpointï¼‰å“åº”æ—¶**è¶…æ—¶**äº†ã€‚

### å…¸å‹åœºæ™¯
```
ç”¨æˆ·è¯·æ±‚ â†’ QCC Proxy â†’ ä¸Šæ¸¸ API (jp.duckcoding.com)
                â†“              â†“
           ç­‰å¾…å“åº”          å¤„ç†ä¸­...
                â†“              â†“
           ç­‰å¾…è¶…æ—¶ï¼         è¿˜æ²¡å®Œæˆ
                â†“
         è¿”å› 504 ç»™ç”¨æˆ·
```

## ğŸ” QCC ä¸­çš„è¶…æ—¶é…ç½®

### å½“å‰è¶…æ—¶è®¾ç½®

æ ¹æ®ä»£ç åˆ†æï¼ŒQCC æœ‰ä»¥ä¸‹è¶…æ—¶é…ç½®ï¼š

#### 1. **ä»£ç†è¯·æ±‚è¶…æ—¶** ([server.py:337-368](../fastcc/proxy/server.py#L337-L368))
```python
ClientTimeout(
    total=300,      # æ€»è¶…æ—¶ï¼š5 åˆ†é’Ÿï¼ˆ300 ç§’ï¼‰
    sock_read=60    # å•æ¬¡è¯»å–è¶…æ—¶ï¼š1 åˆ†é’Ÿ
)
```

#### 2. **å¥åº·æ£€æŸ¥è¶…æ—¶** ([conversational_checker.py:36](../fastcc/proxy/conversational_checker.py#L36))
```python
self.timeout = 30  # 30 ç§’
```

#### 3. **Endpoint é»˜è®¤è¶…æ—¶** ([endpoint.py](../fastcc/core/endpoint.py))
```python
timeout: int = 30  # é»˜è®¤ 30 ç§’
```

### è¶…æ—¶å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¯·æ±‚è¶…æ—¶ï¼ˆ5 åˆ†é’Ÿï¼‰                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ä¸Šæ¸¸ API å“åº”è¶…æ—¶ï¼ˆå–å†³äº endpoint é…ç½®ï¼‰     â”‚  â”‚
â”‚  â”‚                                                â”‚  â”‚
â”‚  â”‚  é»˜è®¤ï¼š30 ç§’                                   â”‚  â”‚
â”‚  â”‚  å¯é…ç½®ï¼šendpoint.timeout                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš¨ 504 é”™è¯¯çš„å¸¸è§åŸå› 

### 1. **ä¸Šæ¸¸æœåŠ¡å™¨å“åº”æ…¢**
**ç‰¹å¾**ï¼š
- AI æ¨¡å‹æ¨ç†æ—¶é—´é•¿ï¼ˆå¤æ‚è¯·æ±‚å¯èƒ½éœ€è¦ 30-60 ç§’ï¼‰
- å¤§é‡å¹¶å‘è¯·æ±‚å¯¼è‡´æœåŠ¡å™¨æ’é˜Ÿ
- æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜

**åœ¨ QCC ä¸­çš„è¡¨ç°**ï¼š
```log
[req-123] è¯·æ±‚è¶…æ—¶
[req-123] è½¬å‘è¯·æ±‚å¤±è´¥: TimeoutError
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… å¢åŠ  endpoint çš„ `timeout` é…ç½®
- âœ… ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹ï¼ˆå¦‚ `claude-3-5-haiku`ï¼‰
- âœ… å‡å°‘ `max_tokens` é™ä½å“åº”æ—¶é—´
- âœ… å¯ç”¨æµå¼å“åº”ï¼ˆstreamingï¼‰

### 2. **ç½‘ç»œè¿æ¥é—®é¢˜**
**ç‰¹å¾**ï¼š
- è·¨åœ°åŸŸç½‘ç»œå»¶è¿Ÿé«˜ï¼ˆå¦‚è®¿é—®æ—¥æœ¬æœåŠ¡å™¨ï¼‰
- ç½‘ç»œä¸ç¨³å®šã€ä¸¢åŒ…
- é˜²ç«å¢™/NAT é™åˆ¶

**åœ¨ QCC ä¸­çš„è¡¨ç°**ï¼š
```log
[req-123] è½¬å‘è¯·æ±‚å¤±è´¥: ClientConnectorError
[req-123] å“åº”å¤±è´¥: 502/504
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… é€‰æ‹©åœ°ç†ä½ç½®æ›´è¿‘çš„ endpoint
- âœ… ä½¿ç”¨ VPN/ä»£ç†ä¼˜åŒ–ç½‘ç»œè·¯å¾„
- âœ… é…ç½®æ›´é•¿çš„è¶…æ—¶æ—¶é—´
- âœ… å¯ç”¨è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆQCC é»˜è®¤é‡è¯• 2 æ¬¡ï¼‰

### 3. **ä¸Šæ¸¸æœåŠ¡å™¨æ•…éšœ**
**ç‰¹å¾**ï¼š
- æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨
- æ­£åœ¨ç»´æŠ¤/é‡å¯
- èµ„æºè€—å°½ï¼ˆå†…å­˜/CPUï¼‰

**åœ¨ QCC ä¸­çš„è¡¨ç°**ï¼š
```log
ğŸ” å¼€å§‹éªŒè¯å¤±è´¥çš„ endpoint (N ä¸ª)
âŒ Endpoint xxx éªŒè¯å¤±è´¥: HTTP 504
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… å¯ç”¨å¤š endpoint è´Ÿè½½å‡è¡¡
- âœ… é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»
- âœ… ä½¿ç”¨å¥åº·æ£€æŸ¥æœºåˆ¶ï¼ˆQCC å·²æ”¯æŒï¼‰
- âœ… æŸ¥çœ‹å¤±è´¥é˜Ÿåˆ—çŠ¶æ€ï¼š`qcc proxy status`

### 4. **è¶…æ—¶é…ç½®è¿‡çŸ­**
**ç‰¹å¾**ï¼š
- è¯·æ±‚å®é™…éœ€è¦ 60 ç§’ï¼Œä½†è¶…æ—¶è®¾ç½®ä¸º 30 ç§’
- å¤§æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½åœºæ™¯
- å¤æ‚çš„ AI æ¨ç†ä»»åŠ¡

**åœ¨ QCC ä¸­çš„è¡¨ç°**ï¼š
```log
[req-123] Timeout after 30s
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… è°ƒæ•´ endpoint çš„ `timeout` é…ç½®
- âœ… é’ˆå¯¹ä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒé…ç½®
- âœ… ç›‘æ§å®é™…å“åº”æ—¶é—´è°ƒæ•´é˜ˆå€¼

### 5. **è¯·æ±‚é˜Ÿåˆ—ç§¯å‹**
**ç‰¹å¾**ï¼š
- ä¸Šæ¸¸æœåŠ¡å™¨é™æµï¼ˆrate limitï¼‰
- å¤§é‡å¹¶å‘è¯·æ±‚è¶…è¿‡æœåŠ¡å™¨å¤„ç†èƒ½åŠ›
- æ’é˜Ÿç­‰å¾…æ—¶é—´è¿‡é•¿

**åœ¨ QCC ä¸­çš„è¡¨ç°**ï¼š
```log
âš ï¸ Endpoint xxx è¢«é™æµ
HTTP 429: Rate limit exceeded
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ä½¿ç”¨å¤šä¸ª endpoint åˆ†æ•£æµé‡
- âœ… å®ç°å®¢æˆ·ç«¯è¯·æ±‚é™æµ
- âœ… ç›‘æ§ endpoint çš„ QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
- âœ… é…ç½®åˆç†çš„æƒé‡åˆ†é…

## ğŸ› ï¸ è¯Šæ–­æ­¥éª¤

### 1. æŸ¥çœ‹ QCC æ—¥å¿—
```bash
# æŸ¥çœ‹ä»£ç†æ—¥å¿—
cat ~/.qcc/proxy.log

# å®æ—¶ç›‘æ§æ—¥å¿—
tail -f ~/.qcc/proxy.log
```

**å…³é”®ä¿¡æ¯**ï¼š
- `[req-XXX] è¯·æ±‚è¶…æ—¶` - ç¡®è®¤æ˜¯è¶…æ—¶é—®é¢˜
- `Endpoint xxx` - å®šä½æ˜¯å“ªä¸ª endpoint
- `è€—æ—¶: XXXms` - äº†è§£å®é™…å“åº”æ—¶é—´

### 2. æ£€æŸ¥ endpoint å¥åº·çŠ¶æ€
```bash
# æŸ¥çœ‹ä»£ç†çŠ¶æ€
qcc proxy status

# æ£€æŸ¥å¤±è´¥é˜Ÿåˆ—
qcc cluster list test2  # æŸ¥çœ‹ test2 é›†ç¾¤çŠ¶æ€
```

**å…³æ³¨ç‚¹**ï¼š
- `å¤±è´¥çš„ endpoint æ•°é‡`
- `å¥åº·æ£€æŸ¥ç»“æœ`
- `å¹³å‡å“åº”æ—¶é—´`

### 3. æ‰‹åŠ¨æµ‹è¯• endpoint
```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬
python test_endpoint.py

# æˆ–ä½¿ç”¨ curl
curl -X POST https://jp.duckcoding.com/v1/messages \
  -H "x-api-key: YOUR_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-3-5-haiku-20241022",
    "max_tokens": 10,
    "messages": [{"role": "user", "content": "test"}]
  }' \
  -w "\næ€»è€—æ—¶: %{time_total}s\n"
```

**éªŒè¯**ï¼š
- æ˜¯å¦èƒ½æˆåŠŸå“åº”ï¼Ÿ
- å“åº”æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ
- æ˜¯å¦å‡ºç° 504/502ï¼Ÿ

### 4. ç½‘ç»œè¿æ¥æµ‹è¯•
```bash
# æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ
ping jp.duckcoding.com

# æµ‹è¯• TCP è¿æ¥
telnet jp.duckcoding.com 443

# æŸ¥çœ‹è·¯ç”±è·³æ•°
tracert jp.duckcoding.com  # Windows
traceroute jp.duckcoding.com  # Linux/Mac
```

**åˆ†æ**ï¼š
- å»¶è¿Ÿæ˜¯å¦è¿‡é«˜ï¼ˆ>200msï¼‰ï¼Ÿ
- æ˜¯å¦æœ‰ä¸¢åŒ…ï¼Ÿ
- è·¯ç”±è·³æ•°æ˜¯å¦è¿‡å¤šï¼Ÿ

## ğŸ”§ è§£å†³æ–¹æ¡ˆé€ŸæŸ¥è¡¨

| é—®é¢˜ç±»å‹ | ç—‡çŠ¶ | å¿«é€Ÿè§£å†³æ–¹æ¡ˆ |
|---------|------|-------------|
| **ä¸Šæ¸¸æ…¢** | ç»å¸¸è¶…æ—¶ï¼Œä½†å¶å°”æˆåŠŸ | å¢åŠ  `timeout` åˆ° 60-90 ç§’ |
| **ç½‘ç»œå·®** | è¿æ¥æ—¶å¿«æ—¶æ…¢ | æ›´æ¢åœ°ç†ä½ç½®æ›´è¿‘çš„ endpoint |
| **æœåŠ¡å™¨æŒ‚** | æŒç»­å¤±è´¥ï¼Œå¥åº·æ£€æŸ¥å¤±è´¥ | æ·»åŠ å¤‡ç”¨ endpointï¼Œå¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§» |
| **é™æµ** | è¿”å› 429 é”™è¯¯ | ä½¿ç”¨å¤šä¸ª endpoint è´Ÿè½½å‡è¡¡ |
| **é…ç½®é”™** | æ‰€æœ‰è¯·æ±‚éƒ½è¶…æ—¶ | æ£€æŸ¥ `base_url` å’Œ `api_key` |

## ğŸ“Š QCC è¶…æ—¶ä¼˜åŒ–å»ºè®®

### é’ˆå¯¹ä¸åŒåœºæ™¯çš„è¶…æ—¶é…ç½®

#### 1. **å¿«é€ŸæŸ¥è¯¢åœºæ™¯**ï¼ˆç®€å•é—®é¢˜ã€å¥åº·æ£€æŸ¥ï¼‰
```yaml
endpoint:
  timeout: 30  # 30 ç§’è¶³å¤Ÿ
  model: claude-3-5-haiku-20241022
  max_tokens: 100
```

#### 2. **å¸¸è§„å¯¹è¯åœºæ™¯**ï¼ˆClaude Code ä½¿ç”¨ï¼‰
```yaml
endpoint:
  timeout: 60  # 1 åˆ†é’Ÿ
  model: claude-sonnet-4-5
  max_tokens: 4096
```

#### 3. **å¤æ‚æ¨ç†åœºæ™¯**ï¼ˆé•¿æ–‡æœ¬ã€å¤šæ­¥éª¤ä»»åŠ¡ï¼‰
```yaml
endpoint:
  timeout: 120  # 2 åˆ†é’Ÿ
  model: claude-sonnet-4-5
  max_tokens: 8192
```

#### 4. **å¤§è§„æ¨¡ç”Ÿæˆåœºæ™¯**ï¼ˆä»£ç ç”Ÿæˆã€é•¿æ–‡æ¡£ï¼‰
```yaml
endpoint:
  timeout: 180  # 3 åˆ†é’Ÿ
  model: claude-sonnet-4-5
  max_tokens: 16384
  streaming: true  # å¯ç”¨æµå¼å“åº”
```

### é…ç½®ç¤ºä¾‹

ä¿®æ”¹é…ç½®æ–‡ä»¶ `~/.qcc/config.yaml`ï¼š

```yaml
test2:
  endpoints:
    - base_url: https://jp.duckcoding.com
      api_key: sk-...
      weight: 100
      priority: 1
      timeout: 90  # â† å¢åŠ è¶…æ—¶åˆ° 90 ç§’
      max_failures: 3

    # æ·»åŠ å¤‡ç”¨ endpoint
    - base_url: https://backup.example.com
      api_key: sk-...
      weight: 50
      priority: 2
      timeout: 90
```

## ğŸ¯ é¢„é˜² 504 é”™è¯¯çš„æœ€ä½³å®è·µ

### 1. **å¤š Endpoint å®¹é”™**
```yaml
# é…ç½®å¤šä¸ª endpointï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
endpoints:
  - primary_endpoint    # ä¸»èŠ‚ç‚¹
  - auxiliary_1         # è¾…åŠ©èŠ‚ç‚¹ 1
  - auxiliary_2         # è¾…åŠ©èŠ‚ç‚¹ 2
```

âœ… **å¥½å¤„**ï¼šä¸€ä¸ªå¤±è´¥è‡ªåŠ¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ª

### 2. **åˆç†çš„è¶…æ—¶é…ç½®**
```python
# ä¸è¦ä¸€åˆ€åˆ‡ï¼Œæ ¹æ®å®é™…éœ€æ±‚é…ç½®
å¿«é€ŸæŸ¥è¯¢ï¼š30s
å¸¸è§„å¯¹è¯ï¼š60s
å¤æ‚ä»»åŠ¡ï¼š90-120s
```

âœ… **å¥½å¤„**ï¼šæ—¢ä¸æµªè´¹æ—¶é—´ç­‰å¾…ï¼Œä¹Ÿä¸è¿‡æ—©æ”¾å¼ƒ

### 3. **å¯ç”¨é‡è¯•æœºåˆ¶**
```python
# QCC é»˜è®¤é…ç½®ï¼šåˆå§‹è¯·æ±‚ + 2 æ¬¡é‡è¯•
max_retries = 2
```

âœ… **å¥½å¤„**ï¼šä¸´æ—¶æ€§æ•…éšœå¯ä»¥è‡ªåŠ¨æ¢å¤

### 4. **ç›‘æ§å’Œå‘Šè­¦**
```bash
# å®šæœŸæ£€æŸ¥ä»£ç†çŠ¶æ€
qcc proxy status

# æŸ¥çœ‹å¤±è´¥é˜Ÿåˆ—
qcc cluster list <name>
```

âœ… **å¥½å¤„**ï¼šåŠæ—¶å‘ç°é—®é¢˜ï¼Œå¿«é€Ÿå“åº”

### 5. **ä½¿ç”¨æµå¼å“åº”**
```python
# Claude API æ”¯æŒ Server-Sent Events (SSE)
stream: true
```

âœ… **å¥½å¤„**ï¼š
- æ›´å¿«å¾—åˆ°ç¬¬ä¸€ä¸ªå“åº”
- é™ä½æ•´ä½“è¶…æ—¶é£é™©
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

## ğŸ“ å¸¸è§ 504 é”™è¯¯æ—¥å¿—ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šä¸Šæ¸¸è¶…æ—¶
```log
[req-456] POST /v1/messages
[req-456] é€‰ä¸­ endpoint: 1e3e69eb (https://jp.duckcoding.com)
[req-456] è¯·æ±‚è¶…æ—¶
[req-456] è½¬å‘è¯·æ±‚å¤±è´¥: TimeoutError
[req-456] é‡è¯• 1/2, é€‰ä¸­ endpoint: 2f4g80fc
```

**åˆ†æ**ï¼šä¸Šæ¸¸æœåŠ¡å™¨å“åº”æ…¢ï¼ŒQCC è‡ªåŠ¨é‡è¯•åˆ°å¦ä¸€ä¸ª endpoint

### ç¤ºä¾‹ 2ï¼šæŒç»­å¤±è´¥
```log
[req-789] POST /v1/messages
[req-789] é€‰ä¸­ endpoint: 1e3e69eb
[req-789] å“åº”å¤±è´¥: 504
[req-789] é‡è¯• 1/2, é€‰ä¸­ endpoint: 1e3e69eb
[req-789] å“åº”å¤±è´¥: 504
[req-789] é‡è¯• 2/2, é€‰ä¸­ endpoint: 1e3e69eb
[req-789] é‡è¯• 2 æ¬¡åä»å¤±è´¥ï¼ŒçŠ¶æ€ç : 504
ğŸ” å¼€å§‹éªŒè¯å¤±è´¥çš„ endpoint (1 ä¸ª)
âŒ Endpoint 1e3e69eb éªŒè¯å¤±è´¥: HTTP 504
```

**åˆ†æ**ï¼šendpoint æŒç»­å¤±è´¥ï¼Œè¢«åŠ å…¥å¤±è´¥é˜Ÿåˆ—ç­‰å¾…æ¢å¤éªŒè¯

### ç¤ºä¾‹ 3ï¼šç½‘ç»œé—®é¢˜
```log
[req-101] POST /v1/messages
[req-101] è½¬å‘è¯·æ±‚å¤±è´¥: ClientConnectorError: Cannot connect to host
```

**åˆ†æ**ï¼šç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯ DNS è§£æé—®é¢˜æˆ–ç½‘ç»œä¸é€š

## ğŸ”„ 504 é”™è¯¯å¤„ç†æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B{é€‰æ‹© Endpoint}
    B --> C[è½¬å‘è¯·æ±‚]
    C --> D{æ˜¯å¦è¶…æ—¶?}
    D -->|æ˜¯| E[æ ‡è®°å¤±è´¥]
    D -->|å¦| F{çŠ¶æ€ç ?}
    F -->|200| G[è¿”å›æˆåŠŸ]
    F -->|504| E
    E --> H{è¿˜æœ‰é‡è¯•æ¬¡æ•°?}
    H -->|æ˜¯| I[é€‰æ‹©æ–° Endpoint]
    I --> C
    H -->|å¦| J[è¿”å› 502/504]
    J --> K[åŠ å…¥å¤±è´¥é˜Ÿåˆ—]
    K --> L[å®šæœŸå¥åº·æ£€æŸ¥]
    L --> M{æ¢å¤äº†?}
    M -->|æ˜¯| N[æ¢å¤ä½¿ç”¨]
    M -->|å¦| L
```

## ğŸ“š ç›¸å…³èµ„æº

- [QCC Endpoint é…ç½®æ–‡æ¡£](../README.md#endpoint-é…ç½®)
- [å¥åº·æ£€æŸ¥æœºåˆ¶è¯´æ˜](./health_check_explained.md)
- [å¤±è´¥é˜Ÿåˆ—å·¥ä½œåŸç†](./failure_queue_design.md)
- [è´Ÿè½½å‡è¡¡ç­–ç•¥](./load_balancing_strategies.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-17
**é€‚ç”¨ç‰ˆæœ¬**: QCC v0.4.2+
