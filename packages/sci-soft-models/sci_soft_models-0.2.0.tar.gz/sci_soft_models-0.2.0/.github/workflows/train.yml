name: Model Training and Evaluation

on: 
  workflow_dispatch:
    inputs:
      command:
        description: "Command to run"
        required: true
        type: string

# adding permissions to tackle error: 'Resource not accessible by integration'
permissions:
  actions: write
  contents: write
  id-token: write
  issues: write
  pull-requests: write

jobs:
  deploy-runner:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: iterative/setup-cml@v1
      - name: Deploy Runner
        env:
            REPO_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          cml runner launch \
              --single \
              --cloud=aws \
              --cloud-region=us-west-2 \
              --cloud-type=g4ad.xlarge \
              --labels=cml-gpu

  run-command:
    needs: deploy-runner
    runs-on: [self-hosted, cml-gpu]
    timeout-minutes: 50400 # 35 days
    container:
      image: ghcr.io/iterative/cml:0-dvc2-base1-gpu
      options: --gpus all
    steps:
      - uses: actions/checkout@v4

      - name: Check GPUs
        run: nvidia-smi

      - name: Install Dependencies
        run: |
          pip install uv && uv pip install --system --no-cache-dir -e .
      
      - name: Run Command
        env:
          HF_AUTH_TOKEN: ${{ secrets.HF_AUTH_TOKEN }}
        run: |
          ${{ github.event.inputs.command }}