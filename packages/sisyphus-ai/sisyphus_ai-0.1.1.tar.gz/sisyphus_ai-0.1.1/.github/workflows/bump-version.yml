name: Bump Version and Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
      custom_version:
        description: 'Custom version (leave empty for auto-bump)'
        required: false
        type: string

permissions:
  contents: write  # Git push ë° Release ìƒì„± ê¶Œí•œ

jobs:
  bump-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install toml package
        run: pip install toml

      - name: Get current version and bump
        id: version
        run: |
          # Python ìŠ¤í¬ë¦½íŠ¸ë¡œ ë²„ì „ ì½ê¸° ë° bump
          python << 'EOF'
          import toml
          import sys
          import os

          # pyproject.toml ì½ê¸°
          with open('pyproject.toml', 'r') as f:
              data = toml.load(f)

          current_version = data['project']['version']
          print(f"Current version: {current_version}")

          # ë²„ì „ íŒŒì‹±
          major, minor, patch = map(int, current_version.split('.'))

          # Custom versionì´ ì œê³µë˜ì—ˆëŠ”ì§€ í™•ì¸
          custom_version = "${{ github.event.inputs.custom_version }}"

          if custom_version:
              new_version = custom_version
              print(f"Using custom version: {new_version}")
          else:
              # ë²„ì „ bump
              version_type = "${{ github.event.inputs.version_type }}"
              if version_type == 'major':
                  major += 1
                  minor = 0
                  patch = 0
              elif version_type == 'minor':
                  minor += 1
                  patch = 0
              else:  # patch
                  patch += 1

              new_version = f"{major}.{minor}.{patch}"
              print(f"Bumped {version_type} version to: {new_version}")

          # pyproject.toml ì—…ë°ì´íŠ¸
          data['project']['version'] = new_version
          with open('pyproject.toml', 'w') as f:
              toml.dump(data, f)

          # GitHub Actions output ì„¤ì •
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"old_version={current_version}\n")
              f.write(f"new_version={new_version}\n")
              f.write(f"tag=v{new_version}\n")
          EOF

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version bump
        run: |
          git add pyproject.toml
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
          git push origin master

      - name: Create Git tag
        run: |
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      - name: Generate changelog
        id: changelog
        run: |
          # ì´ì „ íƒœê·¸ë¶€í„° í˜„ì¬ê¹Œì§€ì˜ ì»¤ë°‹ ë©”ì‹œì§€ ìˆ˜ì§‘
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # ì²« ë¦´ë¦¬ì¦ˆì¸ ê²½ìš°
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # ì´ì „ íƒœê·¸ ì´í›„ì˜ ì»¤ë°‹ë“¤
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Changelogë¥¼ íŒŒì¼ë¡œ ì €ì¥ (multiline string ì²˜ë¦¬)
          cat > changelog.txt << 'CHANGELOG_EOF'
          ## What's Changed

          ${CHANGELOG}

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.old_version }}...${{ steps.version.outputs.tag }}
          CHANGELOG_EOF

          # GitHub output ì„¤ì •
          {
            echo "changelog<<CHANGELOG_DELIMITER"
            cat changelog.txt
            echo "CHANGELOG_DELIMITER"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ steps.version.outputs.tag }} \
            --title "Release ${{ steps.version.outputs.tag }}" \
            --notes "${{ steps.changelog.outputs.changelog }}" \
            --verify-tag

      - name: Summary
        run: |
          echo "## ğŸš€ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Old Version:** ${{ steps.version.outputs.old_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version:** ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The \`Publish to PyPI\` workflow will now automatically deploy to PyPI." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
