on:
  workflow_call:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          # Need this to get version number from last tag
          fetch-depth: 0

      - name: Install Helm
        uses: Azure/setup-helm@v4.3.0
        id: install

      - name: Helm login to GHCR
        if: ${{ github.event_name == 'push' && github.ref_type == 'tag' }}
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ghcr.io/${{ github.repository }} --username ${{ github.repository_owner }} --password-stdin

      - name: Get version from Git tag
        id: meta
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "version=$TAG" >> $GITHUB_OUTPUT

      - name: Package and push chart
        if: ${{ github.event_name == 'push' && github.ref_type == 'tag' }}
        run: |
          helm dependencies update helm/mx-bluesky-blueapi
          helm package helm/mx-bluesky-blueapi --version ${{ steps.meta.outputs.version }} --app-version ${{ steps.meta.outputs.version }} -d /tmp/
          helm push /tmp/mx-bluesky-blueapi-${{ steps.meta.outputs.version }}.tgz oci://ghcr.io/diamondlightsource/charts
