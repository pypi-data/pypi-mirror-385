name: New release
# This workflow starts a new release. Trigger it manually from github ('workflow_dispatch').
# publish_to_pypi.yml is configured to after this workflow is completed (using 'workflow_run').
run-name: ${{ github.actor }} initiated a new release ${{ github.event.inputs.release_version }}  ðŸš€
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Version"
        default: "0.1.0rc0"
      pre_release:
        description: "Pre-release"
        type: boolean
        default: true
env:
  VERSION: ${{ github.event.inputs.release_version}}
  BRANCH: releases/${{ github.event.inputs.release_version}}
  TAG: v${{ github.event.inputs.release_version}}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
jobs:
  changelog:
    name: Write changelog and merge into main
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          version: "0.8.22"

      - name: Create a new branch, generate the changelog and release notes.
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git checkout -b $BRANCH main
          git tag $TAG
          uvx git-cliff -o CHANGELOG.md --github-repo ${{ github.repository }} --github-token ${{ secrets.GITHUB_TOKEN }}
          uvx git-cliff -o release_notes.md --github-repo ${{ github.repository }} --github-token ${{ secrets.GITHUB_TOKEN }} --current
          git commit -am "Prepare for release $TAG"
          git push  https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git $BRANCH
          git tag -d $TAG

      - name: Create & merge pull request + Create release
        # ref: https://cli.github.com/manual/gh_pr_create
        run: |
          gh pr create --head $BRANCH --title $VERSION --body 'Changelog for new release'  --label release
          gh pr merge --squash --delete-branch

      - name: Create a new pre-release
        # ref: https://cli.github.com/manual/gh_release
        if: ${{github.event.inputs.pre_release}}
        run: |
          gh release create $TAG -F release_notes.md  --prerelease

      - name: Create a new release
        if: ${{!github.event.inputs.pre_release}}
        run: |
          gh release create $TAG -F release_notes.md
