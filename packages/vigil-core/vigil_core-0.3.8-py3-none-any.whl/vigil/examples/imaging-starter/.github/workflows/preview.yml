name: preview
on:
  pull_request:

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Generate Vigil link comment
        id: vigil_comment
        run: |
          uv run python -m app.code.tools.github_comments \
            link \
            --ref "${{ github.event.pull_request.head.sha }}" \
            > vigil_link_comment.md
          {
            echo 'body<<EOF'
            cat vigil_link_comment.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Comment Vigil link
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ steps.vigil_comment.outputs.body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const marker = '<!-- vigil-open-link -->';
            const body = process.env.COMMENT_BODY;
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.issue.number
            });
            const existing = comments.find(comment => comment.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({ ...context.repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ ...context.repo, issue_number: context.issue.number, body });
            }
