var se=Object.defineProperty;var ie=(l,e,t)=>e in l?se(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var b=(l,e,t)=>ie(l,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();class z extends Error{constructor(t,n){super(t);b(this,"status");this.name="ApiError",this.status=n}}const F=Object.freeze({"Content-Type":"application/json"});async function I(l,e={},t=!1){const{parseJson:n=!0,...r}=e,o=await fetch(l,r);if(o.status===404&&t)return null;if(!o.ok){let s=o.statusText||`Request failed (${o.status})`;try{const i=await o.json();i!=null&&i.error&&(s=i.error)}catch{}throw new z(s,o.status)}return!n||o.status===204?null:await o.json()}class ne{async fetchTree(){return await I("/api/tree",{method:"GET"})}async listProjects(){return await I("/api/projects",{method:"GET"})}async activateProject(e){return await I("/api/projects/activate",{method:"POST",headers:F,body:JSON.stringify({name:e})})}async readFile(e){const t=encodeURIComponent(e);return await I(`/api/file?path=${t}`,{method:"GET"})}async writeFile(e,t){await I("/api/file",{method:"PUT",headers:F,body:JSON.stringify({path:e,content:t}),parseJson:!1},!1)}async deleteFile(e){const t=encodeURIComponent(e);await I(`/api/file?path=${t}`,{method:"DELETE",parseJson:!1},!1)}async fileExists(e){const t=encodeURIComponent(e);let n=null;try{n=await I(`/api/file?path=${t}`,{method:"GET"},!0)}catch(r){return console.error(r),!1}return n!==null}async search(e,t,n){const r=encodeURIComponent(e);return await I(`/api/search?query=${r}&limit=${t}`,{method:"GET",signal:n})}async vectorStatus(){return await I("/api/vector/status",{method:"GET"})}async vectorEmbeddings(e){const t=new URLSearchParams({limit:String(Math.max(1,e.limit??1e3)),offset:String(Math.max(0,e.offset??0)),full:String(e.full??!1)});return e.path&&t.set("path",e.path),e.full&&t.set("full","true"),await I(`/api/vector/embeddings?${t.toString()}`,{method:"GET"})}async vectorQueryEmbedding(e){const t=new URLSearchParams({query:e});return await I(`/api/vector/query_embedding?${t.toString()}`,{method:"GET"})}async vectorReindex(){return await I("/api/vector/reindex",{method:"POST",headers:F})}async vectorRefit(){return await I("/api/vector/refit",{method:"POST",headers:F})}}const M=new ne;function re(){const l=document.getElementById("file-tree"),e=document.getElementById("editor"),t=document.getElementById("current-path"),n=document.getElementById("save"),r=document.getElementById("cancel"),o=document.getElementById("delete"),s=document.getElementById("status"),i=document.getElementById("new-file"),a=document.getElementById("search-input"),h=document.getElementById("search-limit"),c=document.getElementById("search-clear"),E=document.getElementById("search-results"),g=document.getElementById("menu-browse"),j=document.getElementById("menu-vectors"),v=document.getElementById("browse-view"),p=document.getElementById("vectors-view"),L=document.getElementById("project-select"),T=document.getElementById("project-refresh"),m=document.getElementById("project-message");if(!l||!e||!t||!n||!r||!o||!s||!i||!a||!h||!c||!E||!g||!j||!v||!p||!L||!T||!m)throw new Error("UI markup missing required elements");return{tree:l,editor:e,path:t,save:n,cancel:r,del:o,status:s,newFile:i,searchInput:a,searchLimit:h,searchClear:c,searchResults:E,browseBtn:g,vectorBtn:j,browseView:v,vectorsView:p,projectSelect:L,projectRefresh:T,projectMessage:m}}class ae{constructor(e){b(this,"elements",re());b(this,"vector");b(this,"state",{currentPath:"",originalContent:"",lastSearchTerm:"",lastSearchLimit:10,activeSearchController:null,resultPaths:new Set,activeProject:null,projects:[]});b(this,"triggerSearch");this.vector=e,this.triggerSearch=this.buildSearchScheduler()}async start(){this.wireProjectControls(),this.wireMenu(),this.wireEditor(),this.wireSearch(),await this.refreshProjects(!0),this.updateButtons()}wireProjectControls(){const{projectSelect:e,projectRefresh:t}=this.elements;e.addEventListener("change",n=>{const o=n.target.value;o&&this.handleProjectSelection(o)}),t.addEventListener("click",()=>{this.refreshProjects(!0)})}async refreshProjects(e){try{const t=await M.listProjects();if(!t){this.setProjectMessage("Unable to load projects"),console.error("Unable to load projects");return}await this.applyProjectState(t,e)}catch(t){this.setProjectMessage(this.errorMessage(t,"Unable to load projects")),console.error(t)}}async applyProjectState(e,t){var n,r;this.state.projects=e.projects,this.state.activeProject=e.active??null,this.populateProjectSelect(e.projects,this.state.activeProject),this.state.activeProject?(this.setProjectEnabled(!0),this.setProjectMessage(""),t&&await this.loadTree(),await((n=this.vector)==null?void 0:n.onProjectActivated())):(this.setProjectEnabled(!1),this.clearWorkspaceState(),this.setProjectMessage(e.projects.length?"Select a project to browse files.":"No projects discovered under the workspace root."),(r=this.vector)==null||r.onProjectCleared())}populateProjectSelect(e,t){const{projectSelect:n}=this.elements;n.textContent="";const r=document.createElement("option");r.value="",r.textContent=e.length?"Select a project…":"No projects",r.disabled=!0,t||(r.selected=!0),n.appendChild(r);for(const o of e){const s=document.createElement("option");s.value=o,s.textContent=o,o===t&&(s.selected=!0),n.appendChild(s)}n.toggleAttribute("disabled",e.length===0),t&&e.includes(t)?n.value=t:e.length===0&&(n.value="")}setProjectEnabled(e){const t=(n,r)=>{n.toggleAttribute("disabled",!r)};t(this.elements.newFile,e),t(this.elements.save,e),t(this.elements.cancel,e),t(this.elements.del,e),t(this.elements.searchInput,e),t(this.elements.searchLimit,e),t(this.elements.searchClear,e),this.elements.editor.toggleAttribute("disabled",!e),this.elements.editor.classList.toggle("readonly",!e),e||this.updateButtons()}setProjectMessage(e){this.elements.projectMessage.textContent=e}clearWorkspaceState(){this.state.currentPath="",this.state.originalContent="",this.elements.editor.value="",this.elements.editor.scrollTop=0,this.elements.path.textContent="",this.elements.tree.textContent="",this.elements.searchResults.textContent="",this.clearSearchEffects(),this.updateButtons()}async handleProjectSelection(e){if(!(!e||e===this.state.activeProject)){this.setProjectMessage(`Activating ${e}…`);try{const t=await M.activateProject(e);if(!t){this.setProjectMessage("Unable to activate project"),console.error("Unable to activate project");return}await this.applyProjectState(t,!0),this.setStatus(`Activated project "${e}"`)}catch(t){this.setProjectMessage(this.errorMessage(t,"Activation failed")),console.error(t),await this.refreshProjects(!1)}}}ensureActiveProject(e){return this.state.activeProject?!0:(this.setStatus(`Select a project before ${e}.`),!1)}setStatus(e){this.elements.status.textContent=e??""}hasChanges(){const{currentPath:e,originalContent:t}=this.state;return e?this.elements.editor.value!==t:!1}updateButtons(){if(!this.state.activeProject){this.elements.save.toggleAttribute("disabled",!0),this.elements.cancel.toggleAttribute("disabled",!0),this.elements.del.toggleAttribute("disabled",!0);return}const e=this.hasChanges();this.elements.save.toggleAttribute("disabled",!e),this.elements.cancel.toggleAttribute("disabled",!e),this.elements.del.toggleAttribute("disabled",!this.state.currentPath)}async loadTree(){if(!this.state.activeProject){this.elements.tree.textContent="";return}try{const e=await M.fetchTree();if(!e){this.setStatus("Failed to load file tree"),console.error("Failed to load file tree");return}this.renderTree(e),this.state.resultPaths.size>0&&this.filterTreeWithResults(this.state.resultPaths)}catch(e){if(e instanceof z&&e.status===409){this.setProjectEnabled(!1),this.setProjectMessage("Select a project to browse files.");return}this.setStatus(this.errorMessage(e,"Failed to load file tree")),console.error(e)}}renderTree(e){const{tree:t}=this.elements;t.textContent="",this.buildTree(e,t)}buildTree(e,t){if(e.children)for(const n of e.children)if(n.type==="dir"){const r=document.createElement("li");r.className="dir",r.textContent=`${n.name}/`,t.appendChild(r);const o=document.createElement("ul");o.className="tree",t.appendChild(o),this.buildTree(n,o)}else{const r=document.createElement("li");r.className="file",r.textContent=n.name,r.dataset.path=n.path,r.addEventListener("click",()=>void this.selectFile(n.path,r)),t.appendChild(r)}}errorMessage(e,t){return e instanceof z&&e.message||e instanceof Error&&e.message?e.message:t}async selectFile(e,t,n,r){var o;if(this.ensureActiveProject("opening files"))try{const s=await M.readFile(e);if(!s){this.setStatus(`Unable to load "${e}"`),console.error(`Unable to load "${e}"`);return}this.state.currentPath=s.path,this.state.originalContent=s.content??"",this.elements.editor.value=this.state.originalContent,this.elements.path.textContent=s.path,this.markActive(t),this.setStatus(""),this.updateButtons(),(o=this.vector)==null||o.onTreeSelect(s.path),typeof n=="number"&&n>0&&requestAnimationFrame(()=>this.highlightLineInEditor(n,r))}catch(s){const i=this.errorMessage(s,`Unable to load "${e}"`);this.setStatus(i),console.error(s)}}markActive(e){for(const t of this.elements.tree.querySelectorAll(".file.active"))t.classList.remove("active");e&&e.classList.add("active")}async saveCurrentFile(){if(this.ensureActiveProject("saving files")&&this.state.currentPath){this.setStatus("Saving…");try{await M.writeFile(this.state.currentPath,this.elements.editor.value),this.state.originalContent=this.elements.editor.value,this.setStatus("Saved"),await this.loadTree(),this.updateButtons()}catch(e){const t=this.errorMessage(e,"Save failed");this.setStatus(t),console.error(e)}}}revertChanges(){this.elements.editor.value=this.state.originalContent,this.setStatus("Reverted"),this.updateButtons()}async deleteCurrentFile(){if(!this.ensureActiveProject("deleting files")||!this.state.currentPath)return;const e=this.hasChanges()?" (unsaved changes will be lost)":"";if(window.confirm(`Soft delete "${this.state.currentPath}"?${e}`)){this.setStatus("Deleting…");try{await M.deleteFile(this.state.currentPath),this.state.currentPath="",this.state.originalContent="",this.elements.editor.value="",this.elements.path.textContent="",await this.loadTree(),this.setStatus("Deleted"),this.updateButtons()}catch(n){const r=this.errorMessage(n,"Delete failed");this.setStatus(r),console.error(n)}}}async createNewFile(){if(!this.ensureActiveProject("creating files"))return;const e=this.state.currentPath.replace(/[^/]+$/,""),n=(window.prompt("Enter new file path (relative to root):",e)??"").replace(/^\/+/,"").trim();if(n){this.setStatus("Creating…");try{if(await M.fileExists(n)&&!window.confirm("File exists. Overwrite?")){this.setStatus("");return}await M.writeFile(n,""),await this.loadTree(),await this.selectFile(n,this.findTreeItem(n)),this.setStatus("Created")}catch(r){const o=this.errorMessage(r,"Create failed");this.setStatus(o),console.error(r)}}}highlightLineInEditor(e,t){const{editor:n}=this.elements,r=n.value.split(`
`);console.log("highlightLineInEditor",e,t,r.length),console.log(r),(t===void 0||t<e)&&(t=e);let o=0;for(let i=1;i<=e;i+=1)console.log("add line",i-1,"to start"),o+=(r[i-1]??"").length+1;let s=o;for(let i=e;i<=t;i+=1)console.log("add line",i,"to end"),s+=(r[i]??"").length+1;console.log("highlightLineInEditor2",o,s),n.focus(),n.setSelectionRange(o,s),n.value.length>0&&(n.scrollTop=n.scrollHeight*(o/n.value.length)),n.classList.add("flash"),window.setTimeout(()=>n.classList.remove("flash"),800)}wireEditor(){this.elements.editor.addEventListener("input",()=>this.updateButtons()),this.elements.save.addEventListener("click",()=>void this.saveCurrentFile()),this.elements.cancel.addEventListener("click",()=>this.revertChanges()),this.elements.del.addEventListener("click",()=>void this.deleteCurrentFile()),this.elements.newFile.addEventListener("click",()=>void this.createNewFile())}wireMenu(){const{browseBtn:e,vectorBtn:t,browseView:n,vectorsView:r}=this.elements;e.addEventListener("click",()=>{var o;e.classList.add("active"),e.setAttribute("aria-pressed","true"),t.classList.remove("active"),t.setAttribute("aria-pressed","false"),n.classList.remove("hidden"),n.setAttribute("aria-hidden","false"),r.classList.add("hidden"),r.setAttribute("aria-hidden","true"),(o=this.vector)==null||o.showBrowse()}),t.addEventListener("click",()=>{var o;e.classList.remove("active"),e.setAttribute("aria-pressed","false"),t.classList.add("active"),t.setAttribute("aria-pressed","true"),n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),r.classList.remove("hidden"),r.setAttribute("aria-hidden","false"),(o=this.vector)==null||o.showVectors()})}buildSearchScheduler(){let e;return()=>{e&&window.clearTimeout(e),e=window.setTimeout(()=>{e=void 0,this.runSearch()},200)}}wireSearch(){const{searchInput:e,searchLimit:t,searchClear:n}=this.elements;e.addEventListener("input",()=>this.triggerSearch()),t.addEventListener("change",()=>this.triggerSearch()),n.addEventListener("click",()=>{var r;e.value="",this.clearSearchEffects(),(r=this.vector)==null||r.onClearSearch()})}async runSearch(){var s,i;const{searchInput:e,searchLimit:t}=this.elements,n=e.value.trim(),r=Math.max(1,parseInt(t.value||"10",10));if(this.state.lastSearchTerm=n,this.state.lastSearchLimit=r,!this.state.activeProject)return;if(!n){this.clearSearchEffects(),(s=this.vector)==null||s.onClearSearch();return}this.state.activeSearchController&&this.state.activeSearchController.abort();const o=new AbortController;this.state.activeSearchController=o;try{const a=await M.search(n,r,o.signal);if(!a){this.setStatus("Failed to search"),console.error("Failed to search");return}if(this.renderResults(a,n),this.elements.vectorsView.classList.contains("hidden")){const h=new Set(a.results.map(c=>c.path));this.filterTreeWithResults(h)}else(i=this.vector)==null||i.onSearchResults(n,a)}catch(a){if((a==null?void 0:a.name)==="AbortError")return;this.elements.searchResults.textContent=this.errorMessage(a,"Search error"),console.error(a)}finally{this.state.activeSearchController===o&&(this.state.activeSearchController=null)}}filterTreeWithResults(e){this.state.resultPaths=e;const t=n=>{let r=!1;const o=Array.from(n.children);for(let s=0;s<o.length;s+=1){const i=o[s];if(i.classList.contains("file")){const a=e.has(i.dataset.path??"");i.style.display=a?"":"none",r||(r=a)}else if(i.classList.contains("dir")){const a=o[s+1];if(a&&a.tagName==="UL"){const h=t(a);i.style.display=h?"":"none",a.style.display=h?"":"none",r||(r=h),s+=1}}}return r};t(this.elements.tree)}clearSearchEffects(){this.elements.searchResults.textContent="",this.state.resultPaths=new Set;for(const e of this.elements.tree.querySelectorAll("li, ul"))e.style.display=""}renderResults(e,t){const{searchResults:n,tree:r}=this.elements;if(e.results.length===0){n.textContent="No results",this.state.resultPaths=new Set;return}n.textContent="";for(const o of e.results){const s=(o.content??"").split(`
`),i=Math.max(0,o.start_line),a=Math.min(i+s.length,Math.max(0,o.end_line)),h=document.createElement("div");h.className="result",h.innerHTML=`<span class="line">L${i}-L${a}</span><span class="path">${o.path}</span>`,h.title=s.join(`
`),h.addEventListener("click",()=>{const c=r.querySelector(`.file[data-path="${CSS.escape(o.path)}"]`);this.selectFile(o.path,c,i,a)}),n.appendChild(h)}}findTreeItem(e){return this.elements.tree.querySelector(`.file[data-path="${CSS.escape(e)}"]`)}}function N(l,e){if(l==null)throw new Error(`->${e} is null or undefined`)}function oe(l,e){return typeof l>"u"?e:l}function P(l,e,t){for(const[n,r]of t)N(l[n],`Row ${e}[${n}][${r}]`),r!==void 0&&N(l[n][r],`Col ${e}[${n}][${r}]`)}function $(l,e){if(!l[0]||!l.length)throw new Error(`->${e} should be a valid matrix`)}function X(l,e,t,n){if($(l,t),$(e,n),e.length!==l[0].length)throw new Error(`Columns in ${t} should be the same as the number of rows in ${n}`)}function _(l,e){let t=Math.pow(10,e);return l.map(function(n,r){return n.map(function(o){return Math.round(o*t)/t})})}function G(l){return l.map(e=>Array.from(new Float64Array(e)))}function U(l,e){X(l,e,"a","b");const t=l.length,n=l[0].length,r=e[0].length,o=new Float64Array(t*r);for(let i=0;i<t;i++)for(let a=0;a<n;a++){const h=l[i][a],c=i*r;for(let E=0;E<r;E++)o[c+E]+=h*e[a][E]}const s=[];for(let i=0;i<t;i++)s[i]=Array.from(o.subarray(i*r,(i+1)*r));return s}function J(l,e){$(l,"a"),$(e,"b");const t=l.length,n=l[0].length,r=e.length,o=e[0].length;if(!(t===r&&n===o))throw new Error("Both A and B should have the same dimensions");const s=Array.from({length:t},()=>Array(o).fill(0));for(var i=0;i<t;i++)for(var a=0;a<o;a++)s[i][a]=l[i][a]-e[i][a];return s}function Y(l,e){$(l,"a");const t=l.length,n=l[0].length,r=Array.from({length:t},()=>Array(n).fill(0));for(var o=0;o<t;o++)for(var s=0;s<n;s++)r[o][s]=l[o][s]*e;return r}function W(l,e,t){X(l,e,"a","b");const n=l.length,r=l[0].length,o=e[0].length,s=new Float64Array(n*o);for(let a=0;a<n;a++)for(let h=0;h<r;h++){const c=l[a][h]*t,E=a*o;for(let g=0;g<o;g++)s[E+g]+=c*e[h][g]}const i=[];for(let a=0;a<n;a++)i[a]=Array.from(s.subarray(a*o,(a+1)*o));return i}function H(l){const e=Array.from({length:l},()=>Array(l).fill(0));for(let t=0;t<l;t++)for(let n=0;n<l;n++)e[t][n]=1;return e}function q(l,e=!1){if(e){const t=G(l);return $(t,"a"),t[0].map(function(r,o){return l.map(function(s){return s[o]})})}else return $(l,"a"),l[0].map(function(n,r){return l.map(function(o){return o[r]})})}function le(l){let e,t=Math.pow(2,-52),n=1e-64/t,r=50,o=0,s=0,i=0,a=0,h=0,c=G(l),E=c.length;N(c[0],"u");let g=c[0].length;if(E<g)throw"Need more rows than columns";let j=new Array(g),v=new Array(g);for(s=0;s<g;s++)j[s]=v[s]=0;let p=T([g,g],0);function L(y,S){return y=Math.abs(y),S=Math.abs(S),y>S?y*Math.sqrt(1+S*S/y/y):S==0?y:S*Math.sqrt(1+y*y/S/S)}function T(y,S,B){let x=oe(B,0),R=y[x],k=Array(R),V;if(x===y.length-1){for(V=R-2;V>=0;V-=2)k[V+1]=S,k[V]=S;return V===-1&&(k[0]=S),k}for(V=R-1;V>=0;V--)k[V]=T(y,S,x+1);return k}let m=0,f=0,w=0,A=0,C=0,u=0,d=0;for(s=0;s<g;s++){for(j[s]=f,d=0,h=s+1,i=s;i<E;i++)P(c,"u[j, i]",[[i,s]]),d+=c[i][s]*c[i][s];if(d<=n)f=0;else for(P(c,"u[i, i]",[[s,s]]),m=c[s][s],f=Math.sqrt(d),m>=0&&(f=-f),w=m*f-d,c[s][s]=m-f,i=h;i<g;i++){for(d=0,a=s;a<E;a++)P(c,"u[k, i], [k, j]",[[a,s],[a,i]]),d+=c[a][s]*c[a][i];for(m=d/w,a=s;a<E;a++)c[a][i]+=m*c[a][s]}for(v[s]=f,d=0,i=h;i<g;i++)P(c,"u[i, j]",[[s,i]]),d=d+c[s][i]*c[s][i];if(d<=n)f=0;else{for(m=c[s][s+1],f=Math.sqrt(d),m>=0&&(f=-f),w=m*f-d,P(c,"u[i, i+1]",[[s,s+1]]),c[s][s+1]=m-f,i=h;i<g;i++)j[i]=c[s][i]/w;for(i=h;i<E;i++){for(d=0,a=h;a<g;a++)P(c,"u[j, k], [i, k]",[[i,a],[s,a]]),d+=c[i][a]*c[s][a];for(a=h;a<g;a++)P(c,"u[j, k]",[[i,a]]),c[i][a]+=d*j[a]}}C=Math.abs(v[s])+Math.abs(j[s]),C>A&&(A=C)}for(s=g-1;s!=-1;s+=-1){if(f!=0){for(P(c,"u[i, i+1]",[[s,s+1]]),w=f*c[s][s+1],i=h;i<g;i++)P(c,"u[i, j]",[[s,i]]),p[i][s]=c[s][i]/w;for(i=h;i<g;i++){for(d=0,a=h;a<g;a++)P(c,"u[i, k]",[[s,a]]),P(p,"v[k, j]",[[a,i]]),d+=c[s][a]*p[a][i];for(a=h;a<g;a++)P(p,"v[k, j],[k, i]",[[a,i],[a,s]]),p[a][i]+=d*p[a][s]}}for(i=h;i<g;i++)P(p,"v[i, j],[j, i]",[[s,i],[i,s]]),p[s][i]=0,p[i][s]=0;p[s][s]=1,f=j[s],h=s}for(s=g-1;s!=-1;s+=-1){for(h=s+1,f=v[s],i=h;i<g;i++)P(c,"u[i, j]",[[s,i]]),c[s][i]=0;if(f!=0){for(P(c,"u[i, i]",[[s,s]]),w=c[s][s]*f,i=h;i<g;i++){for(d=0,a=h;a<E;a++)P(c,"u[k, j],[k, i]",[[a,i],[a,s]]),d+=c[a][s]*c[a][i];for(m=d/w,a=s;a<E;a++)P(c,"u[k, j],[k, i]",[[a,i],[a,s]]),c[a][i]+=m*c[a][s]}for(i=s;i<E;i++)P(c,"u[j, i]",[[i,s]]),c[i][s]=c[i][s]/f}else for(i=s;i<E;i++)P(c,"u[j, i]",[[i,s]]),c[i][s]=0;c[s][s]+=1}for(t=t*A,a=g-1;a!=-1;a+=-1)for(let y=0;y<r;y++){let S=!1;for(h=a;h!=-1;h+=-1){if(Math.abs(j[h])<=t){S=!0;break}if(Math.abs(v[h-1])<=t)break}if(!S){o=0,d=1;let B=h-1;for(s=h;s<a+1&&(m=d*j[s],j[s]=o*j[s],!(Math.abs(m)<=t));s++)for(f=v[s],w=L(m,f),v[s]=w,o=f/w,d=-m/w,i=0;i<E;i++)P(c,"u[j, l1],[j, i]",[[i,B],[i,s]]),C=c[i][B],u=c[i][s],c[i][B]=C*o+u*d,c[i][s]=-C*d+u*o}if(u=v[a],h==a){if(u<0)for(v[a]=-u,i=0;i<g;i++)P(p,"v[k, j]",[[i,a]]),p[i][a]=-p[i][a];break}if(y>=r-1)throw`Error: no convergence for ${y} exceeding ${r-1}`;for(A=v[h],C=v[a-1],f=j[a-1],w=j[a],m=((C-u)*(C+u)+(f-w)*(f+w))/(2*w*C),f=L(m,1),m<0?m=((A-u)*(A+u)+w*(C/(m-f)-w))/A:m=((A-u)*(A+u)+w*(C/(m+f)-w))/A,o=1,d=1,s=h+1;s<a+1;s++){for(f=j[s],C=v[s],w=d*f,f=o*f,u=L(m,w),j[s-1]=u,o=m/u,d=w/u,m=A*o+f*d,f=-A*d+f*o,w=C*d,C=C*o,i=0;i<g;i++)P(p,"v[j, i],[j, i-1]",[[i,s-1],[i,s]]),A=p[i][s-1],u=p[i][s],p[i][s-1]=A*o+u*d,p[i][s]=-A*d+u*o;for(u=L(m,w),v[s-1]=u,o=m/u,d=w/u,m=o*f+d*C,A=-d*f+o*C,i=0;i<E;i++)P(c,"u[j, i],[j, i-1]",[[i,s-1],[i,s]]),C=c[i][s-1],u=c[i][s],c[i][s-1]=C*o+u*d,c[i][s]=-C*d+u*o}j[h]=0,j[a]=m,v[a]=A}for(s=0;s<v.length;s++)v[s]<t&&(v[s]=0);for(s=0;s<g;s++)for(i=s-1;i>=0;i--)if(v[i]<v[s]){for(o=v[i],v[i]=v[s],v[s]=o,a=0;a<c.length;a++)P(c,"u[k, i]",[[a,s],[a,i]]),e=c[a][s],c[a][s]=c[a][i],c[a][i]=e;for(a=0;a<p.length;a++)P(p,"v[k, i]",[[a,s],[a,i]]),e=p[a][s],p[a][s]=p[a][i],p[a][i]=e;s=i}return{U:c,S:v,V:p}}function O(l){let e=H(l.length);return J(l,W(e,l,1/l.length))}function K(l){return U(q(l),l)}function Q(l,e){let t;return e?t=Y(l,1/(l.length-1)):t=Y(l,1/l.length),t}function Z(l){let e=le(l),t=e.U;return e.S.map(function(o,s){return{eigenvalue:o,eigenvector:t.map(function(a){return-1*a[s]})}})}function ee(l,...e){let t=e.map(function(a){return a.eigenvector}),n=O(l),r=U(t,q(n)),o=H(l.length),s=W(o,l,-1/l.length),i=_(r,2);return{adjustedData:r,formattedAdjustedData:i,avgData:s,selectedVectors:t}}function ce(l,e,t){let n=q(U(q(e),l)),r=J(n,t),o=_(r,2);return{originalData:r,formattedOriginalData:o}}function he(l,...e){let t=l.map(r=>r.eigenvalue).reduce((r,o)=>r+o);return e.map(r=>r.eigenvalue).reduce((r,o)=>r+o)/t}function te(l){return Z(Q(K(O(l)),!1))}function de(l){let n=te(l).sort(function(r,o){return o.eigenvalue-r.eigenvalue})[0];return ee(l,n)}var D=Object.freeze({__proto__:null,analyseTopResult:de,computeAdjustedData:ee,computeDeviationMatrix:O,computeDeviationScores:K,computeOriginalData:ce,computePercentageExplained:he,computeSVD:Z,computeVarianceCovariance:Q,getEigenVectors:te});typeof window<"u"&&(window.PCA=D);function ue(){const l=document.getElementById("menu-browse"),e=document.getElementById("menu-vectors"),t=document.getElementById("menu-reindex"),n=document.getElementById("menu-umap-refit"),r=document.getElementById("browse-view"),o=document.getElementById("vectors-view"),s=document.getElementById("vector-legend"),i=document.getElementById("vector-status"),a=document.getElementById("vector-canvas"),h=document.getElementById("vector-canvas-container");if(!l||!e||!t||!n||!r||!o||!s||!i||!a||!h)throw new Error("Vector UI markup missing required elements");return{browseBtn:l,vectorBtn:e,reindexBtn:t,refitBtn:n,browseView:r,vectorsView:o,legend:s,status:i,canvas:a,canvasContainer:h}}class fe{constructor(){b(this,"elements",ue());b(this,"available",!1);b(this,"active",!1);b(this,"initialized",!1);b(this,"rows",[]);b(this,"coords",new Float32Array);b(this,"basis",[]);b(this,"indicesByPath",new Map);b(this,"indicesByDocumentId",new Map);b(this,"indicesByRowId",new Map);b(this,"selectedIndices",new Set);b(this,"resultIndices",new Set);b(this,"queryPoint",null);b(this,"yaw",0);b(this,"pitch",0);b(this,"zoom",1);b(this,"panX",0);b(this,"panY",0);b(this,"dragMode",null);b(this,"lastX",0);b(this,"lastY",0)}async initialize(){await this.loadAvailability(),this.wireInteractions(),this.wireAdminButtons()}async onProjectActivated(){this.resetForProjectChange(),await this.loadAvailability()}onProjectCleared(){this.resetForProjectChange()}showBrowse(){this.active=!1,this.elements.vectorBtn.classList.remove("active"),this.elements.vectorBtn.setAttribute("aria-pressed","false"),this.elements.browseBtn.classList.add("active"),this.elements.browseBtn.setAttribute("aria-pressed","true"),this.elements.vectorsView.classList.add("hidden"),this.elements.vectorsView.setAttribute("aria-hidden","true"),this.elements.browseView.classList.remove("hidden"),this.elements.browseView.setAttribute("aria-hidden","false")}showVectors(){if(!this.available){this.setStatus("Vector store unavailable");return}this.active=!0,this.elements.browseBtn.classList.remove("active"),this.elements.browseBtn.setAttribute("aria-pressed","false"),this.elements.vectorBtn.classList.add("active"),this.elements.vectorBtn.setAttribute("aria-pressed","true"),this.elements.browseView.classList.add("hidden"),this.elements.browseView.setAttribute("aria-hidden","true"),this.elements.vectorsView.classList.remove("hidden"),this.elements.vectorsView.setAttribute("aria-hidden","false"),this.initialized?this.render():(this.initialized=!0,this.loadEmbeddings())}onTreeSelect(e){if(!this.available)return;this.selectedIndices.clear();const t=this.indicesByPath.get(e);t&&t.forEach(n=>this.selectedIndices.add(n)),this.updateLegend(),this.active&&this.render()}async onSearchResults(e,t){if(!(!this.available||!this.rows.length)){this.resultIndices.clear();for(const n of t.results){let r=!1;const o=[];n.chunk_id&&o.push(n.chunk_id),n.document_id&&typeof n.chunk_number=="number"&&o.push(`${n.document_id}-${n.chunk_number}`);for(const s of o){const i=this.indicesByRowId.get(s);i!==void 0&&(this.resultIndices.add(i),r=!0)}if(!r&&n.document_id){const s=this.indicesByDocumentId.get(n.document_id);s&&s.forEach(i=>this.resultIndices.add(i))}}this.queryPoint=t.meta.query_embeddings_umap3d??null,this.updateLegend(),this.active&&this.render()}}onClearSearch(){this.available&&(this.resultIndices.clear(),this.queryPoint=null,this.updateLegend(),this.active&&this.render())}isAvailable(){return this.available}isActive(){return this.active}setStatus(e){this.elements.status.textContent=e??""}resizeCanvas(){const e=this.elements.canvas.getBoundingClientRect(),t=window.devicePixelRatio||1,n=Math.max(1,Math.floor(e.width*t)),r=Math.max(1,Math.floor(e.height*t));(this.elements.canvas.width!==n||this.elements.canvas.height!==r)&&(this.elements.canvas.width=n,this.elements.canvas.height=r)}render(){if(!this.rows.length||!this.coords.length)return;this.resizeCanvas();const e=this.elements.canvas.getContext("2d");if(!e)return;const t=this.elements.canvas.width,n=this.elements.canvas.height;e.clearRect(0,0,t,n),e.fillStyle="#111",e.fillRect(0,0,t,n);const r=20;let o=1/0,s=-1/0,i=1/0,a=-1/0;const h=Math.cos(this.yaw),c=Math.sin(this.yaw),E=Math.cos(this.pitch),g=Math.sin(this.pitch),j=new Float32Array(this.coords.length);for(let u=0;u<this.coords.length;u+=3){const d=this.coords[u],y=this.coords[u+1],S=this.coords[u+2],B=d*h+S*c,x=-d*c+S*h,R=y*E-x*g,k=y*g+x*E;j[u]=B,j[u+1]=R,j[u+2]=k,B<o&&(o=B),B>s&&(s=B),R<i&&(i=R),R>a&&(a=R)}const v=(t-r*2)/Math.max(1e-6,s-o),p=(n-r*2)/Math.max(1e-6,a-i),L=Math.min(v,p)*this.zoom,T=(u,d,y,S)=>{e.beginPath(),e.arc(u,d,S,0,Math.PI*2),e.fillStyle=y,e.fill()},m=getComputedStyle(document.documentElement),f=m.getPropertyValue("--vec-base").trim()||"#8a8a8a",w=m.getPropertyValue("--vec-selected").trim()||"#3d7eff",A=m.getPropertyValue("--vec-result").trim()||"#ffb02e",C=m.getPropertyValue("--vec-query").trim()||"#ff4d4f";for(let u=0,d=0;u<this.rows.length;u+=1,d+=3){const y=r+(j[d]-o)*L+this.panX,S=n-(r+(j[d+1]-i)*L)+this.panY;let B=f,x=2;this.selectedIndices.has(u)&&(B=w,x=2.5),this.resultIndices.has(u)&&(B=A,x=3),T(y,S,B,x)}if(this.queryPoint){const[u,d,y=0]=this.queryPoint,S=u*h+y*c,B=-u*c+y*h,x=d*E-B*g,R=r+(S-o)*L+this.panX,k=n-(r+(x-i)*L)+this.panY;T(R,k,C,4)}}updateLegend(){if(!this.rows.length){this.elements.legend.textContent="";return}this.elements.legend.textContent=`Total: ${this.rows.length} • Selected: ${this.selectedIndices.size} • Results: ${this.resultIndices.size}`}computeUMAP(){if(!this.rows.length){this.coords=new Float32Array,this.basis=[];return}const e=this.rows.map(t=>t.umap3d??[NaN,NaN,NaN]);this.coords=new Float32Array(e.length*3);for(let t=0;t<e.length;t+=1)this.coords[t*3]=e[t][0],this.coords[t*3+1]=e[t][1],this.coords[t*3+2]=e[t][2];this.resetView()}computePCA(){if(!this.rows.length){this.coords=new Float32Array,this.basis=[];return}const e=this.rows.map(i=>i.embedding),t=D.getEigenVectors(e)??[];this.basis=t.slice(0,3);const n=D.computeAdjustedData(e,...this.basis).adjustedData,r=n[0]??[],o=n[1]??new Array(r.length).fill(0),s=n[2]??new Array(r.length).fill(0);this.coords=new Float32Array(r.length*3);for(let i=0;i<r.length;i+=1)this.coords[i*3]=r[i],this.coords[i*3+1]=o[i],this.coords[i*3+2]=s[i];this.resetView()}resetView(){this.yaw=0,this.pitch=0,this.zoom=1,this.panX=0,this.panY=0}indexRows(){this.indicesByRowId.clear(),this.indicesByPath.clear(),this.indicesByDocumentId.clear(),this.rows.forEach((e,t)=>{if(e.id&&this.indicesByRowId.set(e.id,t),e.path){const n=this.indicesByPath.get(e.path)??[];n.push(t),this.indicesByPath.set(e.path,n)}if(e.document_id){const n=this.indicesByDocumentId.get(e.document_id)??[];n.push(t),this.indicesByDocumentId.set(e.document_id,n)}})}async loadAvailability(){try{const e=await M.vectorStatus();if(!e){this.available=!1,this.elements.vectorBtn.classList.add("hidden");return}this.handleVectorStatus(e)}catch{this.available=!1,this.elements.vectorBtn.classList.add("hidden")}}handleVectorStatus(e){if(this.available=!!(e!=null&&e.available),this.available){this.elements.vectorBtn.classList.remove("hidden"),this.elements.reindexBtn.classList.remove("hidden"),this.elements.refitBtn.classList.remove("hidden");const t=[];e.count!=null&&t.push(`Embeddings: ${e.count}`),e.dimensions!=null&&t.push(`Dims: ${e.dimensions}`),t.length&&(this.elements.legend.textContent=t.join(" • "))}else this.elements.vectorBtn.classList.add("hidden"),this.elements.reindexBtn.classList.add("hidden"),this.elements.refitBtn.classList.add("hidden")}async loadEmbeddings(){this.setStatus("Loading embeddings…");try{this.rows=[];let e=await M.vectorEmbeddings({offset:0});for(;e&&e.length>0;)this.rows.push(...e),e=await M.vectorEmbeddings({offset:this.rows.length});this.setStatus("Indexing embeddings…"),this.indexRows(),this.computeUMAP(),this.setStatus(""),this.updateLegend(),this.render()}catch(e){console.error(e),this.setStatus("Failed to load embeddings")}}resetForProjectChange(){this.available=!1,this.active=!1,this.initialized=!1,this.rows=[],this.coords=new Float32Array,this.basis=[],this.indicesByPath.clear(),this.indicesByDocumentId.clear(),this.indicesByRowId.clear(),this.selectedIndices.clear(),this.resultIndices.clear(),this.queryPoint=null,this.resetView(),this.elements.vectorBtn.classList.add("hidden"),this.elements.reindexBtn.classList.add("hidden"),this.elements.refitBtn.classList.add("hidden"),this.elements.legend.textContent="",this.setStatus(""),this.showBrowse()}async projectQueryEmbedding(e){var t,n,r;try{const o=await M.vectorQueryEmbedding(e);if(!o)return null;const s=o.embedding??[];if(!s.length||!this.rows.length||(this.basis.length===0&&this.computePCA(),this.basis.length===0))return null;const i=D.computeAdjustedData([s],...this.basis).adjustedData,a=((t=i[0])==null?void 0:t[0])??0,h=((n=i[1])==null?void 0:n[0])??0,c=((r=i[2])==null?void 0:r[0])??0;return[a,h,c]}catch{return null}}wireInteractions(){const e=this.elements.canvas;e.addEventListener("mousedown",t=>{this.lastX=t.clientX,this.lastY=t.clientY,this.dragMode=t.button===0&&!t.shiftKey?"rotate":"pan",t.preventDefault()}),window.addEventListener("mousemove",t=>{if(!this.dragMode)return;const n=t.clientX-this.lastX,r=t.clientY-this.lastY;if(this.lastX=t.clientX,this.lastY=t.clientY,this.dragMode==="rotate"){this.yaw+=n*.01,this.pitch+=r*.01;const o=Math.PI/2-.001;this.pitch=Math.max(-o,Math.min(o,this.pitch))}else this.panX+=n,this.panY+=r;this.active&&this.render()}),window.addEventListener("mouseup",()=>{this.dragMode=null}),e.addEventListener("wheel",t=>{const n=-t.deltaY,r=Math.exp(n*.0015);this.zoom=Math.max(.2,Math.min(10,this.zoom*r)),this.active&&this.render(),t.preventDefault()},{passive:!1}),new ResizeObserver(()=>{this.active&&this.render()}).observe(this.elements.canvasContainer)}wireAdminButtons(){const{reindexBtn:e,refitBtn:t}=this.elements;e.addEventListener("click",async()=>{if(!(!this.available||e.disabled)){this.setStatus("Reindexing…"),e.disabled=!0,t.disabled=!0;try{const n=await M.vectorReindex(),r=(n==null?void 0:n.status)??"ok";this.setStatus(r==="queued"?"Reindex queued (running in background)":`Reindex: ${r}`)}catch(n){console.error(n),this.setStatus("Reindex failed")}finally{e.disabled=!1,t.disabled=!1}}}),t.addEventListener("click",async()=>{if(!(!this.available||t.disabled)){this.setStatus("Scheduling UMAP refit…"),e.disabled=!0,t.disabled=!0;try{const n=await M.vectorRefit(),r=(n==null?void 0:n.status)??"ok";this.setStatus(r==="queued"?"UMAP refit queued (running in background)":`Refit: ${r}`)}catch(n){console.error(n),this.setStatus("UMAP refit failed")}finally{e.disabled=!1,t.disabled=!1}}})}}async function me(){let l=null;try{l=new fe,await l.initialize()}catch(t){console.warn("Vector controller unavailable:",t),l=null}await new ae(l).start()}me();
