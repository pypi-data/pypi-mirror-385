{"version":3,"file":"7328.6d6ad8a807761a88.js","sources":["webpack://knx-frontend/./homeassistant-frontend/src/dialogs/image-cropper-dialog/image-cropper-dialog.ts"],"sourcesContent":["import Cropper from \"cropperjs\";\n// @ts-ignore\nimport cropperCss from \"cropperjs/dist/cropper.css\";\nimport type { CSSResultGroup, PropertyValues, TemplateResult } from \"lit\";\nimport { css, html, nothing, LitElement, unsafeCSS } from \"lit\";\nimport { customElement, property, state, query } from \"lit/decorators\";\nimport { classMap } from \"lit/directives/class-map\";\nimport \"../../components/ha-dialog\";\nimport \"../../components/ha-button\";\nimport { haStyleDialog } from \"../../resources/styles\";\nimport type { HomeAssistant } from \"../../types\";\nimport type { HaImageCropperDialogParams } from \"./show-image-cropper-dialog\";\n\n@customElement(\"image-cropper-dialog\")\nexport class HaImagecropperDialog extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @state() private _params?: HaImageCropperDialogParams;\n\n  @state() private _open = false;\n\n  @query(\"img\", true) private _image!: HTMLImageElement;\n\n  private _cropper?: Cropper;\n\n  @state() private _isTargetAspectRatio?: boolean;\n\n  public showDialog(params: HaImageCropperDialogParams): void {\n    this._params = params;\n    this._open = true;\n  }\n\n  public closeDialog() {\n    this._open = false;\n    this._params = undefined;\n    this._cropper?.destroy();\n    this._cropper = undefined;\n    this._isTargetAspectRatio = false;\n  }\n\n  protected updated(changedProperties: PropertyValues) {\n    if (!changedProperties.has(\"_params\") || !this._params) {\n      return;\n    }\n    if (!this._cropper) {\n      this._image.src = URL.createObjectURL(this._params.file);\n      this._cropper = new Cropper(this._image, {\n        aspectRatio: this._params.options.aspectRatio,\n        viewMode: 1,\n        dragMode: \"move\",\n        minCropBoxWidth: 50,\n        ready: () => {\n          this._isTargetAspectRatio = this._checkMatchAspectRatio();\n          URL.revokeObjectURL(this._image!.src);\n        },\n      });\n    } else {\n      this._cropper.replace(URL.createObjectURL(this._params.file));\n    }\n  }\n\n  private _checkMatchAspectRatio(): boolean {\n    const targetRatio = this._params?.options.aspectRatio;\n    if (!targetRatio) {\n      return true;\n    }\n    const imageData = this._cropper!.getImageData();\n    if (imageData.aspectRatio === targetRatio) {\n      return true;\n    }\n\n    // If the image is not exactly the aspect ratio see if it is within a pixel.\n    if (imageData.naturalWidth > imageData.naturalHeight) {\n      const targetHeight = imageData.naturalWidth / targetRatio;\n      return Math.abs(targetHeight - imageData.naturalHeight) <= 1;\n    }\n    const targetWidth = imageData.naturalHeight * targetRatio;\n    return Math.abs(targetWidth - imageData.naturalWidth) <= 1;\n  }\n\n  protected render(): TemplateResult {\n    return html`<ha-dialog\n      @closed=${this.closeDialog}\n      scrimClickAction\n      escapeKeyAction\n      .open=${this._open}\n    >\n      <div\n        class=\"container ${classMap({\n          round: Boolean(this._params?.options.round),\n        })}\"\n      >\n        <img alt=${this.hass.localize(\"ui.dialogs.image_cropper.crop_image\")} />\n      </div>\n      <ha-button\n        appearance=\"plain\"\n        slot=\"primaryAction\"\n        @click=${this.closeDialog}\n      >\n        ${this.hass.localize(\"ui.common.cancel\")}\n      </ha-button>\n      ${this._isTargetAspectRatio\n        ? html`<ha-button\n            appearance=\"plain\"\n            slot=\"primaryAction\"\n            @click=${this._useOriginal}\n          >\n            ${this.hass.localize(\"ui.dialogs.image_cropper.use_original\")}\n          </ha-button>`\n        : nothing}\n\n      <ha-button slot=\"primaryAction\" @click=${this._cropImage}>\n        ${this.hass.localize(\"ui.dialogs.image_cropper.crop\")}\n      </ha-button>\n    </ha-dialog>`;\n  }\n\n  private _cropImage() {\n    this._cropper!.getCroppedCanvas().toBlob(\n      (blob) => {\n        if (!blob) {\n          return;\n        }\n        const file = new File([blob], this._params!.file.name, {\n          type: this._params!.options.type || this._params!.file.type,\n        });\n        this._params!.croppedCallback(file);\n        this.closeDialog();\n      },\n      this._params!.options.type || this._params!.file.type,\n      this._params!.options.quality\n    );\n  }\n\n  private _useOriginal() {\n    this._params!.croppedCallback(this._params!.file);\n    this.closeDialog();\n  }\n\n  static get styles(): CSSResultGroup {\n    return [\n      haStyleDialog,\n      css`\n        ${unsafeCSS(cropperCss)}\n        .container {\n          max-width: 640px;\n        }\n        img {\n          max-width: 100%;\n        }\n        .container.round .cropper-view-box,\n        .container.round .cropper-face {\n          border-radius: 50%;\n        }\n        .cropper-line,\n        .cropper-point,\n        .cropper-point.point-se::before {\n          background-color: var(--primary-color);\n        }\n      `,\n    ];\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"image-cropper-dialog\": HaImagecropperDialog;\n  }\n}\n"],"names":["HaImagecropperDialog","LitElement","showDialog","params","this","_params","_open","closeDialog","_this$_cropper","undefined","_cropper","destroy","_isTargetAspectRatio","updated","changedProperties","has","replace","URL","createObjectURL","file","_image","src","Cropper","aspectRatio","options","viewMode","dragMode","minCropBoxWidth","ready","_checkMatchAspectRatio","revokeObjectURL","_this$_params","targetRatio","imageData","getImageData","naturalWidth","naturalHeight","targetHeight","Math","abs","targetWidth","render","_this$_params2","html","_t","_","classMap","round","Boolean","hass","localize","_t2","_useOriginal","nothing","_cropImage","getCroppedCanvas","toBlob","blob","File","name","type","croppedCallback","quality","styles","haStyleDialog","css","_t3","unsafeCSS","cropperCss","args","attribute"],"mappings":"4cAcO,MAAPA,UAAAC,EAAAA,GAaSC,UAAAA,CAAAC,GACLC,KAAAC,QAAAF,EACAC,KAAAE,OAAA,CACF,CAEOC,WAAAA,GAAA,IAAAC,EACLJ,KAAAE,OAAA,EACAF,KAAAC,aAAAI,EACA,QAAAD,EAAAJ,KAAAM,gBAAA,IAAAF,GAAAA,EAAAG,UACAP,KAAAM,cAAAD,EACAL,KAAAQ,sBAAA,CACF,CAEUC,OAAAA,CAAAC,GACRA,EAAAC,IAAA,iBAAAV,UAGKD,KAALM,SAaEN,KAAAM,SAAAM,QAAAC,IAAAC,gBAAAd,KAAAC,QAAAc,QAZAf,KAAAgB,OAAAC,IAAAJ,IAAAC,gBAAAd,KAAAC,QAAAc,MACAf,KAAAM,SAAA,IAAAY,IAAA,CAAAlB,KAAAgB,OAAA,CACEG,YAAA,KAAAlB,QAAAmB,QAAAD,YACAE,SAAA,EACAC,SAAA,OACAC,gBAAA,GACAC,MAAAA,KACExB,KAAAQ,qBAAAR,KAAAyB,yBACAZ,IAAAa,gBAAA,KAAAV,OAAAC,IAAA,KAMR,CAEQQ,sBAAAA,GAAA,IAAAE,EACN,MAAAC,EAAA,QAAAD,EAAA,KAAA1B,eAAA,IAAA0B,OAAA,EAAAA,EAAAP,QAAAD,YACA,IAAAS,EACE,OAAO,EAET,MAAAC,EAAA,KAAAvB,SAAAwB,eACA,GAAAD,EAAAV,cAAAS,EACE,OAAO,EAIT,GAAAC,EAAAE,aAAAF,EAAAG,cAAA,CACE,MAAAC,EAAAJ,EAAAE,aAAAH,EACA,OAAAM,KAAAC,IAAAF,EAAAJ,EAAAG,gBAAA,CACF,CACA,MAAAI,EAAAP,EAAAG,cAAAJ,EACA,OAAAM,KAAAC,IAAAC,EAAAP,EAAAE,eAAA,CACF,CAEUM,MAAAA,GAAA,IAAAC,EACR,OAAAC,EAAAA,EAAAA,IAAAC,IAAAA,EAAAC,CAAA;gBAAA;;;cAAA;;;2BAAA;;mBAAA;;;;;iBAAA;;UAAA;;QAAA;;+CAAA;UAAA;;mBACU,KAAAtC,YAGF,KAAAD,OAGawC,EAAAA,EAAAA,GAAA,CACfC,MAAAC,QAAA,QAAAN,EAAA,KAAArC,eAAA,IAAAqC,OAAA,EAAAA,EAAAlB,QAAAuB,SAGO,KAAAE,KAAAC,SAAA,uCAKF,KAAA3C,YAEP,KAAA0C,KAAAC,SAAA,oBAEF,KAAAtC,sBAAA+B,EAAAA,EAAAA,IAAAQ,IAAAA,EAAAN,CAAA;;;qBAAA;;cAAA;yBAIa,KAAAO,aAEP,KAAAH,KAAAC,SAAA,0CACUG,EAAAA,GAGuB,KAAAC,WACrC,KAAAL,KAAAC,SAAA,iCAGN,CAEQI,UAAAA,GACNlD,KAAAM,SAAA6C,mBAAAC,QAAAC,IAEI,IAAAA,EACE,OAEF,MAAAtC,EAAA,IAAAuC,KAAA,CAAuBD,GAAOrD,KAAFC,QAAAc,KAAAwC,KAAE,CAC5BC,KAAA,KAAAvD,QAAAmB,QAAAoC,MAAA,KAAAvD,QAAAc,KAAAyC,OAEFxD,KAAAC,QAAAwD,gBAAA1C,GACAf,KAAAG,aAAA,GACF,KAAAF,QAAAmB,QAAAoC,MAAA,KAAAvD,QAAAc,KAAAyC,KAAA,KAAAvD,QAAAmB,QAAAsC,QAIJ,CAEQV,YAAAA,GACNhD,KAAAC,QAAAwD,gBAAAzD,KAAAC,QAAAc,MACAf,KAAAG,aACF,CAEA,iBAAAwD,GACE,MAAO,CACLC,EAAAA,IACAC,EAAAA,EAAAA,IAAAC,IAAAA,EAAArB,CAAA;UAAA;;;;;;;;;;;;;;;;UACEsB,EAAAA,EAAAA,IAAAC,IAkBN,C,kBAnJK,SAAAC,GAAA,KAAA/D,OAAA,C,8BACOgE,WAAA,K"}