Metadata-Version: 2.4
Name: realsqltool
Version: 0.1.1
Summary: A Python package for querying Azure SQL Server via ODBC
License-File: LICENSE
Author: Your Name
Author-email: you@example.com
Requires-Python: >=3.8
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: 3.13
Classifier: Programming Language :: Python :: 3.14
Requires-Dist: pandas (>=2.0.0)
Requires-Dist: pyodbc (>=5.0.0)
Description-Content-Type: text/markdown

# RealSQLTool

ä¸€ä¸ªç®€å•æ˜“ç”¨çš„ Python åŒ…ï¼Œç”¨äºé€šè¿‡ ODBC è¿æ¥å’ŒæŸ¥è¯¢ Azure SQL Serverã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸš€ ç®€å•æ˜“ç”¨çš„ API
- ğŸ” æ”¯æŒå¤šç§èº«ä»½éªŒè¯æ–¹å¼ï¼ˆSQL Server èº«ä»½éªŒè¯ã€Windows èº«ä»½éªŒè¯ï¼‰
- ğŸ“Š æ”¯æŒå¤šç§è¿”å›æ ¼å¼ï¼ˆDataFrameã€å­—å…¸ã€å…ƒç»„ï¼‰
- âš¡ æ‰¹é‡æ“ä½œæ”¯æŒ
- ğŸ” è¡¨ç»“æ„æŸ¥è¯¢
- ğŸ›¡ï¸ å‚æ•°åŒ–æŸ¥è¯¢ï¼Œé˜²æ­¢ SQL æ³¨å…¥
- ğŸ“¦ ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ”¯æŒ
- ğŸ’» å‘½ä»¤è¡Œå·¥å…·

## ğŸ“¦ å®‰è£…

### 1. å®‰è£… ODBC é©±åŠ¨

é¦–å…ˆéœ€è¦å®‰è£… Microsoft ODBC Driver for SQL Serverï¼š

#### Windows
ä» [Microsoft å®˜ç½‘](https://docs.microsoft.com/en-us/sql/connect/odbc/download-odbc-driver-for-sql-server) ä¸‹è½½å¹¶å®‰è£… **ODBC Driver 17 for SQL Server** æˆ–æ›´é«˜ç‰ˆæœ¬

#### Linux (Ubuntu/Debian)
```bash
curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
sudo apt-get update
sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17
```

#### macOS
```bash
brew tap microsoft/mssql-release https://github.com/Microsoft/homebrew-mssql-release
brew update
brew install msodbcsql17
```

### 2. å®‰è£… RealSQLTool

```bash
pip install realsqltool
```

### 3. éªŒè¯å®‰è£…

```bash
# åˆ—å‡ºå¯ç”¨çš„ ODBC é©±åŠ¨
realsqltool drivers
```

æˆ–åœ¨ Python ä¸­ï¼š
```python
from realsqltool.utils import list_odbc_drivers
print(list_odbc_drivers())
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æµ‹è¯•è¿æ¥

```bash
realsqltool test -s myserver.database.windows.net -d mydatabase -u myuser -p mypass
```

### åŸºæœ¬ä½¿ç”¨

```python
from realsqltool import AzureSQLConnection, QueryExecutor

# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆæ¨èï¼‰
with AzureSQLConnection(
    server="myserver.database.windows.net",
    database="mydatabase",
    username="myusername",
    password="mypassword"
) as conn:
    executor = QueryExecutor(conn)
    
    # æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¿”å› pandas DataFrame
    df = executor.execute_query("SELECT * FROM Users")
    print(df)
```

## ğŸ“– ä½¿ç”¨æŒ‡å—

### å‘½ä»¤è¡Œå·¥å…·

```bash
# åˆ—å‡ºå¯ç”¨çš„ ODBC é©±åŠ¨
realsqltool drivers

# æµ‹è¯•è¿æ¥
realsqltool test -s myserver.database.windows.net -d mydatabase -u myuser -p mypass

# åˆ—å‡ºæ•°æ®åº“ä¸­çš„è¡¨
realsqltool tables -s myserver.database.windows.net -d mydatabase -u myuser -p mypass

# æ‰§è¡ŒæŸ¥è¯¢
realsqltool query -s myserver.database.windows.net -d mydatabase -u myuser -p mypass \
  -q "SELECT * FROM Users"

# ä»æ–‡ä»¶æ‰§è¡ŒæŸ¥è¯¢
realsqltool query -s myserver.database.windows.net -d mydatabase -u myuser -p mypass \
  -f query.sql
```

### æ‰§è¡ŒæŸ¥è¯¢

```python
from realsqltool import AzureSQLConnection, QueryExecutor

with AzureSQLConnection(
    server="myserver.database.windows.net",
    database="mydatabase",
    username="myusername",
    password="mypassword"
) as conn:
    executor = QueryExecutor(conn)
    
    # æŸ¥è¯¢å¹¶è¿”å› DataFrame
    df = executor.execute_query("SELECT * FROM Users")
    
    # æŸ¥è¯¢å¹¶è¿”å›å­—å…¸åˆ—è¡¨
    results = executor.execute_query(
        "SELECT * FROM Users WHERE Age > ?",
        params=(18,),
        return_type="dict"
    )
    
    # æŸ¥è¯¢å¹¶è¿”å›å…ƒç»„åˆ—è¡¨
    results = executor.execute_query(
        "SELECT * FROM Users",
        return_type="tuple"
    )
    
    # æ‰§è¡Œæ ‡é‡æŸ¥è¯¢ï¼ˆè·å–å•ä¸ªå€¼ï¼‰
    count = executor.execute_scalar("SELECT COUNT(*) FROM Users")
    print(f"ç”¨æˆ·æ€»æ•°: {count}")
```

### è¯»å–è¡¨æ•°æ®

```python
# è¯»å–æ•´ä¸ªè¡¨
df = executor.read_table("Users")

# è¯»å–ç‰¹å®šåˆ—
df = executor.read_table(
    "Users",
    columns=["Name", "Email", "Age"]
)

# å¸¦æ¡ä»¶æŸ¥è¯¢
df = executor.read_table(
    "Users",
    where_clause="Age >= 18",
    order_by="Name ASC",
    limit=100
)
```

### æ‰§è¡ŒéæŸ¥è¯¢è¯­å¥

```python
# INSERT
rows_affected = executor.execute_non_query(
    "INSERT INTO Users (Name, Email, Age) VALUES (?, ?, ?)",
    params=("å¼ ä¸‰", "zhangsan@example.com", 25)
)

# UPDATE
rows_affected = executor.execute_non_query(
    "UPDATE Users SET Age = ? WHERE Name = ?",
    params=(26, "å¼ ä¸‰")
)

# DELETE
rows_affected = executor.execute_non_query(
    "DELETE FROM Users WHERE Age < ?",
    params=(18,)
)
```

### æ‰¹é‡æ“ä½œ

```python
# æ‰¹é‡æ’å…¥
params_list = [
    ("ç”¨æˆ·1", "user1@example.com", 20),
    ("ç”¨æˆ·2", "user2@example.com", 25),
    ("ç”¨æˆ·3", "user3@example.com", 30),
]

total_rows = executor.execute_batch(
    "INSERT INTO Users (Name, Email, Age) VALUES (?, ?, ?)",
    params_list,
    batch_size=1000
)
print(f"æ’å…¥äº† {total_rows} è¡Œ")
```

### è·å–æ•°æ®åº“å…ƒæ•°æ®

```python
# åˆ—å‡ºæ‰€æœ‰è¡¨
tables = executor.list_tables()
print("æ•°æ®åº“ä¸­çš„è¡¨:", tables)

# åˆ—å‡ºæŒ‡å®š schema çš„è¡¨
tables = executor.list_tables(schema="dbo")

# è·å–è¡¨ç»“æ„
table_info = executor.get_table_info("Users")
print(table_info)
```

### å·¥å…·å‡½æ•°

```python
from realsqltool.utils import list_odbc_drivers, test_connection

# åˆ—å‡ºå¯ç”¨çš„ ODBC é©±åŠ¨
drivers = list_odbc_drivers()
print("å¯ç”¨çš„ ODBC é©±åŠ¨:", drivers)

# æµ‹è¯•è¿æ¥
success, message = test_connection(
    server="myserver.database.windows.net",
    database="mydatabase",
    username="myusername",
    password="mypassword"
)
print(message)
```

## ğŸ“š API æ–‡æ¡£

### AzureSQLConnection

æ•°æ®åº“è¿æ¥ç®¡ç†å™¨ç±»ã€‚

#### å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| `server` | str | Azure SQL Server åœ°å€ | å¿…éœ€ |
| `database` | str | æ•°æ®åº“åç§° | å¿…éœ€ |
| `username` | str | ç”¨æˆ·å | å¯é€‰ |
| `password` | str | å¯†ç  | å¯é€‰ |
| `driver` | str | ODBC é©±åŠ¨åç§° | "ODBC Driver 17 for SQL Server" |
| `**kwargs` | dict | å…¶ä»–è¿æ¥å‚æ•° | - |

#### æ–¹æ³•

- `connect()` - å»ºç«‹è¿æ¥
- `disconnect()` - æ–­å¼€è¿æ¥
- `is_connected()` - æ£€æŸ¥è¿æ¥çŠ¶æ€
- `get_cursor()` - è·å–æ¸¸æ ‡ï¼ˆä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼‰

#### ç¤ºä¾‹

```python
# åŸºæœ¬è¿æ¥
conn = AzureSQLConnection(
    server="myserver.database.windows.net",
    database="mydatabase",
    username="myusername",
    password="mypassword"
)

# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆæ¨èï¼‰
with AzureSQLConnection(...) as conn:
    # è¿æ¥è‡ªåŠ¨ç®¡ç†
    pass

# è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´
conn = AzureSQLConnection(
    server="myserver.database.windows.net",
    database="mydatabase",
    username="myusername",
    password="mypassword",
    **{"Timeout": "60"}
)
```

### QueryExecutor

SQL æŸ¥è¯¢æ‰§è¡Œå™¨ç±»ã€‚

#### å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `connection` | AzureSQLConnection | æ•°æ®åº“è¿æ¥å®ä¾‹ |

#### æ–¹æ³•

##### execute_query()

æ‰§è¡Œ SELECT æŸ¥è¯¢ã€‚

**å‚æ•°:**
- `query` (str): SQL æŸ¥è¯¢è¯­å¥
- `params` (tuple, optional): æŸ¥è¯¢å‚æ•°
- `return_type` (str): è¿”å›ç±»å‹ï¼Œå¯é€‰ "dataframe"ã€"dict"ã€"tuple"ï¼Œé»˜è®¤ "dataframe"

**è¿”å›:** pandas.DataFrame / list[dict] / list[tuple]

##### execute_scalar()

æ‰§è¡Œæ ‡é‡æŸ¥è¯¢ï¼ˆè¿”å›å•ä¸ªå€¼ï¼‰ã€‚

**å‚æ•°:**
- `query` (str): SQL æŸ¥è¯¢è¯­å¥
- `params` (tuple, optional): æŸ¥è¯¢å‚æ•°

**è¿”å›:** å•ä¸ªå€¼

##### execute_non_query()

æ‰§è¡ŒéæŸ¥è¯¢è¯­å¥ï¼ˆINSERTã€UPDATEã€DELETEï¼‰ã€‚

**å‚æ•°:**
- `query` (str): SQL è¯­å¥
- `params` (tuple, optional): æŸ¥è¯¢å‚æ•°

**è¿”å›:** int - å—å½±å“çš„è¡Œæ•°

##### execute_batch()

æ‰¹é‡æ‰§è¡Œè¯­å¥ã€‚

**å‚æ•°:**
- `query` (str): SQL è¯­å¥
- `params_list` (list[tuple]): å‚æ•°åˆ—è¡¨
- `batch_size` (int): æ‰¹æ¬¡å¤§å°ï¼Œé»˜è®¤ 1000

**è¿”å›:** int - æ€»å—å½±å“çš„è¡Œæ•°

##### read_table()

è¯»å–è¡¨æ•°æ®ã€‚

**å‚æ•°:**
- `table_name` (str): è¡¨å
- `columns` (list[str], optional): è¦æŸ¥è¯¢çš„åˆ—
- `where_clause` (str, optional): WHERE æ¡ä»¶
- `order_by` (str, optional): æ’åºæ¡ä»¶
- `limit` (int, optional): é™åˆ¶è¿”å›è¡Œæ•°

**è¿”å›:** pandas.DataFrame

##### get_table_info()

è·å–è¡¨ç»“æ„ä¿¡æ¯ã€‚

**å‚æ•°:**
- `table_name` (str): è¡¨å

**è¿”å›:** pandas.DataFrame - åŒ…å«åˆ—åã€æ•°æ®ç±»å‹ã€æ˜¯å¦å¯ç©ºç­‰ä¿¡æ¯

##### list_tables()

åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ã€‚

**å‚æ•°:**
- `schema` (str): Schema åç§°ï¼Œé»˜è®¤ "dbo"

**è¿”å›:** list[str] - è¡¨ååˆ—è¡¨

## ğŸ’¡ å®Œæ•´ç¤ºä¾‹

```python
from realsqltool import AzureSQLConnection, QueryExecutor

# è¿æ¥é…ç½®
config = {
    "server": "myserver.database.windows.net",
    "database": "mydatabase",
    "username": "myusername",
    "password": "mypassword"
}

# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
with AzureSQLConnection(**config) as conn:
    executor = QueryExecutor(conn)
    
    # 1. åˆ—å‡ºæ‰€æœ‰è¡¨
    tables = executor.list_tables()
    print(f"æ•°æ®åº“åŒ…å« {len(tables)} ä¸ªè¡¨")
    
    # 2. æŸ¥è¯¢æ•°æ®
    df = executor.execute_query("""
        SELECT TOP 10
            Name,
            Email,
            Age
        FROM Users
        WHERE Age >= ?
        ORDER BY Age DESC
    """, params=(18,))
    print(df)
    
    # 3. è·å–ç»Ÿè®¡ä¿¡æ¯
    avg_age = executor.execute_scalar("SELECT AVG(Age) FROM Users")
    print(f"å¹³å‡å¹´é¾„: {avg_age:.2f}")
    
    # 4. æ‰¹é‡æ’å…¥æ•°æ®
    users = [
        ("ç”¨æˆ·1", "user1@example.com", 20),
        ("ç”¨æˆ·2", "user2@example.com", 25),
        ("ç”¨æˆ·3", "user3@example.com", 30),
    ]
    rows = executor.execute_batch(
        "INSERT INTO Users (Name, Email, Age) VALUES (?, ?, ?)",
        users
    )
    print(f"æ’å…¥äº† {rows} è¡Œ")
    
    # 5. æ›´æ–°æ•°æ®
    rows = executor.execute_non_query(
        "UPDATE Users SET Email = ? WHERE Name = ?",
        params=("newemail@example.com", "ç”¨æˆ·1")
    )
    print(f"æ›´æ–°äº† {rows} è¡Œ")
    
    # 6. è·å–è¡¨ç»“æ„
    table_info = executor.get_table_info("Users")
    print("\nè¡¨ç»“æ„:")
    print(table_info)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ODBC é©±åŠ¨**: ç¡®ä¿å·²å®‰è£…æ­£ç¡®ç‰ˆæœ¬çš„ ODBC é©±åŠ¨ç¨‹åºï¼ˆæ¨è ODBC Driver 17 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰
2. **æœåŠ¡å™¨åœ°å€**: Azure SQL Database çš„æœåŠ¡å™¨åœ°å€æ ¼å¼ä¸º `<server-name>.database.windows.net`
3. **å‚æ•°åŒ–æŸ¥è¯¢**: å§‹ç»ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆ`?` å ä½ç¬¦ï¼‰æ¥é˜²æ­¢ SQL æ³¨å…¥
4. **ä¸Šä¸‹æ–‡ç®¡ç†å™¨**: ä½¿ç”¨ `with` è¯­å¥å¯ä»¥ç¡®ä¿è¿æ¥æ­£ç¡®å…³é—­
5. **æ‰¹é‡æ“ä½œ**: å¤§æ‰¹é‡æ“ä½œæ—¶ï¼Œå»ºè®®ä½¿ç”¨ `execute_batch()` æ–¹æ³•å¹¶è®¾ç½®åˆé€‚çš„ `batch_size`
6. **é˜²ç«å¢™è®¾ç½®**: ç¡®ä¿ Azure SQL Server çš„é˜²ç«å¢™å…è®¸ä½ çš„ IP åœ°å€è®¿é—®

## ğŸ› å¸¸è§é—®é¢˜

### 1. æ‰¾ä¸åˆ° ODBC é©±åŠ¨

**é”™è¯¯ä¿¡æ¯:**
```
pyodbc.Error: ('01000', "[01000] [unixODBC][Driver Manager]Can't open lib 'ODBC Driver 17 for SQL Server'")
```

**è§£å†³æ–¹æ¡ˆ:**
- ç¡®ä¿å·²å®‰è£… ODBC é©±åŠ¨
- è¿è¡Œ `realsqltool drivers` æŸ¥çœ‹å¯ç”¨é©±åŠ¨
- åœ¨åˆ›å»ºè¿æ¥æ—¶æŒ‡å®šæ­£ç¡®çš„é©±åŠ¨åç§°ï¼š
  ```python
  conn = AzureSQLConnection(
      server="...",
      database="...",
      username="...",
      password="...",
      driver="ODBC Driver 18 for SQL Server"  # ä½¿ç”¨å®é™…å®‰è£…çš„é©±åŠ¨
  )
  ```

### 2. è¿æ¥è¶…æ—¶

**é”™è¯¯ä¿¡æ¯:**
```
pyodbc.OperationalError: ('08001', 'Connection timeout')
```

**è§£å†³æ–¹æ¡ˆ:**
```python
conn = AzureSQLConnection(
    server="myserver.database.windows.net",
    database="mydatabase",
    username="myusername",
    password="mypassword",
    **{"Timeout": "60"}  # å¢åŠ è¶…æ—¶æ—¶é—´åˆ° 60 ç§’
)
```

### 3. é˜²ç«å¢™é˜»æ­¢è¿æ¥

**é”™è¯¯ä¿¡æ¯:**
```
Cannot open server 'xxx' requested by the login
```

**è§£å†³æ–¹æ¡ˆ:**
- åœ¨ Azure é—¨æˆ·ä¸­é…ç½®é˜²ç«å¢™è§„åˆ™
- æ·»åŠ ä½ çš„ IP åœ°å€åˆ°å…è®¸åˆ—è¡¨
- æˆ–å¯ç”¨"å…è®¸ Azure æœåŠ¡è®¿é—®"é€‰é¡¹

### 4. èº«ä»½éªŒè¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯:**
```
Login failed for user 'xxx'
```

**è§£å†³æ–¹æ¡ˆ:**
- éªŒè¯ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®ä¿ç”¨æˆ·æœ‰è®¿é—®è¯¥æ•°æ®åº“çš„æƒé™
- å¯¹äº Azure SQLï¼Œç”¨æˆ·åæ ¼å¼å¯èƒ½éœ€è¦æ˜¯ `username@servername`

## ğŸ“ é¡¹ç›®ç»“æ„

```
realsqltool/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ realsqltool/
â”‚       â”œâ”€â”€ __init__.py      # åŒ…åˆå§‹åŒ–
â”‚       â”œâ”€â”€ connection.py    # è¿æ¥ç®¡ç†
â”‚       â”œâ”€â”€ query.py         # æŸ¥è¯¢æ‰§è¡Œ
â”‚       â”œâ”€â”€ utils.py         # å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ cli.py           # å‘½ä»¤è¡Œå·¥å…·
â”œâ”€â”€ examples/                # ç¤ºä¾‹ä»£ç 
â”‚   â”œâ”€â”€ basic_usage.py
â”‚   â”œâ”€â”€ advanced_usage.py
â”‚   â””â”€â”€ sample_query.sql
â”œâ”€â”€ tests/                   # å•å…ƒæµ‹è¯•
â”œâ”€â”€ pyproject.toml           # é¡¹ç›®é…ç½®
â”œâ”€â”€ requirements.txt         # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md                # æœ¬æ–‡æ¡£
```

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“ æ›´æ–°æ—¥å¿—

æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£ç‰ˆæœ¬æ›´æ–°å†å²ã€‚

