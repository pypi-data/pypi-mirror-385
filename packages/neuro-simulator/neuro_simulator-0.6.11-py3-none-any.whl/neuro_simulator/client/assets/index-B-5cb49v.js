var G=Object.defineProperty;var Q=(n,e,t)=>e in n?G(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var a=(n,e,t)=>Q(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();window.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-tooltip]").forEach(e=>{const t=document.createElement("div");t.className="tooltip",t.textContent=e.getAttribute("data-tooltip")||"",document.body.appendChild(t);function s(){const o=e.getBoundingClientRect(),r=window.pageXOffset,h=window.pageYOffset,g=50;let m,z;if(o.top<g)m=o.bottom+h+8,z="translateX(-50%)",t.classList.add("tooltip-arrow-up"),t.classList.remove("tooltip-arrow-down");else{t.style.left=o.left+o.width/2+r+"px",t.style.top=o.top+h+"px",t.style.transform="translateX(-50%)",t.classList.add("show");const j=t.offsetHeight;m=o.top+h-j-8,t.classList.remove("show"),t.style.top=m+"px",t.classList.add("tooltip-arrow-down"),t.classList.remove("tooltip-arrow-up")}t.style.left=o.left+o.width/2+r+"px",t.style.top=m+"px",t.style.transform=z,t.classList.add("show")}function i(){t.classList.remove("show")}e.addEventListener("mouseenter",s),e.addEventListener("mouseleave",i)})});window.addEventListener("DOMContentLoaded",()=>{const n="https://twitchtracker.com/api/channels/summary/vedal987",e=document.getElementById("avg-viewers");let t=0;const s=1;let i=null;async function o(){try{const r=new AbortController,h=setTimeout(()=>r.abort(),3e3),g=await fetch(n,{signal:r.signal});if(clearTimeout(h),!g.ok)throw new Error(`HTTP error! status: ${g.status}`);const m=await g.json();if(m&&typeof m.avg_viewers=="number")e.textContent=m.avg_viewers.toLocaleString(),t=0,i&&clearTimeout(i),i=setTimeout(o,300*60*1e3);else throw new Error("接口数据格式异常")}catch(r){console.warn("获取 avg_viewers 失败:",r.message),t++,t>s?(console.log("停止获取，1分钟后重试..."),setTimeout(()=>{t=0,o()},60*1e3)):o()}}o()});const p=document.getElementById("chat-messages"),w=document.getElementById("twitch-chat-overlay"),y=document.getElementById("highlight-message-overlay"),U="One_of_Swarm";class Z{constructor(){p?console.log("ChatDisplay initialized."):console.error("ChatDisplay: Required chat messages container not found in DOM!")}appendChatMessage(e){if(!p){console.error("ChatDisplay: Cannot append message, container not found.");return}const t=document.createElement("div");t.className="chat-line__message";const s=document.createElement("div");s.className="chat-line__message-container",e.username===U&&e.is_user_message?t.classList.add("user-sent-message"):e.username==="System"?t.classList.add("system-message"):t.classList.add("audience-ai-message");const i=document.createElement("span");i.className="chat-line__username",i.style.color=e.username===U?"#9147FF":this.getRandomChatColor();const o=document.createElement("span");o.className="chat-author__display-name",o.textContent=e.username,i.appendChild(o);const r=document.createElement("span");r.textContent=": ",r.style.marginRight="0.3rem",r.className="text-fragment";const h=document.createElement("span");if(h.className="text-fragment",h.textContent=e.text,s.appendChild(i),s.appendChild(r),s.appendChild(h),t.appendChild(s),p.appendChild(t),w){const g=t.cloneNode(!0);w.appendChild(g),this.scrollToBottomOverlay()}this.scrollToBottom()}clearChat(){p&&(p.innerHTML="",console.log("Chat display cleared.")),w&&(w.innerHTML="")}scrollToBottom(){p&&(p.scrollTop=p.scrollHeight)}scrollToBottomOverlay(){w&&(w.scrollTop=w.scrollHeight)}getRandomChatColor(){const e=["#FF0000","#00FF00","#0000FF","#00FFFF","#FF00FF","#FF4500","#ADFF2F","#1E90FF","#FFD700","#8A2BE2","#00CED1","#FF69B4","#DA70D6","#BA55D3","#87CEEB","#32CD32","#CD853F"];return e[Math.floor(Math.random()*e.length)]}}function J(n,e,t){if(!y)return;const s=t==="bits"?"/sc_purple.png":"/sc_pink.png";y.innerHTML=`
        <img src="${s}" class="sc-background-image" alt="Super Chat background">
        <div class="sc-content">
            <div class="sc-user">${n}</div>
            <div class="sc-message">${e}</div>
        </div>
    `;const i=y.querySelector(".sc-message");i&&(i.style.color=t==="bits"?"var(--sc-purple-bg-color)":"var(--sc-pink-bg-color)"),y.classList.remove("hidden"),y.offsetHeight,y.classList.add("is-visible"),setTimeout(()=>{y.classList.remove("is-visible"),setTimeout(()=>{y.classList.add("hidden")},1e3)},9e3)}class X{constructor(e){a(this,"ws",null);a(this,"options");a(this,"reconnectAttempts",0);a(this,"reconnectTimeout",null);a(this,"explicitlyClosed",!1);this.options={reconnectInterval:3e3,maxReconnectAttempts:10,...e}}connect(){if(!this.options.url){console.warn("WebSocket URL is not set. Connection aborted.");return}if(this.ws&&(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING)){console.warn(`WebSocket for ${this.options.url} is already connected or connecting.`);return}this.explicitlyClosed=!1,console.log(`Connecting to WebSocket: ${this.options.url}`),this.ws=new WebSocket(this.options.url),this.ws.onopen=()=>{var e,t;console.log(`WebSocket connected: ${this.options.url}`),this.reconnectAttempts=0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),(t=(e=this.options).onOpen)==null||t.call(e)},this.ws.onmessage=e=>{var t,s;try{const i=JSON.parse(e.data);i.type==="processing_superchat"&&J(i.data.username,i.data.text,i.data.sc_type),(s=(t=this.options).onMessage)==null||s.call(t,i)}catch(i){console.error(`Error parsing message from ${this.options.url}:`,i,e.data)}},this.ws.onclose=e=>{var t,s,i,o;console.warn(`WebSocket closed: ${this.options.url}. Code: ${e.code}, Reason: ${e.reason}`),this.ws=null,(s=(t=this.options).onClose)==null||s.call(t,e),this.explicitlyClosed||((o=(i=this.options).onDisconnect)==null||o.call(i),this.options.autoReconnect&&e.code!==1e3&&this.tryReconnect())},this.ws.onerror=e=>{var t,s;console.error(`WebSocket error: ${this.options.url}`,e),(s=(t=this.options).onError)==null||s.call(t,e)}}tryReconnect(){if(this.options.maxReconnectAttempts===-1||this.reconnectAttempts<this.options.maxReconnectAttempts){this.reconnectAttempts++;const t=this.options.maxReconnectAttempts===-1?`(attempt ${this.reconnectAttempts})`:`(attempt ${this.reconnectAttempts}/${this.options.maxReconnectAttempts})`;console.log(`Attempting to reconnect to ${this.options.url} in ${this.options.reconnectInterval/1e3} seconds... ${t}`),this.reconnectTimeout=setTimeout(()=>{this.connect()},this.options.reconnectInterval)}else console.error(`Max reconnect attempts reached for ${this.options.url}.`)}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.warn(`WebSocket for ${this.options.url} is not open. Message not sent.`)}disconnect(){this.explicitlyClosed=!0,this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.ws&&this.ws.close(1e3,"Client initiated disconnect")}updateOptions(e){console.log("WebSocket client options updated:",e),this.options={...this.options,...e}}getUrl(){return this.options.url}}const c=document.getElementById("neuro-caption"),R=document.getElementById("stream-display-area"),W=16,K=2,T=.4;function D(){if(!c||!R)return;c.style.fontSize="";const n=R.offsetHeight;if(c.textContent===""||n===0)return;if(c.offsetHeight>n*T){const t=window.getComputedStyle(c);let s=parseFloat(t.fontSize);for(;c.offsetHeight>n*T&&s>W;)s-=K,c.style.fontSize=`${s}px`;c.offsetHeight>n*T&&(c.style.fontSize=`${W}px`)}}let L=null,k=null;const Y=3e3;function q(n,e){if(c)if(c.classList.add("show"),e&&n.trim().length>0){const t=n.split(/\s+/).filter(r=>r.length>0);if(t.length===0){c.textContent+=(c.textContent?" ":"")+n,D();return}const s=n.length;let i=c.textContent||"";const o=r=>{if(r<t.length){const h=t[r],g=h.length/s*e*1.01,m=Math.max(50,g*1e3);i+=(i.length>0?" ":"")+h,c.textContent=i,D(),L=setTimeout(()=>o(r+1),m)}else L=null};o(0),console.log(`Starting word-by-word caption for: "${n.substring(0,30)}..." (duration: ${e}s)`)}else c.textContent+=(c.textContent?" ":"")+n,D(),console.log(`Displaying full caption: "${n.substring(0,30)}..."`)}function M(){c&&(L&&(clearTimeout(L),L=null),k&&(clearTimeout(k),k=null),c.classList.remove("show"),c.textContent="",c.style.fontSize="",console.log("NeuroCaption hidden and cleared."))}function ee(){k&&clearTimeout(k),k=setTimeout(()=>{M()},Y)}!c||!R?console.error("neuroCaption.ts: Could not find #neuro-caption or #stream-display-area element."):console.log("NeuroCaption module initialized.");class te{constructor(){a(this,"audioQueue",[]);a(this,"isPlayingAudio",!1);a(this,"currentPlayingAudio",null);a(this,"allSegmentsReceived",!1);a(this,"errorSound");a(this,"lastSegmentEnd",!0);this.errorSound=new Audio("/error.mp3"),console.log("AudioPlayer initialized.")}playErrorSound(){this.stopAllAudio(),console.log("Playing dedicated error sound..."),this.errorSound.play().catch(e=>{console.error("Error playing dedicated error sound:",e)})}addAudioSegment(e,t,s){this.lastSegmentEnd&&M(),this.lastSegmentEnd=!1;const i=new Audio("data:audio/mp3;base64,"+t);try{const r=f.getAppInitializer().getMuteButton();i.muted=r.getIsMuted()}catch(o){console.warn("Could not get mute state, defaulting to muted:",o),i.muted=!0}this.audioQueue.push({text:e,audio:i,duration:s}),console.log(`Audio segment added to queue. Queue size: ${this.audioQueue.length}`),this.isPlayingAudio||this.playNextAudioSegment()}playNextAudioSegment(){if(this.audioQueue.length>0&&!this.isPlayingAudio){this.isPlayingAudio=!0;const e=this.audioQueue.shift();this.currentPlayingAudio=e.audio,q(e.text,e.duration),this.currentPlayingAudio.play().catch(t=>{console.error("Error playing audio segment:",t),this.isPlayingAudio=!1,this.currentPlayingAudio=null,this.playNextAudioSegment()}),this.currentPlayingAudio.addEventListener("ended",()=>{this.isPlayingAudio=!1,this.currentPlayingAudio=null,this.playNextAudioSegment()},{once:!0})}else if(this.audioQueue.length===0&&this.allSegmentsReceived){console.log("Neuro's full audio response played. Starting caption timeout and resetting zoom."),ee();try{f.getAppInitializer().getNeuroAvatar().resetZoom()}catch(e){console.warn("Could not reset neuro avatar zoom at end of speech",e)}}}setAllSegmentsReceived(){this.allSegmentsReceived=!0,this.lastSegmentEnd=!0}stopAllAudio(){this.currentPlayingAudio&&(this.currentPlayingAudio.pause(),this.currentPlayingAudio.currentTime=0,this.currentPlayingAudio=null),this.audioQueue.length=0,this.isPlayingAudio=!1,this.allSegmentsReceived=!1,M();try{f.getAppInitializer().getNeuroAvatar().resetZoom()}catch(e){console.warn("Could not reset neuro avatar zoom on stop",e)}console.log("Neuro audio playback stopped, queue cleared.")}updateMuteState(){if(this.currentPlayingAudio)try{const t=f.getAppInitializer().getMuteButton();this.currentPlayingAudio.muted=t.getIsMuted()}catch(e){console.warn("Could not update current audio mute state:",e)}for(const e of this.audioQueue)try{const s=f.getAppInitializer().getMuteButton();e.audio.muted=s.getIsMuted()}catch(t){console.warn("Could not update queued audio mute state:",t)}}}const E=document.getElementById("startup-video-overlay"),d=document.getElementById("startup-video");class se{constructor(){!E||!d?console.error("VideoPlayer: Required video elements not found in DOM!"):console.log("VideoPlayer initialized.")}showAndPlayVideo(e=0){if(!E||!d){console.error("VideoPlayer: Cannot show and play video, elements are missing.");return}E.classList.remove("hidden"),E.style.zIndex="10";const s=f.getAppInitializer().getMuteButton();d.muted=!1;const i=d.play();i!==void 0&&i.then(()=>{console.log("Unmuted autoplay successful."),this.seekTo(e)}).catch(o=>{console.warn("Unmuted autoplay failed. Showing unmute prompt and falling back to muted playback.",o),s.show(),d.muted=!0,d.play().then(()=>{console.log("Muted fallback playback started."),this.seekTo(e)}).catch(h=>{console.error("Muted fallback playback also failed. This is unexpected.",h)})})}seekTo(e){if(!d)return;const t=()=>{isFinite(d.duration)&&e>.1&&e<d.duration&&(d.currentTime=e,console.log(`Seek performed. Target: ${e.toFixed(2)}s.`))};d.readyState>=1?t():(console.log("Video metadata not ready, waiting for 'loadedmetadata' event to seek."),d.addEventListener("loadedmetadata",t,{once:!0}))}pauseAndMute(){d&&(d.pause(),d.muted=!0,console.log("Startup video paused and muted."))}hide(){E&&(E.classList.add("hidden"),console.log("Startup video overlay hidden."))}getVideoDuration(){return d&&!isNaN(d.duration)?d.duration:0}}const v={HIDDEN:"hidden",STEP1:"step1",STEP2:"step2"},l=document.getElementById("neuro-static-avatar-container");class ne{constructor(){l?(console.log("NeuroAvatar initialized."),this.setStage(v.HIDDEN,!0)):console.error("NeuroAvatar: Required avatar container element not found in DOM!")}startIntroAnimation(e){console.log("Starting Neuro intro animation sequence..."),this.setStage(v.STEP1),setTimeout(()=>{console.log("Animating to Step 2..."),this.setStage(v.STEP2),setTimeout(()=>{console.log("Neuro intro animation sequence finished."),e&&e()},1e3)},2e3)}setStage(e,t=!1){if(!l)return;const s="transform 0.5s ease-in-out";switch(t?(l.style.transition="none",l.offsetHeight):e===v.STEP2?l.style.transition=`bottom 1s cubic-bezier(0.4, 0.0, 1, 1), ${s}`:l.style.transition=s,e){case v.HIDDEN:l.style.visibility="hidden",l.style.bottom="-207%",l.style.left="70%",l.style.zIndex="10";break;case v.STEP1:l.style.visibility="visible",l.style.bottom="-207%",l.style.left="70%",l.style.zIndex="15";break;case v.STEP2:l.style.visibility="visible",l.style.bottom="-125%",l.style.left="70%",l.style.zIndex="15";break}}triggerSpin(){l&&(console.log("Triggering avatar spin animation."),l.classList.add("spin-animation"),setTimeout(()=>{l.classList.remove("spin-animation"),console.log("Avatar spin animation finished.")},1e3))}triggerZoom(){l&&(console.log("Triggering avatar zoom-in animation."),l.classList.add("zoom-in"))}resetZoom(){l&&l.classList.contains("zoom-in")&&(console.log("Resetting avatar zoom."),l.classList.remove("zoom-in"))}}const I=document.getElementById("chat-input"),O=document.getElementById("send-button"),S=document.getElementById("sc-bits-button"),C=document.getElementById("sc-points-button");class ie{constructor(){a(this,"onSendMessageCallback",null);!I||!O||!S||!C?console.error("UserInput: Required input elements not found in DOM!"):(this.setupEventListeners(),console.log("UserInput initialized."))}onSendMessage(e){this.onSendMessageCallback=e}setupEventListeners(){O.addEventListener("click",()=>this.handleSendMessage()),I.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleSendMessage()}),S.addEventListener("click",()=>this.toggleSuperchatButton(S)),C.addEventListener("click",()=>this.toggleSuperchatButton(C))}toggleSuperchatButton(e){const t=e===S?C:S;e.classList.contains("selected")?e.classList.remove("selected"):(e.classList.add("selected"),t.classList.remove("selected"))}handleSendMessage(){const e=I.value.trim();if(!e){console.warn("Attempted to send empty message.");return}let t;const s=S.classList.contains("selected"),i=C.classList.contains("selected");s||i?t={type:"superchat",text:e,sc_type:s?"bits":"points"}:t={type:"user_message",text:e},this.onSendMessageCallback?this.onSendMessageCallback(t):console.warn("No callback registered for sending message."),I.value="",this.clearSuperchatSelection()}clearSuperchatSelection(){S.classList.remove("selected"),C.classList.remove("selected")}setInputDisabled(e){I.disabled=e,O.disabled=e,console.log(`User input elements disabled: ${e}`)}}class oe{constructor(){a(this,"viewportElement");a(this,"areaElement");a(this,"resizeObserver");if(this.viewportElement=document.getElementById("stream-display-viewport"),this.areaElement=document.getElementById("stream-display-area"),!this.viewportElement||!this.areaElement)throw new Error("LayoutManager: Required viewport or area element not found in DOM!");this.resizeObserver=new ResizeObserver(this.handleResize.bind(this))}handleResize(e){for(const t of e){const{width:s,height:i}=t.contentRect;this.updateLayout(s,i)}}updateLayout(e,t){if(e===0||t===0)return;const s=e/t,i=16/9;let o,r;s>i?(r=t,o=r*i):(o=e,r=o/i),this.areaElement.style.width=`${o}px`,this.areaElement.style.height=`${r}px`}start(){this.resizeObserver.observe(this.viewportElement),this.updateLayout(this.viewportElement.clientWidth,this.viewportElement.clientHeight),console.log("LayoutManager started and observing.")}stop(){this.resizeObserver.disconnect(),console.log("LayoutManager stopped.")}}class ae{constructor(){a(this,"timerElement");a(this,"intervalId",null);a(this,"streamStartTime",0);if(this.timerElement=document.getElementById("stream-duration-text"),!this.timerElement)throw new Error("StreamTimer: Duration element '#stream-duration-text' not found!");this.reset()}formatTime(e){const t=Math.floor(e/3600),s=Math.floor(e%3600/60),i=Math.floor(e%60),o=r=>String(r).padStart(2,"0");return t>0?`${t}:${o(s)}:${o(i)}`:`${s}:${o(i)}`}updateDisplay(){if(this.streamStartTime>0){const t=(Date.now()-this.streamStartTime)/1e3;this.timerElement.textContent=this.formatTime(Math.max(0,t))}}start(e=0){this.stop(),this.streamStartTime=Date.now()-e*1e3,this.updateDisplay(),this.intervalId=window.setInterval(()=>this.updateDisplay(),1e3),console.log(`Stream timer started with initial ${e.toFixed(2)}s.`)}stop(){this.intervalId!==null&&(clearInterval(this.intervalId),this.intervalId=null,console.log("Stream timer stopped."))}reset(){this.stop(),this.streamStartTime=0,this.timerElement.textContent="0:00",console.log("Stream timer reset.")}}class re{constructor(){a(this,"sidebarElement");a(this,"toggleButton");a(this,"showChatButton");a(this,"isCollapsed",!1);a(this,"bodyElement");if(this.sidebarElement=document.getElementById("chat-sidebar"),this.toggleButton=document.getElementById("toggle-chat-button"),this.showChatButton=document.getElementById("show-chat-button"),this.bodyElement=document.body,!this.sidebarElement||!this.toggleButton||!this.showChatButton)throw new Error("ChatSidebar: Required elements not found in DOM!");this.setupEventListeners(),this.setCollapsed(!1,!0),console.log("ChatSidebar initialized.")}setupEventListeners(){this.toggleButton.addEventListener("click",()=>this.toggleCollapse()),this.showChatButton.addEventListener("click",()=>this.toggleCollapse())}toggleCollapse(){this.setCollapsed(!this.isCollapsed)}setCollapsed(e,t=!1){this.isCollapsed=e,this.isCollapsed?this.bodyElement.classList.add("chat-collapsed"):this.bodyElement.classList.remove("chat-collapsed"),t?(this.sidebarElement.style.transition="none",this.toggleButton.style.transition="none",this.showChatButton.style.transition="none"):(this.sidebarElement.style.transition="width 0.3s ease-in-out, min-width 0.3s ease-in-out",this.toggleButton.style.transition="transform 0.3s ease-in-out, background-color 0.2s, color 0.2s",this.showChatButton.style.transition="opacity 0.3s ease-in-out, visibility 0.3s ease-in-out"),this.isCollapsed?(this.sidebarElement.classList.add("collapsed"),this.toggleButton.setAttribute("aria-label","展开聊天"),this.sidebarElement.querySelectorAll(":scope > *:not(.chat-sidebar-header)").forEach(s=>{s.style.opacity="0",s.style.pointerEvents="none"}),console.log("Chat sidebar collapsed.")):(this.sidebarElement.classList.remove("collapsed"),this.toggleButton.setAttribute("aria-label","重叠聊天"),this.sidebarElement.querySelectorAll(":scope > *:not(.chat-sidebar-header)").forEach(s=>{s.style.opacity="1",s.style.pointerEvents="auto"}),console.log("Chat sidebar expanded.")),t&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.sidebarElement.style.transition="",this.toggleButton.style.transition="",this.showChatButton.style.transition=""})})}getIsCollapsed(){return this.isCollapsed}}class le{constructor(){a(this,"indicatorElement");if(this.indicatorElement=document.querySelector(".live-indicator-rect"),!this.indicatorElement)throw new Error("LiveIndicator: Required .live-indicator-rect element not found in DOM!");this.hide()}show(){this.indicatorElement.classList.remove("hidden")}hide(){this.indicatorElement.classList.add("hidden")}}class ce{constructor(){a(this,"nicknameElement");a(this,"titleElement");a(this,"categoryElement");a(this,"tagsContainer");if(this.nicknameElement=document.getElementById("streamer-nickname"),this.titleElement=document.getElementById("stream-title-full"),this.categoryElement=document.querySelector(".stream-category"),this.tagsContainer=document.querySelector(".stream-tags"),!this.nicknameElement||!this.titleElement||!this.categoryElement||!this.tagsContainer)throw new Error("StreamInfoDisplay: One or more required elements not found in DOM!");console.log("StreamInfoDisplay initialized.")}update(e){this.nicknameElement.textContent=e.streamer_nickname,this.titleElement.textContent=e.stream_title,this.categoryElement.textContent=e.stream_category,this.tagsContainer.innerHTML="",e.stream_tags.forEach(t=>{const s=document.createElement("a");s.href="#",s.className="stream-tag",s.textContent=t,this.tagsContainer.appendChild(s)}),console.log("Stream info display updated with new metadata.")}}class de{constructor(){a(this,"wakeLockSentinel",null);a(this,"isSupported");this.isSupported="wakeLock"in navigator,this.isSupported?console.log("WakeLockManager initialized. API is supported."):console.warn("Wake Lock API is not supported in this browser. The device may go to sleep during playback.")}async requestWakeLock(){if(!(!this.isSupported||this.wakeLockSentinel))try{this.wakeLockSentinel=await navigator.wakeLock.request("screen"),this.wakeLockSentinel.addEventListener("release",()=>{console.log("Wake Lock was released by the browser."),this.wakeLockSentinel=null}),console.log("Wake Lock is active."),document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this))}catch(e){console.error(`Failed to acquire Wake Lock: ${e.name}, ${e.message}`),this.wakeLockSentinel=null}}async releaseWakeLock(){this.wakeLockSentinel&&(await this.wakeLockSentinel.release(),this.wakeLockSentinel=null,console.log("Wake Lock has been released.")),document.removeEventListener("visibilitychange",this.handleVisibilityChange.bind(this))}async handleVisibilityChange(){this.wakeLockSentinel===null&&document.visibilityState==="visible"&&(console.log("Page is visible again, re-acquiring Wake Lock..."),await this.requestWakeLock())}}const A=typeof window<"u"&&!!window.__TAURI__;function ue(n,e,t,s){if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)}function he(n,e,t,s,i){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}var B;function me(n,e=!1){return window.__TAURI_INTERNALS__.transformCallback(n,e)}async function u(n,e={},t){return window.__TAURI_INTERNALS__.invoke(n,e,t)}class ge{get rid(){return ue(this,B,"f")}constructor(e){B.set(this,void 0),he(this,B,e)}async close(){return u("plugin:resources|close",{rid:this.rid})}}B=new WeakMap;var F;(function(n){n.WINDOW_RESIZED="tauri://resize",n.WINDOW_MOVED="tauri://move",n.WINDOW_CLOSE_REQUESTED="tauri://close-requested",n.WINDOW_DESTROYED="tauri://destroyed",n.WINDOW_FOCUS="tauri://focus",n.WINDOW_BLUR="tauri://blur",n.WINDOW_SCALE_FACTOR_CHANGED="tauri://scale-change",n.WINDOW_THEME_CHANGED="tauri://theme-changed",n.WINDOW_CREATED="tauri://window-created",n.WEBVIEW_CREATED="tauri://webview-created",n.DRAG_ENTER="tauri://drag-enter",n.DRAG_OVER="tauri://drag-over",n.DRAG_DROP="tauri://drag-drop",n.DRAG_LEAVE="tauri://drag-leave"})(F||(F={}));async function pe(n,e){window.__TAURI_EVENT_PLUGIN_INTERNALS__.unregisterListener(n,e),await u("plugin:event|unlisten",{event:n,eventId:e})}async function $(n,e,t){var s;const i=(s=void 0)!==null&&s!==void 0?s:{kind:"Any"};return u("plugin:event|listen",{event:n,target:i,handler:me(e)}).then(o=>async()=>pe(n,o))}async function ye(n,e){return await P.load(n,e)}class fe{get store(){return this._store||(this._store=ye(this.path,this.options)),this._store}constructor(e,t){this.path=e,this.options=t}async init(){await this.store}async set(e,t){return(await this.store).set(e,t)}async get(e){return(await this.store).get(e)}async has(e){return(await this.store).has(e)}async delete(e){return(await this.store).delete(e)}async clear(){await(await this.store).clear()}async reset(){await(await this.store).reset()}async keys(){return(await this.store).keys()}async values(){return(await this.store).values()}async entries(){return(await this.store).entries()}async length(){return(await this.store).length()}async reload(e){await(await this.store).reload(e)}async save(){await(await this.store).save()}async onKeyChange(e,t){return(await this.store).onKeyChange(e,t)}async onChange(e){return(await this.store).onChange(e)}async close(){this._store&&await(await this._store).close()}}class P extends ge{constructor(e){super(e)}static async load(e,t){const s=await u("plugin:store|load",{path:e,options:t});return new P(s)}static async get(e){return await u("plugin:store|get_store",{path:e}).then(t=>t?new P(t):null)}async set(e,t){await u("plugin:store|set",{rid:this.rid,key:e,value:t})}async get(e){const[t,s]=await u("plugin:store|get",{rid:this.rid,key:e});return s?t:void 0}async has(e){return await u("plugin:store|has",{rid:this.rid,key:e})}async delete(e){return await u("plugin:store|delete",{rid:this.rid,key:e})}async clear(){await u("plugin:store|clear",{rid:this.rid})}async reset(){await u("plugin:store|reset",{rid:this.rid})}async keys(){return await u("plugin:store|keys",{rid:this.rid})}async values(){return await u("plugin:store|values",{rid:this.rid})}async entries(){return await u("plugin:store|entries",{rid:this.rid})}async length(){return await u("plugin:store|length",{rid:this.rid})}async reload(e){await u("plugin:store|reload",{rid:this.rid,...e})}async save(){await u("plugin:store|save",{rid:this.rid})}async onKeyChange(e,t){return await $("store://change",s=>{s.payload.resourceId===this.rid&&s.payload.key===e&&t(s.payload.exists?s.payload.value:void 0)})}async onChange(e){return await $("store://change",t=>{t.payload.resourceId===this.rid&&e(t.payload.key,t.payload.exists?t.payload.value:void 0)})}}let _=null;function H(){return _||(console.log("Creating new LazyStore instance NOW."),_=new fe("settings.json"),console.log("LazyStore instance created:",_)),_}async function V(n){try{if(A){const e=H();await e.set("neuro_settings",n),await e.save(),console.log("Settings saved to Tauri Store.")}else localStorage.setItem("neuro_settings",JSON.stringify(n)),console.log("Settings saved to localStorage.")}catch(e){console.error("Failed to save settings:",e)}}async function x(){try{if(A){const n=H();console.log("Attempting to load settings from Tauri Store.");const e=await n.get("neuro_settings");return e!=null?e:null}else{console.log("Attempting to load settings from localStorage.");const n=localStorage.getItem("neuro_settings");return n?JSON.parse(n):null}}catch(n){return console.error("Failed to retrieve settings:",n),null}}class we{constructor(e){a(this,"modalContainer");a(this,"overlay");a(this,"closeButton");a(this,"saveButton");a(this,"usernameInput");a(this,"backendUrlInput");a(this,"avatarPreview");a(this,"avatarUploadInput");a(this,"avatarUploadButton");a(this,"reconnectAttemptsInput");a(this,"onSave");if(this.onSave=e,this.modalContainer=document.getElementById("settings-modal"),this.overlay=document.getElementById("settings-modal-overlay"),this.closeButton=document.getElementById("settings-close-button"),this.saveButton=document.getElementById("settings-save-button"),this.usernameInput=document.getElementById("username-setting-input"),this.backendUrlInput=document.getElementById("backend-url-input"),this.avatarPreview=document.getElementById("avatar-setting-preview"),this.avatarUploadInput=document.getElementById("avatar-setting-upload"),this.avatarUploadButton=document.getElementById("avatar-upload-button"),this.reconnectAttemptsInput=document.getElementById("reconnect-attempts-input"),!this.modalContainer)throw new Error("Settings modal container not found!");this.setupEventListeners(),console.log("SettingsModal initialized.")}setupEventListeners(){this.closeButton.addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",()=>this.close()),this.saveButton.addEventListener("click",()=>this.handleSave()),this.avatarUploadButton.addEventListener("click",()=>this.avatarUploadInput.click()),this.avatarUploadInput.addEventListener("change",e=>this.handleAvatarUpload(e))}handleAvatarUpload(e){const t=e.target;if(t.files&&t.files[0]){const s=new FileReader;s.onload=i=>{var o;(o=i.target)!=null&&o.result&&(this.avatarPreview.src=i.target.result)},s.readAsDataURL(t.files[0])}}async handleSave(){const e={username:this.usernameInput.value.trim()||"User",avatarDataUrl:this.avatarPreview.src,backendUrl:this.backendUrlInput.value.trim(),reconnectAttempts:parseInt(this.reconnectAttemptsInput.value,10)||-1};await V(e),this.onSave(e),this.close()}async open(){await this.loadSettings(),this.modalContainer.classList.remove("hidden")}close(){this.modalContainer.classList.add("hidden")}async loadSettings(){const t=await x()||this.getDefaultSettings();this.usernameInput.value=t.username,this.avatarPreview.src=t.avatarDataUrl,this.backendUrlInput.value=t.backendUrl,this.reconnectAttemptsInput.value=String(t.reconnectAttempts)}getDefaultSettings(){return{username:"One_of_Swarm",avatarDataUrl:"/user_avatar.jpg",backendUrl:"http://localhost:8000",reconnectAttempts:-1}}}class ve{constructor(){a(this,"button",null);a(this,"isMuted",!0)}create(){return this.button=document.getElementById("mute-button"),this.button?this.button.addEventListener("click",e=>{e.stopPropagation(),this.unmute()}):console.error("Mute button element not found in DOM!"),this.button}show(){this.button&&(this.button.style.display="flex")}hide(){this.button&&(this.button.style.display="none")}unmute(){this.isMuted=!1,this.hide(),this.updateMediaElements()}updateMediaElements(){const e=document.getElementById("startup-video");e&&(e.muted=this.isMuted);try{f.getAppInitializer().getAudioPlayer().updateMuteState()}catch(t){console.warn("Could not update audio player mute state:",t)}}getElement(){return this.button}getIsMuted(){return this.isMuted}}const Se="3546729368520811",be="4281748";async function Ee(){var n,e;try{if(A)return console.log("Running in Tauri, invoking 'get_latest_replay_video' command..."),await u("get_latest_replay_video");{console.log("Running in Web, fetching from proxy...");const t=`/bilibili-api/x/series/archives?mid=${Se}&series_id=${be}&ps=1&pn=1`,s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch from proxy: ${s.statusText}`);const i=await s.json();if(i.code!==0)throw new Error(`Bilibili API error: ${i.message}`);const o=(e=(n=i==null?void 0:i.data)==null?void 0:n.archives)==null?void 0:e[0];if(o&&o.bvid&&o.aid)return o;throw new Error("No matching video found in API response.")}}catch(t){return console.error("Failed to get latest replay video:",t),null}}function Ce(n){const e="//www.bilibili.com/blackboard/html5mobileplayer.html",t=new URLSearchParams({bvid:n.bvid,aid:String(n.aid),p:"1",autoplay:"1",danmaku:"0",hasMuteButton:"1",hideCoverInfo:"0",fjw:"0",high_quality:"1"});return`${e}?${t.toString()}`}class ke{constructor(){a(this,"wsClient");a(this,"audioPlayer");a(this,"videoPlayer");a(this,"neuroAvatar");a(this,"chatDisplay");a(this,"userInput");a(this,"layoutManager");a(this,"streamTimer");a(this,"chatSidebar");a(this,"liveIndicator");a(this,"streamInfoDisplay");a(this,"wakeLockManager");a(this,"settingsModal");a(this,"currentSettings");a(this,"muteButton");a(this,"resizeObserver",null);a(this,"offlinePlayerSrc",null);a(this,"logoContainer",null);a(this,"isStarted",!1);a(this,"currentPhase","offline");a(this,"isConnectionLost",!1);a(this,"adjustOfflineLayout",()=>{if(this.currentPhase!=="offline")return;const e=document.getElementById("offline-content-container"),t=document.querySelector(".offline-video-player"),s=document.querySelector(".offline-info-card");if(!e||!t||!s)return;if(window.innerWidth<=767)e.style.flexWrap="wrap",s.style.width=t.offsetWidth+"px",s.style.height="auto",s.style.flex="0 0 auto";else{e.style.flexWrap="nowrap";const o=t.offsetHeight;o>0&&(s.style.height=`${o}px`,s.style.width=`${o}px`),s.style.flex="0 1 auto"}});this.layoutManager=new oe,this.streamTimer=new ae,this.muteButton=new ve,this.settingsModal=new we(t=>this.handleSettingsUpdate(t)),this.currentSettings=this.settingsModal.getDefaultSettings(),this.wsClient=null,this.audioPlayer=new te,this.videoPlayer=new se,this.neuroAvatar=new ne,this.chatDisplay=new Z,this.userInput=new ie,this.userInput.onSendMessage(t=>this.sendUserMessage(t)),this.chatSidebar=new re,this.liveIndicator=new le,this.streamInfoDisplay=new ce,this.wakeLockManager=new de,this.setupSettingsModalTrigger(),this.setupMuteButton();const e=document.querySelector(".offline-video-player");e&&(this.offlinePlayerSrc=e.src),this.updateOfflinePlayerSrc(),this.logoContainer=document.querySelector(".twitch-logo-container")}async init(){const e=await x();e&&(this.currentSettings=e),await this.probeForIntegratedServer()}start(){this.isStarted||(this.isStarted=!0,this.layoutManager.start(),this.updateLogoState("disconnected"),this.goOffline(),this.updateUiWithSettings())}setupSettingsModalTrigger(){const e=document.querySelector(".nav-user-avatar-button");e&&e.addEventListener("click",async()=>{await this.settingsModal.open()})}setupMuteButton(){if(this.muteButton.create()){this.muteButton.show();const t=()=>{this.muteButton.unmute(),document.removeEventListener("click",t)};document.addEventListener("click",t)}}getMuteButton(){return this.muteButton}getAudioPlayer(){return this.audioPlayer}getNeuroAvatar(){return this.neuroAvatar}updateLogoState(e){if(this.logoContainer)switch(this.logoContainer.classList.remove("logo-disconnected","logo-connected","logo-live"),e){case"disconnected":this.logoContainer.classList.add("logo-disconnected");break;case"connected":this.logoContainer.classList.add("logo-connected");break;case"live":this.logoContainer.classList.add("logo-live");break}}handleSettingsUpdate(e){if(console.log("Settings updated. Re-initializing connection with new settings:",e),this.currentSettings=e,this.updateUiWithSettings(),this.wsClient){const t=e.backendUrl?`${e.backendUrl}/ws/stream`:"";this.wsClient.updateOptions({url:t,maxReconnectAttempts:e.reconnectAttempts}),this.wsClient.disconnect(),setTimeout(()=>{this.wsClient&&this.wsClient.getUrl()?this.wsClient.connect():console.warn("Cannot connect: Backend URL is empty after update or WebSocket client not ready.")},500)}else console.warn("WebSocket client not initialized, cannot update settings.")}initWebSocketClient(e){const t=e?`${e}/ws/stream`:"",s=r=>this.handleWebSocketMessage(r),i=()=>{this.isConnectionLost=!1,this.updateLogoState("connected"),this.goOnline()},o=()=>{this.isConnectionLost||(this.isConnectionLost=!0,this.updateLogoState("disconnected"),this.goOffline())};this.wsClient?(this.wsClient.updateOptions({url:t,autoReconnect:!0,maxReconnectAttempts:this.currentSettings.reconnectAttempts,onMessage:s,onOpen:i,onDisconnect:o}),t&&(this.wsClient.disconnect(),setTimeout(()=>{this.wsClient.connect()},500))):this.wsClient=new X({url:t,autoReconnect:!0,maxReconnectAttempts:this.currentSettings.reconnectAttempts,onMessage:s,onOpen:i,onDisconnect:o})}async probeForIntegratedServer(){const t=await x()||this.settingsModal.getDefaultSettings();console.log("Probing for integrated server. Stored settings:",t);try{const s=new URL("/api/system/health",window.location.origin).toString();console.log("Probing integrated server at:",s);const i=await fetch(s),o=i.headers.get("content-type");if(i.ok&&o&&o.includes("application/json")){console.log("Integrated server detected via health check. Auto-connecting...");const r=window.location.origin;this.currentSettings={...t,backendUrl:r},await V(this.currentSettings),this.initWebSocketClient(r),this.wsClient&&r&&this.wsClient.connect();return}else console.log("Health check failed, not an integrated server. Status:",i.status)}catch(s){console.log("Failed to probe for integrated server, assuming standalone mode.",s)}console.log("Falling back to stored backend URL:",t.backendUrl),this.currentSettings=t,this.initWebSocketClient(t.backendUrl),this.wsClient&&t.backendUrl?this.wsClient.connect():t.backendUrl||(console.warn("Backend URL is not configured via probe or stored settings. Opening settings modal."),this.settingsModal.open())}updateUiWithSettings(){document.querySelectorAll(".user-avatar-img").forEach(t=>t.src=this.currentSettings.avatarDataUrl),console.log(`UI updated with username: ${this.currentSettings.username} and avatar.`)}async updateOfflinePlayerSrc(){console.log("Attempting to fetch the latest replay video...");const e=await Ee();if(e){const t=Ce(e);if(this.offlinePlayerSrc=t,console.log("Successfully updated offline player src to:",t),this.currentPhase==="offline"){const s=document.querySelector(".offline-video-player");s&&(s.src=this.offlinePlayerSrc)}}else console.log("Failed to fetch latest replay video, using default fallback.")}goOnline(){var s,i,o,r;console.log("Entering ONLINE state."),this.updateUiWithSettings(),A&&document.body.classList.add("stream-live-view");const e=document.querySelector(".offline-video-player");e&&(e.src="about:blank"),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),window.removeEventListener("resize",this.adjustOfflineLayout);const t=document.querySelector(".offline-info-card");t&&(t.style.height="",t.style.width=""),(s=document.getElementById("offline-content-container"))==null||s.classList.add("hidden"),(i=document.getElementById("stream-display-viewport"))==null||i.classList.remove("hidden"),(o=document.querySelector(".stream-info-details-row"))==null||o.classList.remove("hidden"),(r=document.getElementById("chat-sidebar"))==null||r.classList.remove("hidden"),this.showStreamContent(),this.chatDisplay.clearChat(),this.liveIndicator.show(),this.wakeLockManager.requestWakeLock()}goOffline(){var s,i,o,r;console.log("Entering OFFLINE state."),this.currentPhase="offline",A&&document.body.classList.remove("stream-live-view");const e=document.querySelector(".offline-video-player");e&&this.offlinePlayerSrc&&(e.src=this.offlinePlayerSrc),(s=document.getElementById("offline-content-container"))==null||s.classList.remove("hidden"),(i=document.getElementById("stream-display-viewport"))==null||i.classList.add("hidden"),(o=document.querySelector(".stream-info-details-row"))==null||o.classList.add("hidden"),(r=document.getElementById("chat-sidebar"))==null||r.classList.add("hidden"),this.hideStreamContent(),this.audioPlayer.stopAllAudio(),this.videoPlayer.hide(),this.neuroAvatar.setStage("hidden",!0),M(),this.streamTimer.stop(),this.streamTimer.reset(),this.chatDisplay.clearChat(),this.liveIndicator.hide(),this.wakeLockManager.releaseWakeLock(),this.muteButton.show();const t=()=>{this.muteButton.unmute(),document.removeEventListener("click",t)};document.addEventListener("click",t),setTimeout(()=>{this.adjustOfflineLayout();const h=document.querySelector(".offline-video-player");h&&!this.resizeObserver&&(this.resizeObserver=new ResizeObserver(this.adjustOfflineLayout),this.resizeObserver.observe(h),window.addEventListener("resize",this.adjustOfflineLayout))},0)}handleWebSocketMessage(e){switch(this.currentPhase==="offline"&&["play_welcome_video","start_avatar_intro","enter_live_phase"].includes(e.type)&&(console.log("Connection successful, transitioning from OFFLINE to active state."),this.goOnline()),e.elapsed_time_sec!==void 0&&this.streamTimer.start(e.elapsed_time_sec),e.type){case"offline":this.goOffline();break;case"model_spin":this.neuroAvatar.triggerSpin();break;case"model_zoom":this.neuroAvatar.triggerZoom();break;case"update_stream_metadata":this.streamInfoDisplay.update(e);break;case"play_welcome_video":const t=parseFloat(e.progress);this.currentPhase!=="offline"?this.videoPlayer.seekTo(t):(this.currentPhase="initializing",this.videoPlayer.showAndPlayVideo(t));break;case"start_avatar_intro":this.currentPhase="avatar_intro",this.videoPlayer.pauseAndMute(),this.neuroAvatar.startIntroAnimation(()=>{this.videoPlayer.hide()});break;case"enter_live_phase":this.updateLogoState("live"),this.currentPhase="live",this.videoPlayer.hide(),this.neuroAvatar.setStage("step2");break;case"neuro_is_speaking":break;case"neuro_speech_segment":const s=e;s.is_end?this.audioPlayer.setAllSegmentsReceived():s.audio_base64&&s.text&&typeof s.duration=="number"?this.audioPlayer.addAudioSegment(s.text,s.audio_base64,s.duration):console.warn("Received neuro_speech_segment message with missing audio/text/duration:",s);break;case"neuro_error_signal":console.warn("Received neuro_error_signal from backend."),q("Someone tell Vedal there is a problem with my AI."),this.audioPlayer.playErrorSound();break;case"chat_message":(!this.chatSidebar.getIsCollapsed()||e.is_user_message)&&this.chatDisplay.appendChatMessage(e);break;case"error":this.chatDisplay.appendChatMessage({type:"chat_message",username:"System",text:`后端错误: ${e.message}`,is_user_message:!1});break}}sendUserMessage(e){const t={username:this.currentSettings.username,...e};this.wsClient?this.wsClient.send(t):console.warn("Cannot send message: WebSocket client is not initialized.")}showStreamContent(){const e=document.getElementById("stream-display-area");e&&(e.style.visibility="visible",e.style.opacity="1")}hideStreamContent(){const e=document.getElementById("stream-display-area");e&&(e.style.visibility="hidden",e.style.opacity="0")}}const b=class b{constructor(){a(this,"appInitializerInstance",null)}static getInstance(){return b.instance||(b.instance=new b),b.instance}getAppInitializer(){return this.appInitializerInstance?console.log("Returning existing AppInitializer instance."):(console.log("Creating new AppInitializer instance..."),this.appInitializerInstance=new ke),this.appInitializerInstance}};a(b,"instance");let N=b;const f=N.getInstance();async function Ie(){console.log("Main function started.");const n=f.getAppInitializer();await n.init(),n.start(),console.log("App initialized and started.")}Ie().catch(console.error);console.log("main.ts loaded. Running main function.");
