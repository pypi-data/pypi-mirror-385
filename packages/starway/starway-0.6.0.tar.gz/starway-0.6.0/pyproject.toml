[project]
name = "starway"
version = "0.6.0"
description = "Starway UCX P2P communication lib."
readme = "README.md"
authors = [
  { name = "Clouder0", email = "clouder0@outlook.com" },
]
requires-python = ">=3.10"
dependencies = [
  "numpy>=2.0.0",
]

# [build-system]
# requires = ["hatchling"]
# build-backend = "hatchling.build"

# [tool.hatch.build.targets.wheel]
# packages = ["src/starway"]

# [tool.hatch.build.hooks.custom]
# path = "hatch_build.py"

[build-system]
requires = ["scikit-build-core", "nanobind"]
build-backend = "scikit_build_core.build"

[tool.scikit-build]
cmake.version = ">=3.27"
cmake.build-type = "Release"
# cmake.build-type = "Debug"
sdist.reproducible = true
sdist.cmake = false
wheel.packages = ["src/starway"]
build-dir = "build/{wheel_tag}"
editable.mode = "redirect"
editable.verbose = true
editable.rebuild = false

[dependency-groups]
dev = [
  "nanobind>=2.9.2",
]
test = [
  "pytest>=8.4.2",
  "pytest-asyncio>=1.1.0",
  "uvloop>=0.21.0",
]

[tool.ruff.lint]
select = ["E4", "E7", "E9", "F", "I"]
ignore = []

[tool.cibuildwheel]
repair-wheel-command = "auditwheel repair -w {dest_dir} {wheel} --exclude libucp.so.0 --exclude libuct.so.0 --exclude libucs.so.0 --exclude libucm.so.0 " # disable repair wheel
build = [
  "cp310-manylinux_x86_64",
  "cp311-manylinux_x86_64",
  "cp312-manylinux_x86_64",
  "cp313-manylinux_x86_64",
]
build-frontend = "build[uv]"
manylinux-x86_64-image = "manylinux_2_34"
before-all = [
  "yum install -y wget ninja-build cmake libnl3-devel libudev-devel",
  "cd / && curl -L https://github.com/linux-rdma/rdma-core/releases/download/v59.0/rdma-core-59.0.tar.gz -o rdma-core-59.0.tar.gz && tar xf rdma-core-59.0.tar.gz && cd rdma-core-59.0 && cmake -Bbuild -GNinja -DIN_PLACE=0 -DCMAKE_EXPORT_COMPILE_COMMANDS=0  -DCMAKE_BUILD_TYPE=Release  -DENABLE_VALGRIND=0  -DENABLE_STATIC=1  -DNO_MAN_PAGES=1 && cmake --build build -j && cmake --install build",
  "cd / && curl -L https://github.com/openucx/ucx/releases/download/v1.18.1/ucx-1.18.1.tar.gz -o ucx.tar.gz && tar xf ucx.tar.gz",
  "cd /ucx-1.18.1 && ./contrib/configure-release --disable-doxygen-doc --disable-doxygen-man --disable-doxygen-html --enable-optimizations --enable-tuning  --enable-devel-headers  --with-avx --with-mlx5 --with-rc --with-ud --with-dc --with-ib-hw-tm --with-dm --with-rdmacm=/usr/local && make -j && make install",
]
