stages:
  - rust-build
  - python-build

.build_deps: &build_deps
  before_script:
    - apt-get update
    - apt-get -y install apt-transport-https ca-certificates wget git curl
    - curl -L micro.mamba.pm/install.sh | bash
    - ~/.local/bin/micromamba shell init -s bash
    - source ~/.bashrc
    - micromamba create -y -n dtt_rust python=3.9
    - micromamba activate dtt_rust
    - micromamba install nds2-client libcds gds-sigp rust fftw glib libclang maturin pytest c-compiler cxx-compiler gcc clang zstd make rapidjson ruff
    - which cargo
    - export LIBCLANG_PATH=$CONDA_PREFIX/lib
    - export C_INCLUDE_PATH=$CONDA_PREFIX/include
    - export CPLUS_INCLUDE_PATH=$CONDA_PREFIX/include


.image: &image
  image: rust:1-bookworm

rust-test-no-features:
  <<: *image
  stage: rust-build
  <<: *build_deps
  script:    
    - cargo test --verbose
    - cargo test --verbose --features nds
    - cargo test --verbose --features python-pipe
    - cargo test --verbose --features python
    - cargo test --verbose --features all
    - cargo build -p scope_view_test
    - cargo build -p nds_test

build-and-test-python:
  <<: *image
  stage: python-build
  <<: *build_deps
  script:
    - source ~/.bashrc
    - micromamba activate dtt_rust    
    - ls -l
    - bash gen_stub
    - maturin develop --features all
    - pytest